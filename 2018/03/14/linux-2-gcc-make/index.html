<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="msvalidate.01" content="F14AAB2D4C842CB9F200D0A80DA8CB2F">
  <meta name="baidu-site-verification" content="GNlbaIvRtqlfiBfg">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.casezheng.date","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="GCC简介GCC是Linux下的编译工具集，是GNU Compiler Collection的缩写，包括gcc、g++等编译器和其它工具集。GCC的C编译器为gcc，命令格式为：1gcc [options] files ... 文件扩展名含义     文件扩展名 含义     .c C语言的源文件   .h C/C++语言的头文件   .hpp C++语言的头文件   .i 预处理后的C文件">
<meta name="keywords" content="cpp,linux,gcc">
<meta property="og:type" content="article">
<meta property="og:title" content="linux编译链接">
<meta property="og:url" content="http://www.casezheng.date/2018/03/14/linux-2-gcc-make/index.html">
<meta property="og:site_name" content="CaseZheng">
<meta property="og:description" content="GCC简介GCC是Linux下的编译工具集，是GNU Compiler Collection的缩写，包括gcc、g++等编译器和其它工具集。GCC的C编译器为gcc，命令格式为：1gcc [options] files ... 文件扩展名含义     文件扩展名 含义     .c C语言的源文件   .h C/C++语言的头文件   .hpp C++语言的头文件   .i 预处理后的C文件">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-03-14T05:31:43.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="linux编译链接">
<meta name="twitter:description" content="GCC简介GCC是Linux下的编译工具集，是GNU Compiler Collection的缩写，包括gcc、g++等编译器和其它工具集。GCC的C编译器为gcc，命令格式为：1gcc [options] files ... 文件扩展名含义     文件扩展名 含义     .c C语言的源文件   .h C/C++语言的头文件   .hpp C++语言的头文件   .i 预处理后的C文件">

<link rel="canonical" href="http://www.casezheng.date/2018/03/14/linux-2-gcc-make/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>linux编译链接 | CaseZheng</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4f1686055a927fa7bf1a09bc1143b57c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">CaseZheng</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">CaseZheng Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.casezheng.date/2018/03/14/linux-2-gcc-make/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CaseZheng">
      <meta itemprop="description" content="CaseZheng的博客网站">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CaseZheng">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          linux编译链接
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-03-14 13:31:43" itemprop="dateCreated datePublished" datetime="2018-03-14T13:31:43+08:00">2018-03-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="GCC简介"><a href="#GCC简介" class="headerlink" title="GCC简介"></a>GCC简介</h1><p>GCC是Linux下的编译工具集，是GNU Compiler Collection的缩写，包括gcc、g++等编译器和其它工具集。<br>GCC的C编译器为gcc，命令格式为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc [options] files ...</span><br></pre></td></tr></table></figure></p>
<p>文件扩展名含义</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">文件扩展名</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">.c</td>
<td style="text-align:center">C语言的源文件</td>
</tr>
<tr>
<td style="text-align:center">.h</td>
<td style="text-align:center">C/C++语言的头文件</td>
</tr>
<tr>
<td style="text-align:center">.hpp</td>
<td style="text-align:center">C++语言的头文件</td>
</tr>
<tr>
<td style="text-align:center">.i</td>
<td style="text-align:center">预处理后的C文件</td>
</tr>
<tr>
<td style="text-align:center">.C .cc .cxx</td>
<td style="text-align:center">C++语言的源文件</td>
</tr>
<tr>
<td style="text-align:center">.s</td>
<td style="text-align:center">汇编语言的源文件</td>
</tr>
<tr>
<td style="text-align:center">.o</td>
<td style="text-align:center">会变后的目标文件</td>
</tr>
<tr>
<td style="text-align:center">.a</td>
<td style="text-align:center">静态库</td>
</tr>
<tr>
<td style="text-align:center">.so</td>
<td style="text-align:center">动态库</td>
</tr>
</tbody>
</table>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">GCC编译命令</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">cpp</td>
<td style="text-align:center">预处理器编译器</td>
</tr>
<tr>
<td style="text-align:center">cc</td>
<td style="text-align:center">C语言编译器</td>
</tr>
<tr>
<td style="text-align:center">gcc</td>
<td style="text-align:center">C语言编译器</td>
</tr>
<tr>
<td style="text-align:center">cc1</td>
<td style="text-align:center">C语言编译器</td>
</tr>
<tr>
<td style="text-align:center">cc1plus</td>
<td style="text-align:center">C++语言编译器</td>
</tr>
<tr>
<td style="text-align:center">g++</td>
<td style="text-align:center">C++语言编译器</td>
</tr>
<tr>
<td style="text-align:center">as</td>
<td style="text-align:center">汇编器</td>
</tr>
<tr>
<td style="text-align:center">ld</td>
<td style="text-align:center">链接器</td>
</tr>
</tbody>
</table>
</div>
<p>默认搜索路径</p>
<ol>
<li>头文件 /usr/local/include  /usr/lib/gcc/  /usr/include</li>
<li>库文件 /usr/lib/gcc /lib/</li>
</ol>
<h1 id="编译程序基础"><a href="#编译程序基础" class="headerlink" title="编译程序基础"></a>编译程序基础</h1><p>GCC编译器对程序的编译分为<strong>4个阶段：预处理、编译和优化、汇编、链接</strong>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">          预处理(cpp)        编译和优化(gcc/cc)            汇编(as)              链接(ld)</span><br><span class="line">*.c *.h ------------&gt; *.i -------------------------&gt; *.s -------------&gt; *.o -----------------&gt;  可执行文件</span><br></pre></td></tr></table></figure></p>
<h2 id="gcc选项"><a href="#gcc选项" class="headerlink" title="gcc选项"></a>gcc选项</h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">选项</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">-o</td>
<td style="text-align:center">指定生成文件名</td>
</tr>
<tr>
<td style="text-align:center">-c</td>
<td style="text-align:center">生成目标文件</td>
</tr>
<tr>
<td style="text-align:center">-E</td>
<td style="text-align:center">预编译操作</td>
</tr>
<tr>
<td style="text-align:center">-S</td>
<td style="text-align:center">生成汇编代码</td>
</tr>
<tr>
<td style="text-align:center">-g</td>
<td style="text-align:center">加上调试信息</td>
</tr>
</tbody>
</table>
</div>
<h2 id="预编译"><a href="#预编译" class="headerlink" title="预编译"></a>预编译</h2><p>主要处理源代码文件中以”#”开始的预编译指令。生成.i文件。编译后的.i文件不包含任何宏定义。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ls</span><br><span class="line">main.c</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ gcc -E -o main.i main.c </span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ls</span><br><span class="line">main.c  main.i</span><br></pre></td></tr></table></figure></p>
<h2 id="编译和优化"><a href="#编译和优化" class="headerlink" title="编译和优化"></a>编译和优化</h2><p>词法分析、语法分析、语义分析、优化、生成汇编代码文件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ls</span><br><span class="line">main.c</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ gcc -S main.c </span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ls</span><br><span class="line">main.c  main.s</span><br></pre></td></tr></table></figure></p>
<h3 id="词法分析"><a href="#词法分析" class="headerlink" title="词法分析"></a>词法分析</h3><p>词法分析使用类似于有限状态机的算法，将源代码的字符序列分割成一系列的记号。<br>词法分析产生的记号一般可以分为：关键词、标识符、字面量、特殊符号等。<br>程序lex可以实现词法扫描，按用户定义的词法规则将字符串分割为一个个记号。</p>
<h3 id="语法分析"><a href="#语法分析" class="headerlink" title="语法分析"></a>语法分析</h3><p>语法分析将词法分析产生的记号进行语法分析，产生语法树。<br>程序yacc可以完成语法分析。</p>
<h3 id="语义分析"><a href="#语义分析" class="headerlink" title="语义分析"></a>语义分析</h3><p>语义分析是对表达式的含义进行分析，编译器所能分析的时静态语义（编译期可以确定的语义），动态语义是只在运行期才能确定的语义。<br>静态语义通常包括声明和类型的匹配，类型的转换。</p>
<h3 id="源码级优化及中间代码生成"><a href="#源码级优化及中间代码生成" class="headerlink" title="源码级优化及中间代码生成"></a>源码级优化及中间代码生成</h3><p>源代码级优化器会在源代码级别进行优化。优化器将整个语法树转换成中间代码（三地址码、P-代码）</p>
<h3 id="生成汇编代码及优化"><a href="#生成汇编代码及优化" class="headerlink" title="生成汇编代码及优化"></a>生成汇编代码及优化</h3><p>源代码级优化器产生中间代码后的过程属于编译器后端。编译器后端主要包括代码生成器和目标代码优化器。<br>代码生成器将中间代码转换成目标机器代码（汇编代码）。目标代码优化器对汇编代码进行优化。</p>
<p>预编译和编译可以合并成一个步骤，对C语言预编译和编译的程序是cc1，对C++是cc1plus。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@VM_187_252_centos /]$ locate cc1</span><br><span class="line">/usr/libexec/gcc/x86_64-redhat-linux/4.8.2/cc1</span><br><span class="line">/usr/libexec/gcc/x86_64-redhat-linux/4.8.2/cc1plus</span><br></pre></td></tr></table></figure></p>
<h2 id="汇编"><a href="#汇编" class="headerlink" title="汇编"></a>汇编</h2><p>将汇编代码转变成机器可执行的指令，每一个汇编语句几乎对应一条机器指令。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ls</span><br><span class="line">main.c</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ gcc -c main.c </span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ls</span><br><span class="line">main.c  main.o</span><br></pre></td></tr></table></figure>
<h1 id="目标文件"><a href="#目标文件" class="headerlink" title="目标文件"></a>目标文件</h1><p>编译器编译源代码后的生成的文件叫做目标文件。目标文件从结构上讲，是已经编译后的可执行文件格式，只是还没经过链接的过程。</p>
<h2 id="目标文件格式"><a href="#目标文件格式" class="headerlink" title="目标文件格式"></a>目标文件格式</h2><p>PC平台流行的可执行文件格式主要是Windows下的PE和Linux下的ELF，都是COFF格式的变种。<br>目标文件、可执行文件、动态链接库、静态链接库都是按照可执行文件格式存储。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ file hello.o</span><br><span class="line">hello.o: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), not stripped</span><br><span class="line"></span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ gcc -o run main.c hello.c</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ls</span><br><span class="line">hello.c  hello.o  main.c  run</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ file run</span><br><span class="line">run: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.32, BuildID[sha1]=92d675d4aed8cea8d1aeee31f3d4e901f8c57022, not stripped</span><br><span class="line"></span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ file /lib/libc-2.17.so </span><br><span class="line">/lib/libc-2.17.so: ELF 32-bit LSB shared object, Intel 80386, version 1 (GNU/Linux), dynamically linked (uses shared libs), BuildID[sha1]=efcb4322c3353d41309c104563110b0c238bbc51, for GNU/Linux 2.6.32, not stripped</span><br></pre></td></tr></table></figure></p>
<h2 id="目标文件内容"><a href="#目标文件内容" class="headerlink" title="目标文件内容"></a>目标文件内容</h2><p>目标文件将指令代码、数据、链接所需信息以”节”(“段”)的形式存储。<br><strong>ELF文件开头是文件头，描述了整个文件的文件属性</strong>，包括文件是否可执行、是静态链接还是动态链接等信息，文件头还包括一个<strong>段表</strong>，段表时一个描述文件中各个段的数据。<strong>段表描述了文件中的偏移位置及段的属性等，从段表中可以得到段的所有信息</strong>。文件头后面就是各个段的内容。<br>程序源代码编译后的机器指令经常放在代码段(.code/.text)<br><strong>已初始化的全局变量和局部静态变量放在.data段</strong>。<br><strong>未初始化的全局变量和局部静态变量放在.bss段</strong>。因为未初始化的全局变量和局部静态变量默认值都是0，在.data段分配空间存储0是没有必要的。<strong>.bss段只是为未初始化的全局变量和局部静态变量预留位置而已</strong>，并没有内容，在文件中不占据空间。<br>.rodata段存放只读数据，一般是程序里面的只读变量和字符串常量。<br>.comment段存放编译器版本信息<br>.debug段调试信息<br>.hash段符号哈希表<br>.line段调试时的行号表，即源代码行号与编译后指令的对应表<br>.strtab段字符串表，存储ELF文件用到的各种字符串<br>.symtab段符号表<br>.shstrtab段段名表<br>.plt .got动态链接的跳转表和全局入口表<br>.init .fini程序初始化与终结代码段<br>总体来说，<strong>程序源代码被编译后主要分两种段：程序指令和程序数据。代码段属于程序指令，而数据段和.bss段属于程序数据</strong>。<br>程序指令和程序数据分开存储的好处：</p>
<ol>
<li>安全，程序加载后程序指令只读、程序数据读写</li>
<li>利于缓存，提高CPU的缓存命中率</li>
<li>共享指令，节省内存</li>
</ol>
<h2 id="目标文件结构"><a href="#目标文件结构" class="headerlink" title="目标文件结构"></a>目标文件结构</h2><ol>
<li>文件头定义了ELF魔数、文件机器字节长度、数据存储方式、版本、运行平台、ABI版本、ELF重定位类型、硬件平台、硬件平台版本、入口地址、程序头入口和长度、段表的位置和长度及段的数量等。</li>
<li>段表是保存各个段的基本属性的结构，描述各个段的信息。ELF文件的段结构由段表决定、编译器、连接器和装载器都是依靠段表来定位和访问各个段的属性的。</li>
<li>重定位表(.rel.text/.rel.data)链接器在处理目标文件时需要对某些部位进行重定位，这些重定位信息都记录在ELF文件的重定位表中。</li>
<li>字符串表.strtab保存普通字符串。</li>
<li>段名字符串表.shstrtab保存短表中用到的字符串。</li>
<li>符号表.symtab记录了目标文件中所用到的所有符号。每个定义的符号有一个对应的值，叫做符号值。对变量和函数，符号值就是它们的地址。</li>
<li>特殊符号<ul>
<li>__executable_start 程序起始地址，不是入口地址，是程序最开始的地址</li>
<li>__extext或_extext或extext代码段结束地址，即代码段最末尾的地址</li>
<li>_edata或edata数据段结束地址，即数据段最末尾的地址</li>
<li>_end或end程序结束地址</li>
</ul>
</li>
</ol>
<h2 id="符号修饰与函数签名"><a href="#符号修饰与函数签名" class="headerlink" title="符号修饰与函数签名"></a>符号修饰与函数签名</h2><p>函数签名包含了一个函数的信息，包括函数名、参数类型、所在类、所在名字空间等信息<br>编译器及链接器处理符号时，使用某种那个名称修饰方法，使每个函数签名对应一个修饰后的名称<br>C++编译器会将在extern “C”的大括号内部的代码当作C语言处理。</p>
<h2 id="静态链接"><a href="#静态链接" class="headerlink" title="静态链接"></a>静态链接</h2><p>链接的主要内容是将各个目标代码之间相互引用的部分都处理好，使各个模块之间能够正确的衔接。<br>链接过程包括地址和空间分配、符号决议、重定位等步骤。<br>运行时库是支持程序运行的基本函数的集合。库其实是一组目标文件的包。<br>各个目标文件独立编译，变量及函数地址不能独立确定，需要在链接过程中修正，使其指向正确的地址，这个过程叫重定位，每个要修正的地方叫重定位入口。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ls</span><br><span class="line">main.c</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ gcc -o run main.c </span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ls</span><br><span class="line">main.c  run</span><br></pre></td></tr></table></figure>
<h3 id="相似段合并"><a href="#相似段合并" class="headerlink" title="相似段合并"></a>相似段合并</h3><p>链接器为目标文件分配地址和空间，其中地址和空间有两个含义：1.输出的可执行文件中的空间；2.装载的虚拟地址中的虚拟地址空间。<br>虚拟地址空间分配关系到链接器关于地址的计算，而可执行文件本身的空间分配与链接过程关系并不大。</p>
<ol>
<li>空间与地址分配 扫描所有输入目标文件，获取各个段长度、属性、位置，将目标文件符号表中符号定义和符号引用收集起来，统一放在全局符号表。链接器根据收集的信息合并各个段，计算文件文件中各个段合并后的长度与位置，并建立映射关系。</li>
<li>符号解析与重定位 使用空间与地址分配收集的信息，读取文件中段的数据、重定位信息，并进行符号解析和重定位、调整代码中的地址。</li>
</ol>
<h1 id="动态链接"><a href="#动态链接" class="headerlink" title="动态链接"></a>动态链接</h1><p>静态链接缺点</p>
<ol>
<li>浪费内存和磁盘空间</li>
<li>模块更新困难</li>
</ol>
<p><strong>动态链接：不对组成程序的目标文件进行链接，等程序运行时才进行链接，即将链接过程推迟到运行时再进行</strong>。<br>Linux系统中，ELF动态连接文件被称为<strong>动态共享对象（共享对象）</strong>，一般都以”.so”为扩展名。Windos中称为动态链接库，一般以”.dll”为扩展名。<br><strong>共享对象在编译时不能假设自己在进程虚拟地址控件中的位置</strong>。</p>
<h2 id="装载时重定位"><a href="#装载时重定位" class="headerlink" title="装载时重定位"></a>装载时重定位</h2><p>Linux和GCC支持装载时重定位的方法，在产生共享对象是<strong>不使用’-fPIC’，只使用’-shared’参数，输出的共享对象就是使用装载时重定位的方法</strong>。</p>
<h2 id="地址无关代码"><a href="#地址无关代码" class="headerlink" title="地址无关代码"></a>地址无关代码</h2><p>装载时重定位是解决动态模块中的办法之一，但其指令部分不能在多个进程间共享，失去了动态连接节省内存的一大优势。</p>
<ol>
<li>模块内部调用或跳转 模块内相对位置固定，通过相对地址调用</li>
<li>模块内部数据访问 相对寻址</li>
<li>模块间数据访问 ELF在数据段建立一个指向其它模块变量的指针数组（全局偏移表GOT），当代码需要引用该全局变量时，通过GOT中的相对应的项间接引用。</li>
<li>模块间调用、跳转 建立全局偏移表GOT，保存目标函数的地址。</li>
</ol>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">指令跳转、调用</th>
<th style="text-align:center">数据访问</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">模块内部</td>
<td style="text-align:center">1.相对跳转和调用</td>
<td style="text-align:center">2.相对地址访问</td>
</tr>
<tr>
<td style="text-align:center">模块外部</td>
<td style="text-align:center">3.间接跳转和调用</td>
<td style="text-align:center">4.间接访问</td>
</tr>
</tbody>
</table>
</div>
<p>‘-fpic’和’-fPIC’功能相同都是生成地址无关代码，但’-fPIC’生成的代码要大一点，’-fpic’生成代码小，不过’-fpic’在某些平台上会有一些限制，而’-fPIC’则不存在。</p>
<h2 id="延迟绑定"><a href="#延迟绑定" class="headerlink" title="延迟绑定"></a>延迟绑定</h2><p>延迟绑定：函数第一次被使用时才进行绑定。</p>
<h2 id="“-interp”段"><a href="#“-interp”段" class="headerlink" title="“.interp”段"></a>“.interp”段</h2><p>动态链接器的位置不是由系统配置指定，也不是由环境参数决定，而是由ELF可执行文件决定。<strong>“.interp”段保存的一个字符串就是可执行文件所需要的动态链接器的路径</strong>。</p>
<h2 id="“-dynamic”段"><a href="#“-dynamic”段" class="headerlink" title="“.dynamic”段"></a>“.dynamic”段</h2><p>“.dynamic”段保存了动态链接器所需要的基本信息（依赖的共享库、动态链接符号表位置、动态连接重定向表的位置、共享对象初始化代码的地址等）。<br>ldd命令可以查看一个程序或共享库依赖哪些共享库。</p>
<h2 id="动态符号表"><a href="#动态符号表" class="headerlink" title="动态符号表"></a>动态符号表</h2><p>“.dynsym”</p>
<h2 id="动态链接重定向表"><a href="#动态链接重定向表" class="headerlink" title="动态链接重定向表"></a>动态链接重定向表</h2><p>静态链接中”.rel.text”代码段重定位表 “.rel.data”数据段重定位表<br>动态链接中”.rel.dyn”对数据引用的修正 “.rel.plt”对函数引用的修正，它所修正的位置位于”.got.plt”</p>
<h1 id="静态链接库"><a href="#静态链接库" class="headerlink" title="静态链接库"></a>静态链接库</h1><p>静态链接库通常以”.a”为后缀，由程序ar生成。<br>静态链接库优点</p>
<ol>
<li>不需要重新编译程序库代码，就可进行程序的重新链接，节省编译时间。</li>
<li>提供库文件给使用人员，不需要开放源代码。</li>
<li>静态库执行速度比共享库和动态库要快。</li>
</ol>
<h2 id="静态链接库生成"><a href="#静态链接库生成" class="headerlink" title="静态链接库生成"></a>静态链接库生成</h2><ol>
<li>生成目标文件</li>
<li>用ar工具对目标文件归档。</li>
</ol>
<p>ar的-r选项，可以创建库，并把目标文件插入指定库中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ls</span><br><span class="line">hello.c</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ gcc -c hello.c </span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ls</span><br><span class="line">hello.c  hello.o</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ar -rcs libhello.a hello.o</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ls</span><br><span class="line">hello.c  hello.o  libhello.a</span><br></pre></td></tr></table></figure></p>
<h2 id="使用静态链接库"><a href="#使用静态链接库" class="headerlink" title="使用静态链接库"></a>使用静态链接库</h2><ol>
<li>和使用目标文件一致</li>
<li>使用”-l库名”使用，库名是不包含函数库和扩展名的字符串。</li>
</ol>
<p>使用”-L”显式指定搜索库的路径。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ rm run </span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ls</span><br><span class="line">hello.c  hello.o  libhello.a  main.c</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ gcc -o run main.c libhello.a </span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ls</span><br><span class="line">hello.c  hello.o  libhello.a  main.c  run</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ./run </span><br><span class="line">hello</span><br><span class="line"></span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ rm run </span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ls</span><br><span class="line">hello.c  hello.o  libhello.a  main.c</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ gcc -o run main.c -L./ -lhello</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ls</span><br><span class="line">hello.c  hello.o  libhello.a  main.c  run</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ./run </span><br><span class="line">hello</span><br></pre></td></tr></table></figure>
<h2 id="检查包的正确性"><a href="#检查包的正确性" class="headerlink" title="检查包的正确性"></a>检查包的正确性</h2><p>如果碰到<code>error adding symbols: Archive has no index; run ranlib to add one</code>可以使用<code>ar -t</code>检查打包的正确性<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ar -t libhello.a</span><br><span class="line">hello.o</span><br></pre></td></tr></table></figure></p>
<p>确认无误的话在使用file查看被打包文件类型<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ file hello.o</span><br><span class="line">hello.o: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), not stripped</span><br></pre></td></tr></table></figure></p>
<p>文件类型没问题再使用nm导出符号检查<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ nm hello.o</span><br><span class="line">                 U puts</span><br><span class="line">0000000000000000 T _Z11print_hellov</span><br></pre></td></tr></table></figure></p>
<h1 id="动态链接库"><a href="#动态链接库" class="headerlink" title="动态链接库"></a>动态链接库</h1><h2 id="生成动态链接库"><a href="#生成动态链接库" class="headerlink" title="生成动态链接库"></a>生成动态链接库</h2><p>使用-fPIC或-fpic选项使gcc生成动态链接库。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ cat hello.h</span><br><span class="line">#ifndef _HELLO_H_</span><br><span class="line">#define _HELLO_H_</span><br><span class="line"></span><br><span class="line">void print_hello();</span><br><span class="line"></span><br><span class="line">#endif</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ cat hello.cpp </span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &quot;hello.h&quot;</span><br><span class="line"></span><br><span class="line">void print_hello()</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;hello\n&quot;);</span><br><span class="line">&#125;</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ g++ -fPIC -shared -o libhello.so.1.0.0 hello.cpp hello.h</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ln -s libhello.so.1.0.0 libhello.so</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ls</span><br><span class="line">hello.cpp  hello.h  libhello.so  libhello.so.1.0.0  main.cpp</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ g++ -o run main.cpp hello.h -L./ -lhello</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ./run </span><br><span class="line">./run: error while loading shared libraries: libhello.so: cannot open shared object file: No such file or directory</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ldd ./run </span><br><span class="line">	linux-vdso.so.1 =&gt;  (0x00007ffc6fb99000)</span><br><span class="line">	libhello.so =&gt; not found</span><br><span class="line">	libstdc++.so.6 =&gt; /lib64/libstdc++.so.6 (0x00007f35af31c000)</span><br><span class="line">	libm.so.6 =&gt; /lib64/libm.so.6 (0x00007f35af01a000)</span><br><span class="line">	libgcc_s.so.1 =&gt; /lib64/libgcc_s.so.1 (0x00007f35aee04000)</span><br><span class="line">	libc.so.6 =&gt; /lib64/libc.so.6 (0x00007f35aea37000)</span><br><span class="line">	/lib64/ld-linux-x86-64.so.2 (0x00007f35af623000)</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ sudo vim /etc/ld.so.conf</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ cat /etc/ld.so.conf</span><br><span class="line">include ld.so.conf.d/*.conf</span><br><span class="line">/usr/local/lib</span><br><span class="line">.</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ sudo ldconfig</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ldd ./run </span><br><span class="line">	linux-vdso.so.1 =&gt;  (0x00007ffc251b6000)</span><br><span class="line">	libhello.so =&gt; ./libhello.so (0x00007fcc32399000)</span><br><span class="line">	libstdc++.so.6 =&gt; /lib64/libstdc++.so.6 (0x00007fcc32092000)</span><br><span class="line">	libm.so.6 =&gt; /lib64/libm.so.6 (0x00007fcc31d90000)</span><br><span class="line">	libgcc_s.so.1 =&gt; /lib64/libgcc_s.so.1 (0x00007fcc31b7a000)</span><br><span class="line">	libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fcc317ad000)</span><br><span class="line">	/lib64/ld-linux-x86-64.so.2 (0x00007fcc3259b000)</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ./run </span><br><span class="line">hello</span><br></pre></td></tr></table></figure></p>
<h2 id="Wl-soname编译选项"><a href="#Wl-soname编译选项" class="headerlink" title="-Wl,-soname编译选项"></a>-Wl,-soname编译选项</h2><p>-Wl选项告知编译器将后面的参数传递给链接器.<br>-soname指定动态库的soname(简单共享名,Short for shared object name)</p>
<p>利用soname可以提供动态库的兼容性,当升级一个库时新库和旧库兼容,则可以直接使用相同的soname,如果不兼容换个新的soname则不会影响旧库链接生成的程序.使得升级动态库变的容易.</p>
<p>可以通过readelf -d查看动态库的soname<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@VM_187_252_centos ~]$ readelf -d /usr/lib/libz.so.1.2.7 </span><br><span class="line">......</span><br><span class="line">  0x0000000e (SONAME)                     Library soname: [libz.so.1]</span><br><span class="line">......</span><br></pre></td></tr></table></figure></p>
<p>可以看到前面的动态库链接后libhello.so链接到libhello.so,当新的动态库不兼容旧的动态库时就会影响到旧库链接生成的程序,而指定soname后链接到libhello.so.1.0.0,动态库升级后不会影响到旧库链接生成的程序<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ldd ./run </span><br><span class="line">	linux-vdso.so.1 =&gt;  (0x00007ffee638a000)</span><br><span class="line">	libhello.so =&gt; ./libhello.so (0x00007fa8c214f000)</span><br><span class="line">	libstdc++.so.6 =&gt; /lib64/libstdc++.so.6 (0x00007fa8c1e48000)</span><br><span class="line">	libm.so.6 =&gt; /lib64/libm.so.6 (0x00007fa8c1b46000)</span><br><span class="line">	libgcc_s.so.1 =&gt; /lib64/libgcc_s.so.1 (0x00007fa8c1930000)</span><br><span class="line">	libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fa8c1563000)</span><br><span class="line">	/lib64/ld-linux-x86-64.so.2 (0x00007fa8c2351000)</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ g++ -fPIC -shared -Wl,-soname,libhello.so.1.0.0 -o libhello.so.1.0.0 hello.cpp hello.h</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ g++ -o run main.cpp hello.h -L./ -lhello</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ./run </span><br><span class="line">hello</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ldd ./run </span><br><span class="line">	linux-vdso.so.1 =&gt;  (0x00007ffc921b7000)</span><br><span class="line">	libhello.so.1.0.0 =&gt; ./libhello.so.1.0.0 (0x00007fc55f726000)</span><br><span class="line">	libstdc++.so.6 =&gt; /lib64/libstdc++.so.6 (0x00007fc55f41f000)</span><br><span class="line">	libm.so.6 =&gt; /lib64/libm.so.6 (0x00007fc55f11d000)</span><br><span class="line">	libgcc_s.so.1 =&gt; /lib64/libgcc_s.so.1 (0x00007fc55ef07000)</span><br><span class="line">	libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fc55eb3a000)</span><br><span class="line">	/lib64/ld-linux-x86-64.so.2 (0x00007fc55f928000)</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ readelf -d libhello.so.1.0.0 </span><br><span class="line">......</span><br><span class="line">    0x000000000000000e (SONAME)             Library soname: [libhello.so.1.0.0]</span><br><span class="line">......</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ readelf -d libhello.so</span><br><span class="line">......</span><br><span class="line">    0x000000000000000e (SONAME)             Library soname: [libhello.so.1.0.0]</span><br><span class="line">......</span><br></pre></td></tr></table></figure></p>
<p>还可以兼容版本使用同一个soname,当有新的不兼容版本时再更换soname</p>
<h2 id="优先使用静态链接的方法"><a href="#优先使用静态链接的方法" class="headerlink" title="优先使用静态链接的方法"></a>优先使用静态链接的方法</h2><p>使用动态库的不便之处在于服务部署环境必须安装了该动态库,且版本必须一致或兼容,否则程序无法运行,而静态库则不存在这个问题,当既有动态库,又有静态库时程序默认优先使用动态库,使用<code>-Wl,-Bstatic</code>可以指定优先使用静态库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ g++ -o run main.cpp hello.h -L./ -lhello</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ./run </span><br><span class="line">hello</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ls</span><br><span class="line">hello.cpp  hello.h  libhello.so  libhello.so.1.0.0  main.cpp  run</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ldd ./run </span><br><span class="line">	linux-vdso.so.1 =&gt;  (0x00007ffc20f4f000)</span><br><span class="line">	libhello.so.1.0.0 =&gt; ./libhello.so.1.0.0 (0x00007f9025501000)</span><br><span class="line">	libstdc++.so.6 =&gt; /lib64/libstdc++.so.6 (0x00007f90251fa000)</span><br><span class="line">	libm.so.6 =&gt; /lib64/libm.so.6 (0x00007f9024ef8000)</span><br><span class="line">	libgcc_s.so.1 =&gt; /lib64/libgcc_s.so.1 (0x00007f9024ce2000)</span><br><span class="line">	libc.so.6 =&gt; /lib64/libc.so.6 (0x00007f9024915000)</span><br><span class="line">	/lib64/ld-linux-x86-64.so.2 (0x00007f9025703000)</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ g++ -c hello.cpp -o hello.o</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ar -rcs libhello.a hello.o</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ g++ -o run main.cpp hello.h -Wl,-Bstatic -L./ -lhello</span><br><span class="line">/usr/bin/ld: cannot find -lstdc++</span><br><span class="line">/usr/bin/ld: cannot find -lgcc_s</span><br><span class="line">/usr/bin/ld: cannot find -lgcc_s</span><br><span class="line">collect2: error: ld returned 1 exit status</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ g++ -o run main.cpp hello.h -L./ -Wl,-Bstatic -lhello</span><br><span class="line">/usr/bin/ld: cannot find -lstdc++</span><br><span class="line">/usr/bin/ld: cannot find -lgcc_s</span><br><span class="line">/usr/bin/ld: cannot find -lgcc_s</span><br><span class="line">collect2: error: ld returned 1 exit status</span><br></pre></td></tr></table></figure></p>
<p>找不到库是因为指定<code>-Wl,-Bstatic</code>后所有库都强制使用了静态库导致的,添加<code>-Wl,-Bdynamic</code>让别的库可以使用动态库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ g++ -o run main.cpp hello.h -L./ -Wl,-Bstatic -lhello -Wl,-Bdynamic</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ./run </span><br><span class="line">hello</span><br><span class="line">[CaseZheng@VM_187_252_centos Tmp]$ ldd ./run </span><br><span class="line">	linux-vdso.so.1 =&gt;  (0x00007ffcf61cf000)</span><br><span class="line">	libstdc++.so.6 =&gt; /lib64/libstdc++.so.6 (0x00007fa076f64000)</span><br><span class="line">	libm.so.6 =&gt; /lib64/libm.so.6 (0x00007fa076c62000)</span><br><span class="line">	libgcc_s.so.1 =&gt; /lib64/libgcc_s.so.1 (0x00007fa076a4c000)</span><br><span class="line">	libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fa07667f000)</span><br><span class="line">	/lib64/ld-linux-x86-64.so.2 (0x00007fa07726b000)</span><br></pre></td></tr></table></figure></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/cpp/" rel="tag"># cpp</a>
              <a href="/tags/linux/" rel="tag"># linux</a>
              <a href="/tags/gcc/" rel="tag"># gcc</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/03/13/linux-1-system-architecture/" rel="prev" title="linux系统架构">
      <i class="fa fa-chevron-left"></i> linux系统架构
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/03/22/mysql-4/" rel="next" title="MySQL 数据类型">
      MySQL 数据类型 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#GCC简介"><span class="nav-number">1.</span> <span class="nav-text">GCC简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#编译程序基础"><span class="nav-number">2.</span> <span class="nav-text">编译程序基础</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#gcc选项"><span class="nav-number">2.1.</span> <span class="nav-text">gcc选项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#预编译"><span class="nav-number">2.2.</span> <span class="nav-text">预编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编译和优化"><span class="nav-number">2.3.</span> <span class="nav-text">编译和优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#词法分析"><span class="nav-number">2.3.1.</span> <span class="nav-text">词法分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#语法分析"><span class="nav-number">2.3.2.</span> <span class="nav-text">语法分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#语义分析"><span class="nav-number">2.3.3.</span> <span class="nav-text">语义分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码级优化及中间代码生成"><span class="nav-number">2.3.4.</span> <span class="nav-text">源码级优化及中间代码生成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成汇编代码及优化"><span class="nav-number">2.3.5.</span> <span class="nav-text">生成汇编代码及优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#汇编"><span class="nav-number">2.4.</span> <span class="nav-text">汇编</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#目标文件"><span class="nav-number">3.</span> <span class="nav-text">目标文件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#目标文件格式"><span class="nav-number">3.1.</span> <span class="nav-text">目标文件格式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#目标文件内容"><span class="nav-number">3.2.</span> <span class="nav-text">目标文件内容</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#目标文件结构"><span class="nav-number">3.3.</span> <span class="nav-text">目标文件结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#符号修饰与函数签名"><span class="nav-number">3.4.</span> <span class="nav-text">符号修饰与函数签名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#静态链接"><span class="nav-number">3.5.</span> <span class="nav-text">静态链接</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#相似段合并"><span class="nav-number">3.5.1.</span> <span class="nav-text">相似段合并</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#动态链接"><span class="nav-number">4.</span> <span class="nav-text">动态链接</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#装载时重定位"><span class="nav-number">4.1.</span> <span class="nav-text">装载时重定位</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#地址无关代码"><span class="nav-number">4.2.</span> <span class="nav-text">地址无关代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#延迟绑定"><span class="nav-number">4.3.</span> <span class="nav-text">延迟绑定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#“-interp”段"><span class="nav-number">4.4.</span> <span class="nav-text">“.interp”段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#“-dynamic”段"><span class="nav-number">4.5.</span> <span class="nav-text">“.dynamic”段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动态符号表"><span class="nav-number">4.6.</span> <span class="nav-text">动态符号表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动态链接重定向表"><span class="nav-number">4.7.</span> <span class="nav-text">动态链接重定向表</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#静态链接库"><span class="nav-number">5.</span> <span class="nav-text">静态链接库</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#静态链接库生成"><span class="nav-number">5.1.</span> <span class="nav-text">静态链接库生成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用静态链接库"><span class="nav-number">5.2.</span> <span class="nav-text">使用静态链接库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#检查包的正确性"><span class="nav-number">5.3.</span> <span class="nav-text">检查包的正确性</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#动态链接库"><span class="nav-number">6.</span> <span class="nav-text">动态链接库</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#生成动态链接库"><span class="nav-number">6.1.</span> <span class="nav-text">生成动态链接库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Wl-soname编译选项"><span class="nav-number">6.2.</span> <span class="nav-text">-Wl,-soname编译选项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优先使用静态链接的方法"><span class="nav-number">6.3.</span> <span class="nav-text">优先使用静态链接的方法</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="CaseZheng"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">CaseZheng</p>
  <div class="site-description" itemprop="description">CaseZheng的博客网站</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">130</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">36</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/CaseZheng" title="GitHub → https://github.com/CaseZheng" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:764307915@qq.com" title="E-Mail → mailto:764307915@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CaseZheng</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">717k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">10:52</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>
