<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="msvalidate.01" content="F14AAB2D4C842CB9F200D0A80DA8CB2F">
  <meta name="baidu-site-verification" content="GNlbaIvRtqlfiBfg">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.casezheng.date","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="CaseZheng的博客网站">
<meta property="og:type" content="website">
<meta property="og:title" content="CaseZheng">
<meta property="og:url" content="http://www.casezheng.date/page/5/index.html">
<meta property="og:site_name" content="CaseZheng">
<meta property="og:description" content="CaseZheng的博客网站">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CaseZheng">
<meta name="twitter:description" content="CaseZheng的博客网站">

<link rel="canonical" href="http://www.casezheng.date/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>CaseZheng</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4f1686055a927fa7bf1a09bc1143b57c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">CaseZheng</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">CaseZheng Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.casezheng.date/2018/03/13/linux-1-system-architecture/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CaseZheng">
      <meta itemprop="description" content="CaseZheng的博客网站">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CaseZheng">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/03/13/linux-1-system-architecture/" class="post-title-link" itemprop="url">linux系统架构</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-03-13 19:54:33" itemprop="dateCreated datePublished" datetime="2018-03-13T19:54:33+08:00">2018-03-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-12 12:56:36" itemprop="dateModified" datetime="2020-04-12T12:56:36+08:00">2020-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Linux系统从应用角度来看，分为内核空间和用户空间两部分。内核空间是Linux操作系统的主要部分。</p>
<h1 id="Linux内核主要模块"><a href="#Linux内核主要模块" class="headerlink" title="Linux内核主要模块"></a>Linux内核主要模块</h1><p>Linux内核由5个子系统组成:进程调度、内存管理、虚拟文件系统、网络接口、进程间通信。</p>
<h2 id="进程调度SCHED"><a href="#进程调度SCHED" class="headerlink" title="进程调度SCHED"></a>进程调度SCHED</h2><p>进程调度指系统对进程的多种状态之间转换的策略。Linux进程调度主要有三种策略：SCHED_OTHER、SCHED_FIFO和SCHED_RR。</p>
<ol>
<li>SCHED_OTHER<strong>分时调度策略（默认）</strong>，针对<strong>普通进程的时间片轮转调度策略</strong>。系统给所有的运行状态的进程分配时间片。在当前进程的时间片用完后，系统从进程中优先级高的进程中选择进程运行。</li>
<li>SCHED_FIFO<strong>实时调度策略，先到先服务</strong>，针对运行的<strong>实时性要求比较高、运行时间短</strong>的进程调度策略。系统按照进入队列的先后进行进程的调度，在没有更高优先级到来或者当前进程没有因为等待资源而阻塞的情况下，会一直运行。</li>
<li>SCHED_RR<strong>实时调度策略，时间片轮转</strong>，针对<strong>实时性比较高、运行时间长</strong>的进行调度策略。SCHED_RR和SCHED_OTHER相似，但SCHED_RR的优先级要高的多。系统分配给SCHED_RR进程时间片，然后轮循进程，将时间片用完的进程放在队列末尾。</li>
</ol>
<p>由于存在多种调度方式，Linux进程调度采用“有条件可剥夺”的调度方式。普通进程中采用SCHED_OTHER的时间片轮询方式，<strong>实时进程可以剥夺普通进程</strong>。如果普通进程在用户空间运行，则普通进程立即停止运行，将资源让给实时进程；如果普通进程在内核空间，则需要等系统调用返回用户空间后方可剥夺资源。</p>
<h2 id="内存管理MMU"><a href="#内存管理MMU" class="headerlink" title="内存管理MMU"></a>内存管理MMU</h2><p>内存管理时多个进程间共享内存的策略。在Linux中内存管理主要概念是<strong>虚拟内存</strong>。虚拟内存让内存可以使用比实际物理内存更大的内存，每个进程的虚拟内存有不同的地址空间，多个进程的虚拟内存不会冲突。虚拟内存的分配策略是每个进程都可以公平地使用虚拟内存。</p>
<h2 id="虚拟文件系统VFS"><a href="#虚拟文件系统VFS" class="headerlink" title="虚拟文件系统VFS"></a>虚拟文件系统VFS</h2><p>Linux支持多种文件系统。最常见的文件格式是ext2和ext3。ext2文件系统用于固定文件系统和可活动文件系统，是ext的扩展。ext3是ext2上增加日志功能后的扩展。ext2和ext3可以互相转化。</p>
<h2 id="网络接口"><a href="#网络接口" class="headerlink" title="网络接口"></a>网络接口</h2><p>Linux支持多种网络接口和协议。网络接口分为网络协议和驱动程序，网络协议是网络传输的通信标准，驱动程序是对硬件设备的驱动程序。</p>
<h2 id="进程间通信"><a href="#进程间通信" class="headerlink" title="进程间通信"></a>进程间通信</h2><p>Linux下进程通信方式：<strong>管道、信号、消息队列、共享内存、套接字</strong>。</p>
<h1 id="Linux文件系统"><a href="#Linux文件系统" class="headerlink" title="Linux文件系统"></a>Linux文件系统</h1><p>Linux操作系统文件结构的开始是一个顶级目录结构，叫做<strong>根目录</strong>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@VM_187_252_centos /]$ cd /</span><br><span class="line">[CaseZheng@VM_187_252_centos /]$ ls</span><br><span class="line">bin  boot  data  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br></pre></td></tr></table></figure></p>
<p>根目录下常用目录作用：</p>
<ol>
<li>/bin Binary存放经常使用的命令</li>
<li>/boot 存放启动linux时需要使用的核心文件，包括连接文件和镜像文件</li>
<li>/dev Device存放Linux的外部设备</li>
<li>/etc 存放所有系统管理所需要的配置文件和子目录</li>
<li>/home 用户家目录</li>
<li>/lib 存放系统最基本的动态链接库</li>
<li>/lost+found 一般情况下是空的，当系统非法关机，存放一些文件</li>
<li>/media linux系统自动识别一些设备，当识别后会将识别的设备挂载在这个目录下</li>
<li>/mnt 专门给外挂的文件系统使用</li>
<li>/opt 可选的应用程序软件包</li>
<li>/proc 虚拟目录，系统内存的映射，可直接访问该目录获取系统信息，这个目录内容在内存中，而不是硬盘。</li>
<li>/root 根用户的主目录</li>
<li>/sbin 存放系统管理员使用的系统管理程序</li>
<li>/selinux Redhat/CentOS特有目录，Selinux是安全机制，比较复杂，该目录用于存放selinux相关文件。</li>
<li>/src 存放一些服务启动后需要提取的数据</li>
<li>/sys 该目录下安装sysfs文件系统，sysfs文件系统集成了3中文件系统信息：针对进程信息的proc文件系统、针对设备的devfs文件系统、针对伪终端的devpts文件系统，该文件系统是内核设备的一个直观反映。当一个内核对象被创建的时候，对应的文件和目录也在内核对象子系统中被创建。</li>
<li>/var 包含系统定义表，以便在系统运行改变时只备份该目录</li>
<li>/tmp 用于临时性存储</li>
<li>/usr 用户的很多应用程序和文件放在该目录下</li>
<li>/usr/bin 系统用户使用的应用程序</li>
<li>/usr/sbin 超级用户使用的比较高级的管理程序和系统守护程序</li>
<li>/usr/src 内核源代码默认的放置目录</li>
<li>/usr/lib 库文件</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.casezheng.date/2018/03/12/hexo-plantuml/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CaseZheng">
      <meta itemprop="description" content="CaseZheng的博客网站">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CaseZheng">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/03/12/hexo-plantuml/" class="post-title-link" itemprop="url">博客搭建纪要</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-03-12 22:38:04" itemprop="dateCreated datePublished" datetime="2018-03-12T22:38:04+08:00">2018-03-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-12 12:56:36" itemprop="dateModified" datetime="2020-04-12T12:56:36+08:00">2020-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/other/" itemprop="url" rel="index"><span itemprop="name">other</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Hexo博客使用记录"><a href="#Hexo博客使用记录" class="headerlink" title="Hexo博客使用记录"></a>Hexo博客使用记录</h1><h2 id="Hexo安装"><a href="#Hexo安装" class="headerlink" title="Hexo安装"></a>Hexo安装</h2><h3 id="git"><a href="#git" class="headerlink" title="git"></a>git</h3><h3 id="Node-js"><a href="#Node-js" class="headerlink" title="Node.js"></a>Node.js</h3><ol>
<li><p>linux</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install nodejs</span><br></pre></td></tr></table></figure>
</li>
<li><p>windows<br><a href="https://nodejs.org/en/" target="_blank" rel="noopener">官网下载安装</a></p>
</li>
</ol>
<h3 id="hexo"><a href="#hexo" class="headerlink" title="hexo"></a>hexo</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -g hexo</span><br></pre></td></tr></table></figure>
<h2 id="hexo中plantuml"><a href="#hexo中plantuml" class="headerlink" title="hexo中plantuml"></a>hexo中plantuml</h2><h3 id="安装java"><a href="#安装java" class="headerlink" title="安装java"></a>安装java</h3><ol>
<li><p>linux</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install java</span><br><span class="line">sudo yum install java-devel</span><br></pre></td></tr></table></figure>
</li>
<li><p>windows<br><a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_blank" rel="noopener">下载地址</a><br>Java环境变量配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">变量名：JAVA_HOME</span><br><span class="line">变量值：C:\Program Files (x86)\Java\jdk1.8.0_91        // 要根据自己的实际路径配置</span><br><span class="line"></span><br><span class="line">变量名：CLASSPATH</span><br><span class="line">变量值：.;%JAVA_HOME%\lib\dt.jar;%JAVA_HOME%\lib\tools.jar;         //记得前面有个&quot;.&quot;</span><br><span class="line"></span><br><span class="line">变量名：Path</span><br><span class="line">变量值：%JAVA_HOME%\bin;%JAVA_HOME%\jre\bin;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="安装graphviz"><a href="#安装graphviz" class="headerlink" title="安装graphviz"></a>安装graphviz</h3><ol>
<li><p>linux </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install graphviz -y</span><br></pre></td></tr></table></figure>
</li>
<li><p>windows<br><a href="https://graphviz.gitlab.io/_pages/Download/Download_windows.html" target="_blank" rel="noopener">下载地址</a><br>将其bin目录加入系统Path变量中</p>
</li>
</ol>
<h3 id="安装Hexo插件hexo-filter-plantuml"><a href="#安装Hexo插件hexo-filter-plantuml" class="headerlink" title="安装Hexo插件hexo-filter-plantuml"></a>安装Hexo插件hexo-filter-plantuml</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save hexo-filter-plantuml</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/wafer-li/hexo-filter-plantuml" target="_blank" rel="noopener">hexo-filter-plantuml</a></p>
<h2 id="站内搜索功能"><a href="#站内搜索功能" class="headerlink" title="站内搜索功能"></a>站内搜索功能</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-generator-search --save</span><br><span class="line">npm install hexo-generator-searchdb --save</span><br></pre></td></tr></table></figure>
<h2 id="hexo命令"><a href="#hexo命令" class="headerlink" title="hexo命令"></a>hexo命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hexo n &quot;我的博客&quot; == hexo new &quot;我的博客&quot; #新建文章</span><br><span class="line">hexo p == hexo publish</span><br><span class="line">hexo g == hexo generate#生成</span><br><span class="line">hexo s == hexo server #启动服务预览</span><br><span class="line">hexo d == hexo deploy#部署</span><br><span class="line"></span><br><span class="line">hexo server --drafts 预览草稿</span><br></pre></td></tr></table></figure>
<h2 id="hexo报错解决"><a href="#hexo报错解决" class="headerlink" title="hexo报错解决"></a>hexo报错解决</h2><h3 id="找不到git部署"><a href="#找不到git部署" class="headerlink" title="找不到git部署"></a>找不到git部署</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR Deployer not found: git</span><br></pre></td></tr></table></figure>
<p>解决方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure></p>
<h1 id="Jekyll目录结构"><a href="#Jekyll目录结构" class="headerlink" title="Jekyll目录结构"></a>Jekyll目录结构</h1><ul>
<li>_config.yml 保存配置数据</li>
<li>_drafts 未发布文章 </li>
<li>_includes </li>
<li>_layouts 包裹在文章外部的模版，布局可以在YAML头信息中根据不同文章进行选择，标签<h1 id="Hexo博客使用记录"><a href="#Hexo博客使用记录" class="headerlink" title="Hexo博客使用记录"></a>Hexo博客使用记录</h1><h2 id="Hexo安装"><a href="#Hexo安装" class="headerlink" title="Hexo安装"></a>Hexo安装</h2><h3 id="git"><a href="#git" class="headerlink" title="git"></a>git</h3><h3 id="Node-js"><a href="#Node-js" class="headerlink" title="Node.js"></a>Node.js</h3><ol>
<li><p>linux</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install nodejs</span><br></pre></td></tr></table></figure>
</li>
<li><p>windows<br><a href="https://nodejs.org/en/" target="_blank" rel="noopener">官网下载安装</a></p>
</li>
</ol>
<h3 id="hexo"><a href="#hexo" class="headerlink" title="hexo"></a>hexo</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -g hexo</span><br></pre></td></tr></table></figure>
<h2 id="hexo中plantuml"><a href="#hexo中plantuml" class="headerlink" title="hexo中plantuml"></a>hexo中plantuml</h2><h3 id="安装java"><a href="#安装java" class="headerlink" title="安装java"></a>安装java</h3><ol>
<li><p>linux</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install java</span><br><span class="line">sudo yum install java-devel</span><br></pre></td></tr></table></figure>
</li>
<li><p>windows<br><a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_blank" rel="noopener">下载地址</a><br>Java环境变量配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">变量名：JAVA_HOME</span><br><span class="line">变量值：C:\Program Files (x86)\Java\jdk1.8.0_91        // 要根据自己的实际路径配置</span><br><span class="line"></span><br><span class="line">变量名：CLASSPATH</span><br><span class="line">变量值：.;%JAVA_HOME%\lib\dt.jar;%JAVA_HOME%\lib\tools.jar;         //记得前面有个&quot;.&quot;</span><br><span class="line"></span><br><span class="line">变量名：Path</span><br><span class="line">变量值：%JAVA_HOME%\bin;%JAVA_HOME%\jre\bin;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="安装graphviz"><a href="#安装graphviz" class="headerlink" title="安装graphviz"></a>安装graphviz</h3><ol>
<li><p>linux </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install graphviz -y</span><br></pre></td></tr></table></figure>
</li>
<li><p>windows<br><a href="https://graphviz.gitlab.io/_pages/Download/Download_windows.html" target="_blank" rel="noopener">下载地址</a><br>将其bin目录加入系统Path变量中</p>
</li>
</ol>
<h3 id="安装Hexo插件hexo-filter-plantuml"><a href="#安装Hexo插件hexo-filter-plantuml" class="headerlink" title="安装Hexo插件hexo-filter-plantuml"></a>安装Hexo插件hexo-filter-plantuml</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save hexo-filter-plantuml</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/wafer-li/hexo-filter-plantuml" target="_blank" rel="noopener">hexo-filter-plantuml</a></p>
<h2 id="站内搜索功能"><a href="#站内搜索功能" class="headerlink" title="站内搜索功能"></a>站内搜索功能</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-generator-search --save</span><br><span class="line">npm install hexo-generator-searchdb --save</span><br></pre></td></tr></table></figure>
<h2 id="hexo命令"><a href="#hexo命令" class="headerlink" title="hexo命令"></a>hexo命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hexo n &quot;我的博客&quot; == hexo new &quot;我的博客&quot; #新建文章</span><br><span class="line">hexo p == hexo publish</span><br><span class="line">hexo g == hexo generate#生成</span><br><span class="line">hexo s == hexo server #启动服务预览</span><br><span class="line">hexo d == hexo deploy#部署</span><br><span class="line"></span><br><span class="line">hexo server --drafts 预览草稿</span><br></pre></td></tr></table></figure>
<h2 id="hexo报错解决"><a href="#hexo报错解决" class="headerlink" title="hexo报错解决"></a>hexo报错解决</h2><h3 id="找不到git部署"><a href="#找不到git部署" class="headerlink" title="找不到git部署"></a>找不到git部署</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR Deployer not found: git</span><br></pre></td></tr></table></figure>
<p>解决方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure></p>
<h1 id="Jekyll目录结构"><a href="#Jekyll目录结构" class="headerlink" title="Jekyll目录结构"></a>Jekyll目录结构</h1><ul>
<li>_config.yml 保存配置数据</li>
<li>_drafts 未发布文章 </li>
<li>_includes </li>
<li>_layouts 包裹在文章外部的模版，布局可以在YAML头信息中根据不同文章进行选择，标签{{content}}可以将content插入页面中。</li>
<li>_posts 存放正式发布文章，文件格式很重要，必须符合：YEAR-MONTH-DAY-title.MARKUP</li>
<li>_data</li>
<li>_site Jekyll完成转换，生成的页面存放处(默认)，该目录最好加入.gitignore</li>
<li>index.html 其它html、markdown、testile 文件 如果文件包含YAML头信息部分，Jekyll自动将它们转换，其它.html、.markdown、.md或者.textile等在站点根目录下或者不是以上提到的目录中的文件也会被转化。</li>
<li>其它文件目录 其它未被提及的目录和文件豆浆杯完全拷贝到生成的site中。</li>
</ul>
<h1 id="头信息"><a href="#头信息" class="headerlink" title="头信息"></a>头信息</h1><ul>
<li>任何只要包含YAML头信息的文件在Jekyll中都被当做一个特殊的文件来处理</li>
<li>头信息必须在文件开始部分，需要安装YAML的格式卸载两行三虚线之间</li>
</ul>
<h2 id="预定义的全局变量"><a href="#预定义的全局变量" class="headerlink" title="预定义的全局变量"></a>预定义的全局变量</h2><ul>
<li>layout 如果设置的话，会指定使用该模板文件。指定模板文件时候不需要扩展名。模板文件需要放在 _layouts 目录下。</li>
<li>permalink 如果你需要让你的博客中的URL地址不同于默认值 /year/month/day/title.html 当你设置这个变量后，就会使用最终的URL地址。 </li>
<li>published 当站点生成的时候，如果你不需要展示一个具体的博文，可以设置这个变量为 false。 </li>
<li>category/categories 除过将博客文章放在某个文件夹下面外，你还可以根据文章的类别来给他们设置一个或者多个分类属性。这样当你的博客生成的时候这些文章就可以根据这些分类来阅读。在一个文章中多个类别可以通过 YAML list来指定，或者用空格隔开。 </li>
<li>tags 类似分类，一篇文章也可以给它增加一个或者多个标签。同样多个标签之间可以通过 YAML 列表或者空格隔开。 </li>
</ul>
<h2 id="自定义变量"><a href="#自定义变量" class="headerlink" title="自定义变量"></a>自定义变量</h2><p>在头信息中没有预先定义的任何变量都会在数据转换中通过 Liquid 模板被调用</p>
<h2 id="在文章中预定义的变量"><a href="#在文章中预定义的变量" class="headerlink" title="在文章中预定义的变量"></a>在文章中预定义的变量</h2><p>在文章中可以使用这些在头信息变量列表中未包含的变量<br>date 会覆盖文章名字中的日期。可以用来确定文章分类的正确。 </p>
可以将content插入页面中。</li>
<li>_posts 存放正式发布文章，文件格式很重要，必须符合：YEAR-MONTH-DAY-title.MARKUP</li>
<li>_data</li>
<li>_site Jekyll完成转换，生成的页面存放处(默认)，该目录最好加入.gitignore</li>
<li>index.html 其它html、markdown、testile 文件 如果文件包含YAML头信息部分，Jekyll自动将它们转换，其它.html、.markdown、.md或者.textile等在站点根目录下或者不是以上提到的目录中的文件也会被转化。</li>
<li>其它文件目录 其它未被提及的目录和文件豆浆杯完全拷贝到生成的site中。</li>
</ul>
<h1 id="头信息"><a href="#头信息" class="headerlink" title="头信息"></a>头信息</h1><ul>
<li>任何只要包含YAML头信息的文件在Jekyll中都被当做一个特殊的文件来处理</li>
<li>头信息必须在文件开始部分，需要安装YAML的格式卸载两行三虚线之间</li>
</ul>
<h2 id="预定义的全局变量"><a href="#预定义的全局变量" class="headerlink" title="预定义的全局变量"></a>预定义的全局变量</h2><ul>
<li>layout 如果设置的话，会指定使用该模板文件。指定模板文件时候不需要扩展名。模板文件需要放在 _layouts 目录下。</li>
<li>permalink 如果你需要让你的博客中的URL地址不同于默认值 /year/month/day/title.html 当你设置这个变量后，就会使用最终的URL地址。 </li>
<li>published 当站点生成的时候，如果你不需要展示一个具体的博文，可以设置这个变量为 false。 </li>
<li>category/categories 除过将博客文章放在某个文件夹下面外，你还可以根据文章的类别来给他们设置一个或者多个分类属性。这样当你的博客生成的时候这些文章就可以根据这些分类来阅读。在一个文章中多个类别可以通过 YAML list来指定，或者用空格隔开。 </li>
<li>tags 类似分类，一篇文章也可以给它增加一个或者多个标签。同样多个标签之间可以通过 YAML 列表或者空格隔开。 </li>
</ul>
<h2 id="自定义变量"><a href="#自定义变量" class="headerlink" title="自定义变量"></a>自定义变量</h2><p>在头信息中没有预先定义的任何变量都会在数据转换中通过 Liquid 模板被调用</p>
<h2 id="在文章中预定义的变量"><a href="#在文章中预定义的变量" class="headerlink" title="在文章中预定义的变量"></a>在文章中预定义的变量</h2><p>在文章中可以使用这些在头信息变量列表中未包含的变量<br>date 会覆盖文章名字中的日期。可以用来确定文章分类的正确。 </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.casezheng.date/2018/02/08/algorithm-sorting/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CaseZheng">
      <meta itemprop="description" content="CaseZheng的博客网站">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CaseZheng">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/02/08/algorithm-sorting/" class="post-title-link" itemprop="url">排序算法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-02-08 22:34:02" itemprop="dateCreated datePublished" datetime="2018-02-08T22:34:02+08:00">2018-02-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-12 12:56:36" itemprop="dateModified" datetime="2020-04-12T12:56:36+08:00">2020-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="插入排序"><a href="#插入排序" class="headerlink" title="插入排序"></a>插入排序</h2><p>插入排序是对少量元素进行排序的有效算法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">初始状态: 4,| 9, 7, 20, 3, 16, 18</span><br><span class="line">第一趟:   4, 9,| 7, 20, 3, 16, 18</span><br><span class="line">第二趟:   4, 7, 9,| 20, 3, 16, 18</span><br><span class="line">第三趟:   3, 4, 7, 9,| 20, 16, 18</span><br><span class="line">第四趟:   3, 4, 7, 9, 16,| 20, 18</span><br><span class="line">第五趟:   3, 4, 7, 9, 16, 18,| 20</span><br></pre></td></tr></table></figure></p>
<p>插入排序n个元素的排序需要进行n-1趟插入排序将所有元素完成排序。<br>插入排序是<strong>稳定排序</strong>算法。在数据及规模不大时，插入排序具有较好的效率。最好情况下每个元素都在其正确的位置上，进行排序所需事件为对每个元素与其前一个元素对比的时间，约等于一次遍历所花时间，所以<strong>最好情况下时间复杂度为$O(n)$</strong>，在普通情况和最坏情况下，n个元素每个元素都需要被移动一个线性的距离，所以<strong>平均和最坏情况下，插入排序的时间复杂度为$O(n^2)$</strong>。</p>
<h2 id="冒泡排序"><a href="#冒泡排序" class="headerlink" title="冒泡排序"></a>冒泡排序</h2><p>冒泡排序（气泡排序）是交换排序的一种。分为下沉排序和上浮排序。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">下沉排序</span><br><span class="line">初始状态: 4, 9, 7, 20, 3, 16, 18</span><br><span class="line">第一趟:   4, 7, 9, 3, 16, 18, 20</span><br><span class="line">第二趟:   4, 7, 3, 9, 16, 18, 20</span><br><span class="line">第三趟:   4, 3, 7, 9, 16, 18, 20</span><br><span class="line">第四趟:   3, 4, 7, 9, 16, 18, 20</span><br><span class="line"></span><br><span class="line">上浮排序</span><br><span class="line">初始状态: 4, 9, 7, 20, 3, 16, 18</span><br><span class="line">第一趟:   3, 4, 9, 7, 20, 16, 18</span><br><span class="line">第二趟:   3, 4, 7, 9, 16, 20, 18</span><br><span class="line">第三趟:   3, 4, 7, 9, 16, 18, 20</span><br></pre></td></tr></table></figure></p>
<p>冒泡排序主要步骤是相邻元素的比较和交换，终止的标志为在某一趟排序过程中值有对比动作而没有交换动作。<br>冒泡排序在最好情况下，初始状态就已经是升序排序，则只需要经过一趟n-1次元素之间比较，且不用进行元素移动，就结束排序，<strong>最好时间复杂度为$O(n)$</strong>。最坏情况下，参加排序的数据元素为逆序排序，或最小值在序列最后时，需要进行n-1趟排序，<strong>平均和最坏时间复杂度都是$O(n^2)$</strong>。<br>冒泡排序的元素交换发生在相邻元素之间，不会改变值相同元素的相对位置，因此，<strong>冒泡排序是稳定排序</strong>。</p>
<h2 id="选择排序"><a href="#选择排序" class="headerlink" title="选择排序"></a>选择排序</h2><p>选择排序重复地从待排序的元素中选出最大的或最小的元素进行排序。<br>选择排序的时间复杂度为$O(n^2)$<br>选择排序是非稳定排序<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">选最小值排序</span><br><span class="line">初始状态: 4, 9, 7, 20, 3, 16, 18</span><br><span class="line">第一趟:   3, 9, 7, 20, 4, 16, 18</span><br><span class="line">第二趟:   3, 4, 7, 20, 9, 16, 18</span><br><span class="line">第三趟:   3, 4, 7, 20, 9, 16, 18</span><br><span class="line">第四趟:   3, 4, 7,  9,20, 16, 18</span><br><span class="line">第五趟:   3, 4, 7,  9,16, 20, 18</span><br><span class="line">第六趟:   3, 4, 7,  9,16, 18, 20</span><br><span class="line"></span><br><span class="line">选最大值排序</span><br><span class="line">初始状态: 4, 9, 7, 20, 3, 16, 18</span><br><span class="line">第一趟:   4, 9, 7, 18, 3, 16, 20</span><br><span class="line">第二趟:   4, 9, 7, 16, 3, 18, 20</span><br><span class="line">第三趟:   4, 9, 7,  3,16, 18, 20</span><br><span class="line">第四趟:   4, 3, 7,  9,16, 18, 20</span><br><span class="line">第五趟:   4, 3, 7,  9,16, 18, 20</span><br><span class="line">第六趟:   3, 4, 7,  9,16, 18, 20</span><br></pre></td></tr></table></figure></p>
<h2 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h2><p>快速排序是运用分治思想的算法。主要思想：有待排序数组S={d1, d2, d3, …, dn}，从中找出元素划界元素v，将剩下元素中小于或等于v的元素移动到v的前面，将大于或等于v的元素i移动到v的后面，v就找到了它的最终位置，并将S划分为两个不相交的子数组S1和S2。其中S1中的元素均小于或等于v，S2中的元素均大于或等于v，这个过程称为一次排序。然后快速排序递归地对子序列S1和S2进行上述排序过程。直至所有的子序列都只包含0或1个元素时停止，整个数组完成排序。<br>划界元素一般取第一个元素、中间元素或最后一个元素。<br>快速排序是不稳定排序，主要是因为最后异步划界元素与S[i+1]交换的时候有可能打破前面元素的稳定性。<br>快速排序的最坏时间复杂度为$O(n^2)$，最坏情况为参与排序的元素原本有序，平均时间复杂度为$O(nlog_2n)$。</p>
<h2 id="归并排序"><a href="#归并排序" class="headerlink" title="归并排序"></a>归并排序</h2><p>归并排序是运用分治思想的算法。归并将两个或多个已排序序列合并成为一个按值排序的序列。<br>归并排序的平均时间复杂度为$O(nlog_2n)$<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">9, 4, | 7, 20, | 16,  3, | 18</span><br><span class="line">4, 9,   7, 20,    3, 16,   18</span><br><span class="line">4, 9,   7, 20, |  3, 16,   18</span><br><span class="line">3, 4,   7,  9,   16, 18,   20</span><br></pre></td></tr></table></figure></p>
<h2 id="堆排序"><a href="#堆排序" class="headerlink" title="堆排序"></a>堆排序</h2><h3 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h3><p>堆数据结构是一种数组对象，可以将其看成一颗完全二叉树。堆分为最大堆和最小堆，最小堆的最小元素是根结点，最大堆的最大元素是其根结点。</p>
<h3 id="堆排序算法"><a href="#堆排序算法" class="headerlink" title="堆排序算法"></a>堆排序算法</h3><p>最大堆的根结点是最大值，堆排序的核心思想也是利用了堆结构的这一特性。对待排序数组进行建堆操作，使其数组中元素排列复合最大堆特性。每次取堆的最大值，再调整堆结构，直至堆的大小为2结束。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">4 9 7 20 3 16 18</span><br><span class="line">20 9 18 4 3 16 7</span><br><span class="line">18 9 16 4 3 7 20</span><br><span class="line">16 9 7 4 3 18 20</span><br><span class="line">9 4 7 3 16 18 20</span><br><span class="line">7 4 3 9 16 18 20</span><br><span class="line">4 3 7 9 16 18 20</span><br><span class="line">3 4 7 9 16 18 20</span><br></pre></td></tr></table></figure></p>
<p>堆排序的时间复杂度为$O(nlog_2n)$<br>堆排序是非稳定排序</p>
<h2 id="希尔排序"><a href="#希尔排序" class="headerlink" title="希尔排序"></a>希尔排序</h2><p>希尔排序是一种非稳定排序，希尔排序不适合链表结构。<br>希尔排序的主要思想：确定一个元素间隔数gap，将参与排序的元素从第一个元素开始按照间隔一次分成多个子序列，分别将所有位置相隔gap的元素看成一个子序列。对各个子序列排序，再缩小gap的值，重新按照新的gap划分数组，再对每个子序列排序，直到gap递减为1。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">        3, 7, 5, 1, 12, 10, 8, 9</span><br><span class="line">gap=4   3, 7, 5, 1, 12, 10, 8, 9</span><br><span class="line">gap=2   3, 1, 5, 7,  8,  9,12,10</span><br><span class="line">gap=1   1, 3, 5, 7,  8,  9,10,12</span><br></pre></td></tr></table></figure></p>
<h2 id="计数排序"><a href="#计数排序" class="headerlink" title="计数排序"></a>计数排序</h2><p>计数排序是一种稳定排序，当待排序数组中有大量重复的数值并且这些数值较为集中时，使用计数排序算法较有优势。</p>
<h2 id="基数排序"><a href="#基数排序" class="headerlink" title="基数排序"></a>基数排序</h2><p>基数排序的主要思想：如果参加排序的元素具有d位，将元素先按最低位的值进行派位，如后按最次低位的值进行排序……最后进行最高位的排序。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">初始   个位   十位   百位</span><br><span class="line">329    463    329    329</span><br><span class="line">568    564    839    463</span><br><span class="line">839 -&gt; 568 -&gt; 463 -&gt; 564 </span><br><span class="line">463    329    564    568</span><br><span class="line">564    839    568    839</span><br></pre></td></tr></table></figure></p>
<h2 id="桶排序"><a href="#桶排序" class="headerlink" title="桶排序"></a>桶排序</h2><p>桶排序将数组中的数据分组，将分好的组分别放在一个个的”桶”中，然后对每个桶中的数据再进行排序。对”桶”内部的排序，可以使用插入排序、冒泡排序或快速排序等排序方法。<br>桶排序数组中的数据满足以下两点：</p>
<ol>
<li>均匀分布。输入数据需要均匀分布再一个给定的范围内。基于这种分配，算法创建n个桶来平分输入数据。</li>
<li>有序散列函数。桶必须是有序的。即，排在前面的桶中的所有数据必须小于后面桶的中的所有数据。</li>
</ol>
<h2 id="排序算法对比和选择"><a href="#排序算法对比和选择" class="headerlink" title="排序算法对比和选择"></a>排序算法对比和选择</h2><h3 id="排序算法时间复杂度、空间复杂度、算法稳定性"><a href="#排序算法时间复杂度、空间复杂度、算法稳定性" class="headerlink" title="排序算法时间复杂度、空间复杂度、算法稳定性"></a>排序算法时间复杂度、空间复杂度、算法稳定性</h3><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">算法名称</th>
<th style="text-align:center">最好时间复杂度</th>
<th style="text-align:center">平均时间复杂度</th>
<th style="text-align:center">最坏时间复杂度</th>
<th style="text-align:center">空间复杂度</th>
<th style="text-align:center">算法稳定性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">插入排序</td>
<td style="text-align:center">$O(n)$</td>
<td style="text-align:center">$O(n^2)$</td>
<td style="text-align:center">$O(n^2)$</td>
<td style="text-align:center">$O(1)$</td>
<td style="text-align:center">稳定</td>
</tr>
<tr>
<td style="text-align:center">冒泡排序</td>
<td style="text-align:center">$O(n)$</td>
<td style="text-align:center">$O(n^2)$</td>
<td style="text-align:center">$O(n^2)$</td>
<td style="text-align:center">$O(1)$</td>
<td style="text-align:center">稳定</td>
</tr>
<tr>
<td style="text-align:center">选择排序</td>
<td style="text-align:center">$O(n^2)$</td>
<td style="text-align:center">$O(n^2)$</td>
<td style="text-align:center">$O(n^2)$</td>
<td style="text-align:center">$O(1)$</td>
<td style="text-align:center">不稳定</td>
</tr>
<tr>
<td style="text-align:center">快速排序</td>
<td style="text-align:center">$O(nlog_2n)$</td>
<td style="text-align:center">$O(nlog_2n)$</td>
<td style="text-align:center">$O(n^2)$</td>
<td style="text-align:center">$O(log_2n)$</td>
<td style="text-align:center">不稳定</td>
</tr>
<tr>
<td style="text-align:center">归并排序</td>
<td style="text-align:center">$O(nlog_2n)$</td>
<td style="text-align:center">$O(nlog_2n)$</td>
<td style="text-align:center">$O(nlog_2n)$</td>
<td style="text-align:center">$O(n)$</td>
<td style="text-align:center">稳定</td>
</tr>
<tr>
<td style="text-align:center">堆排序</td>
<td style="text-align:center">$O(nlog_2n)$</td>
<td style="text-align:center">$O(nlog_2n)$</td>
<td style="text-align:center">$O(nlog_2n)$</td>
<td style="text-align:center">$O(1)$</td>
<td style="text-align:center">不稳定</td>
</tr>
<tr>
<td style="text-align:center">希尔排序</td>
<td style="text-align:center">O(n^1.3)</td>
<td style="text-align:center">$O(nlog_2n)$</td>
<td style="text-align:center">$O(n^2)$</td>
<td style="text-align:center">$O(1)$</td>
<td style="text-align:center">不稳定</td>
</tr>
<tr>
<td style="text-align:center">计数排序</td>
<td style="text-align:center">$O(n)$</td>
<td style="text-align:center">$O(n)$</td>
<td style="text-align:center">$O(n)$</td>
<td style="text-align:center">$O(n)$</td>
<td style="text-align:center">稳定</td>
</tr>
<tr>
<td style="text-align:center">基数排序</td>
<td style="text-align:center">$O(d(n+w))$</td>
<td style="text-align:center">$O(d(n+w))$</td>
<td style="text-align:center">$O(d(n+w))$</td>
<td style="text-align:center">$O(n+w)$</td>
<td style="text-align:center">稳定</td>
</tr>
<tr>
<td style="text-align:center">桶排序</td>
<td style="text-align:center">$O(n)$</td>
<td style="text-align:center">$O(n)$</td>
<td style="text-align:center">$O(n)$</td>
<td style="text-align:center">$O(n)$</td>
<td style="text-align:center">稳定</td>
</tr>
</tbody>
</table>
</div>
<h3 id="排序算法选择标准"><a href="#排序算法选择标准" class="headerlink" title="排序算法选择标准"></a>排序算法选择标准</h3><ol>
<li>通常情况下，输入数据是随机的，快速排序、归并排序、希尔排序和堆排序的运行速度较快。其中堆排序是原地排序最节省空间，快速排序的速度是最快的。在内存空间不紧张的情况下，一般采用快速排序，如需节省空间则采用堆排序，希尔排序不适合用在链表数据结构上。</li>
<li>待排序数据规模不大而且一开始就局部有序，插入排序和冒泡排序的运行时间最快，为$O(n)$，一般采用这两种排序算法。</li>
<li>从待排序数据规模考虑：规模小，采用简单排序算法合适，整体性能高；规模大，采用改进型的算法比较合适。因为规模小时$n^2$和$log_2n$差异小，而简单算法实现比较容易。</li>
</ol>
<h2 id="C-代码实现"><a href="#C-代码实现" class="headerlink" title="C++代码实现"></a>C++代码实现</h2><p><a href="https://github.com/CaseZheng/Study/blob/master/Algorithm/Sort/main.cpp" target="_blank" rel="noopener">github代码 https://github.com/CaseZheng</a><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stack&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt; </span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PrintVec</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;vec)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> x : vec)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;x&lt;&lt;<span class="string">" "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(vec.size()&gt;<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InsertSort</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;vec)</span>   <span class="comment">//插入排序</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(vec.size() &lt;= <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>; i&lt;vec.size(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> tmpIndex = i;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;i; ++j)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(vec[j] &gt; vec[i])</span><br><span class="line">            &#123;</span><br><span class="line">                tmpIndex = j;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> tmpValue = vec[i];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=i; j&gt;tmpIndex; --j)</span><br><span class="line">        &#123;</span><br><span class="line">            vec[j] = vec[j<span class="number">-1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        vec[tmpIndex] = tmpValue;</span><br><span class="line">        <span class="comment">//PrintVec(vec);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Swap</span><span class="params">(<span class="keyword">int</span> &amp;a, <span class="keyword">int</span> &amp;b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> tmp = a;</span><br><span class="line">    a = b;</span><br><span class="line">    b = tmp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BubbleSinkSort</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;vec)</span>   <span class="comment">//冒泡排序（下沉）</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(vec.size() &lt;= <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=vec.size()<span class="number">-1</span>; i&gt;<span class="number">0</span>; --i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">bool</span> flag = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">int</span> end = vec.size()<span class="number">-1</span>-i;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=vec.size()<span class="number">-1</span>; j&gt;end; --j)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(vec[j] &lt; vec[j<span class="number">-1</span>])</span><br><span class="line">            &#123;</span><br><span class="line">                Swap(vec[j], vec[j<span class="number">-1</span>]);</span><br><span class="line">                flag = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!flag)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//PrintVec(vec);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BubbleFloatSort</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;vec)</span>   <span class="comment">//冒泡排序（上浮）</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(vec.size() &lt;= <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;vec.size(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">bool</span> flag = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">int</span> end = vec.size()<span class="number">-1</span>-i;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;end; ++j)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(vec[j] &gt; vec[j+<span class="number">1</span>])</span><br><span class="line">            &#123;</span><br><span class="line">                Swap(vec[j], vec[j+<span class="number">1</span>]);</span><br><span class="line">                flag = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!flag)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//PrintVec(vec);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SelectionSort</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;vec)</span>        <span class="comment">//选择排序</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(vec.size() &lt;= <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;vec.size(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> minValue = vec[i];</span><br><span class="line">        <span class="keyword">int</span> minIndex = i;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=i+<span class="number">1</span>; j&lt;vec.size(); ++j)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(vec[j] &lt; minValue)</span><br><span class="line">            &#123;</span><br><span class="line">                minValue = vec[j];</span><br><span class="line">                minIndex = j;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Swap(vec[i], vec[minIndex]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Partition</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;vec, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(l&gt;r)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> l;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> position;</span><br><span class="line">    <span class="keyword">int</span> index = r;</span><br><span class="line">    <span class="keyword">int</span> tmpValue = vec[index];</span><br><span class="line">    <span class="keyword">while</span>(l&lt;r)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(l&lt;r &amp;&amp; vec[l]&lt;tmpValue) ++l;   <span class="comment">//从左边向右找一个大于tmpValue的下标l</span></span><br><span class="line">        <span class="keyword">while</span>(l&lt;r &amp;&amp; vec[r]&gt;=tmpValue) --r;  <span class="comment">//从右边向左找一个小于tmpValue的下标r</span></span><br><span class="line">        <span class="keyword">if</span>(l&lt;r)</span><br><span class="line">        &#123;</span><br><span class="line">            Swap(vec[l], vec[r]);           <span class="comment">//交换两个值</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Swap(vec[l], vec[index]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//PrintVec(vec);</span></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">QuickSort_Recursion</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;vec, <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> position = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(l&lt;r)</span><br><span class="line">    &#123;</span><br><span class="line">        position = Partition(vec, l, r);</span><br><span class="line">        QuickSort_Recursion(vec, l, position<span class="number">-1</span>);</span><br><span class="line">        QuickSort_Recursion(vec, position+<span class="number">1</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">QuickSort_Recursion</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;vec)</span>    <span class="comment">//快速排序（递归）</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(vec.size() &lt;= <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    QuickSort_Recursion(vec, <span class="number">0</span>, vec.size()<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">QuickSort</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;vec)</span>            <span class="comment">//快速排序（迭代）</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(vec.size() &lt;= <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> l = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> r = vec.size()<span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">stack</span>&lt;<span class="keyword">int</span>&gt; st;</span><br><span class="line">    st.push(l);</span><br><span class="line">    st.push(r);</span><br><span class="line">    <span class="keyword">while</span>(!st.empty())</span><br><span class="line">    &#123;</span><br><span class="line">        r = st.top(); st.pop();</span><br><span class="line">        l = st.top(); st.pop();</span><br><span class="line">        <span class="keyword">if</span>(l &gt;= r)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> position = Partition(vec, l, r);</span><br><span class="line">        st.push(l); </span><br><span class="line">        st.push(position<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        st.push(position+<span class="number">1</span>);</span><br><span class="line">        st.push(r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Merge</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;va, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;vb, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;vec)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vec.clear();</span><br><span class="line">    <span class="keyword">if</span>(va.empty())</span><br><span class="line">    &#123;</span><br><span class="line">        vec = vb;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(vb.empty())</span><br><span class="line">    &#123;</span><br><span class="line">        vec = va;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> b = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(a &lt; va.size() &amp;&amp; b &lt; vb.size())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(va[a] &lt; vb[b])</span><br><span class="line">            &#123;</span><br><span class="line">                vec.push_back(va[a++]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">            &#123;</span><br><span class="line">                vec.push_back(vb[b++]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(a &lt; va.size())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(; a&lt;va.size(); ++a)</span><br><span class="line">            &#123;</span><br><span class="line">                vec.push_back(va[a]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(b &lt; vb.size())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(; b&lt;vb.size(); ++b)</span><br><span class="line">            &#123;</span><br><span class="line">                vec.push_back(vb[b]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MergeSort_Recursion</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;vec)</span>  <span class="comment">//归并排序（递归）</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(vec.size() &lt;= <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; va;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; vb;</span><br><span class="line">    <span class="keyword">int</span> mod = vec.size()/<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;vec.size(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(i&lt;mod)</span><br><span class="line">        &#123;</span><br><span class="line">            va.push_back(vec[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">            vb.push_back(vec[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    MergeSort_Recursion(va);</span><br><span class="line">    MergeSort_Recursion(vb);</span><br><span class="line">    Merge(va, vb, vec);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Merge</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;vec, <span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> z)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; va;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; vb;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=x; i&lt;y; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        va.push_back(vec[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=y; i&lt;z; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        vb.push_back(vec[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; vc;</span><br><span class="line">    <span class="keyword">if</span>(va.empty())</span><br><span class="line">    &#123;</span><br><span class="line">        vc = vb;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(vb.empty())</span><br><span class="line">    &#123;</span><br><span class="line">        vc = va;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> b = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(a &lt; va.size() &amp;&amp; b &lt; vb.size())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(va[a] &lt; vb[b])</span><br><span class="line">            &#123;</span><br><span class="line">                vc.push_back(va[a++]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">            &#123;</span><br><span class="line">                vc.push_back(vb[b++]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(a &lt; va.size())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(; a&lt;va.size(); ++a)</span><br><span class="line">            &#123;</span><br><span class="line">                vc.push_back(va[a]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(b &lt; vb.size())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(; b&lt;vb.size(); ++b)</span><br><span class="line">            &#123;</span><br><span class="line">                vc.push_back(vb[b]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=x; i&lt;z; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        vec[i] = vc[i-x];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">min</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (a&lt;b ? a : b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MergeSort</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;vec)</span>            <span class="comment">//归并排序（迭代）</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(vec.size() &lt;= <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>; i&lt;vec.size(); i*=<span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> offset = i+i;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;vec.size(); j+=offset)</span><br><span class="line">        &#123;</span><br><span class="line">            Merge(vec, j, min(j+i, vec.size()), min(j+offset, vec.size())); </span><br><span class="line">            <span class="comment">//cout&lt;&lt;j&lt;&lt;" "&lt;&lt;min(j+i, vec.size())&lt;&lt;" "&lt;&lt;min(j+offset, vec.size())&lt;&lt;endl;</span></span><br><span class="line">            <span class="comment">//PrintVec(vec);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">KeepHead</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;vec, <span class="keyword">int</span> len, <span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> left = <span class="number">2</span>*i+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> right = <span class="number">2</span>*i+<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> largest = i;</span><br><span class="line">    <span class="keyword">if</span>(left&lt;len &amp;&amp; vec[left]&gt;vec[i])</span><br><span class="line">    &#123;</span><br><span class="line">        largest = left;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(right&lt;len &amp;&amp; vec[right]&gt;vec[largest])</span><br><span class="line">    &#123;</span><br><span class="line">        largest = right;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(largest != i)</span><br><span class="line">    &#123;</span><br><span class="line">        Swap(vec[i], vec[largest]);</span><br><span class="line">        KeepHead(vec, len, largest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BuildHeap</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;vec)</span>                <span class="comment">//建堆</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(vec.size() &lt; <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> i = vec.size()/<span class="number">2</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">while</span>(i&gt;=<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        KeepHead(vec, vec.size(), i);</span><br><span class="line">        --i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HeapSort</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;vec)</span>                 <span class="comment">//堆排序</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BuildHeap(vec);</span><br><span class="line">    <span class="keyword">int</span> heap_size = vec.size();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=vec.size()<span class="number">-1</span>; i&gt;<span class="number">0</span>; --i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//PrintVec(vec);</span></span><br><span class="line">        Swap(vec[<span class="number">0</span>], vec[i]);</span><br><span class="line">        --heap_size;</span><br><span class="line">        KeepHead(vec, heap_size, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CountingSort</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;vec)</span>             <span class="comment">//计数排序</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(vec.size() &lt; <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> maxValue = vec[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">int</span> minValue = vec[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> x : vec)</span><br><span class="line">    &#123;</span><br><span class="line">        maxValue = x&gt;maxValue ? x : maxValue;</span><br><span class="line">        minValue = x&lt;minValue ? x : minValue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">c</span><span class="params">(maxValue-minValue+<span class="number">1</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> x : vec)</span><br><span class="line">    &#123;</span><br><span class="line">        ++c[x-minValue];        <span class="comment">//统计vec各元素出现的次数</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>; i&lt;=maxValue-minValue; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        c[i] += c[i<span class="number">-1</span>];         <span class="comment">//分布值计算</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">s</span><span class="params">(vec.size(), <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=vec.size()<span class="number">-1</span>; i&gt;=<span class="number">0</span>; --i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> j = vec[i] - minValue;</span><br><span class="line">        s[c[j]<span class="number">-1</span>] = vec[i];</span><br><span class="line">        --c[j];</span><br><span class="line">    &#125;</span><br><span class="line">    vec = s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ShellSort</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;vec)</span>                <span class="comment">//希尔排序 </span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(vec.size() &lt; <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> i, j, flag, counter=<span class="number">1</span>, gap=vec.size();</span><br><span class="line">    <span class="keyword">int</span> temp;</span><br><span class="line">    <span class="keyword">while</span>(gap &gt; <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        gap = gap/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">do</span> </span><br><span class="line">        &#123;</span><br><span class="line">            flag = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;=vec.size()-gap-counter; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                j=i+gap;</span><br><span class="line">                <span class="keyword">if</span>(vec[i] &gt; vec[j])</span><br><span class="line">                &#123;</span><br><span class="line">                    Swap(vec[i], vec[j]);</span><br><span class="line">                    flag = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(counter &lt; vec.size() &amp;&amp; flag == <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; vecTest = &#123;<span class="number">4</span>, <span class="number">9</span>, <span class="number">7</span>, <span class="number">20</span>, <span class="number">3</span>, <span class="number">16</span>, <span class="number">18</span>&#125;;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; vec;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//cout&lt;&lt;"插入排序"&lt;&lt;endl         ; vec = vecTest ; PrintVec(vec) ; InsertSort(vec)          ; PrintVec(vec) ;</span></span><br><span class="line">    <span class="comment">//cout&lt;&lt;"冒泡排序（下沉）"&lt;&lt;endl ; vec = vecTest ; PrintVec(vec) ; BubbleSinkSort(vec)      ; PrintVec(vec) ;</span></span><br><span class="line">    <span class="comment">//cout&lt;&lt;"冒泡排序（上浮）"&lt;&lt;endl ; vec = vecTest ; PrintVec(vec) ; BubbleFloatSort(vec)     ; PrintVec(vec) ;</span></span><br><span class="line">    <span class="comment">//cout&lt;&lt;"选择排序"&lt;&lt;endl         ; vec = vecTest ; PrintVec(vec) ; SelectionSort(vec)       ; PrintVec(vec) ;</span></span><br><span class="line">    <span class="comment">//cout&lt;&lt;"快速排序（递归）"&lt;&lt;endl ; vec = vecTest ; PrintVec(vec) ; QuickSort_Recursion(vec) ; PrintVec(vec) ;</span></span><br><span class="line">    <span class="comment">//cout&lt;&lt;"快速排序（迭代）"&lt;&lt;endl ; vec = vecTest ; PrintVec(vec) ; QuickSort(vec)           ; PrintVec(vec) ;</span></span><br><span class="line">    <span class="comment">//cout&lt;&lt;"归并排序（递归）"&lt;&lt;endl ; vec = vecTest ; PrintVec(vec) ; MergeSort_Recursion(vec) ; PrintVec(vec) ;</span></span><br><span class="line">    <span class="comment">//cout&lt;&lt;"归并排序（迭代）"&lt;&lt;endl ; vec = vecTest ; PrintVec(vec) ; MergeSort(vec)           ; PrintVec(vec) ;</span></span><br><span class="line">    <span class="comment">//cout&lt;&lt;"计数排序"&lt;&lt;endl         ; vec = vecTest ; PrintVec(vec) ; CountingSort(vec)        ; PrintVec(vec) ;</span></span><br><span class="line">    <span class="comment">//cout&lt;&lt;"堆排序"&lt;&lt;endl           ; vec = vecTest ; PrintVec(vec) ; HeapSort(vec)            ; PrintVec(vec) ;</span></span><br><span class="line">    <span class="comment">//cout&lt;&lt;"希尔排序"&lt;&lt;endl         ; vec = vecTest ; PrintVec(vec) ; ShellSort(vec)           ; PrintVec(vec) ;</span></span><br><span class="line"></span><br><span class="line">    vecTest = &#123;<span class="number">49</span>, <span class="number">55</span>, <span class="number">25</span>, <span class="number">97</span>, <span class="number">60</span>, <span class="number">27</span>, <span class="number">49</span>, <span class="number">50</span>&#125; ;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//cout&lt;&lt;"快速排序（递归）"&lt;&lt;endl ; vec = vecTest ; PrintVec(vec) ; QuickSort_Recursion(vec) ; PrintVec(vec) ;</span></span><br><span class="line">    <span class="comment">//cout&lt;&lt;"快速排序（迭代）"&lt;&lt;endl ; vec = vecTest ; PrintVec(vec) ; QuickSort(vec)           ; PrintVec(vec) ;</span></span><br><span class="line">    <span class="comment">//cout&lt;&lt;"归并排序（递归）"&lt;&lt;endl ; vec = vecTest ; PrintVec(vec) ; MergeSort_Recursion(vec) ; PrintVec(vec) ;</span></span><br><span class="line">    <span class="comment">//cout&lt;&lt;"归并排序（迭代）"&lt;&lt;endl ; vec = vecTest ; PrintVec(vec) ; MergeSort(vec)           ; PrintVec(vec) ;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.casezheng.date/2018/01/12/algorithm-chart/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CaseZheng">
      <meta itemprop="description" content="CaseZheng的博客网站">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CaseZheng">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/01/12/algorithm-chart/" class="post-title-link" itemprop="url">算法 图相关知识</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-01-12 23:18:03" itemprop="dateCreated datePublished" datetime="2018-01-12T23:18:03+08:00">2018-01-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-12 12:56:36" itemprop="dateModified" datetime="2020-04-12T12:56:36+08:00">2020-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/基础/" itemprop="url" rel="index"><span itemprop="name">基础</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="算法——图"><a href="#算法——图" class="headerlink" title="算法——图"></a>算法——图</h1><h2 id="图结构"><a href="#图结构" class="headerlink" title="图结构"></a>图结构</h2><h3 id="图的基本概念"><a href="#图的基本概念" class="headerlink" title="图的基本概念"></a>图的基本概念</h3><p>图是由顶点的非空集合V(有n&gt;0个顶点组成)与边的集合E(顶点之间的关系)构成,常用G表示,可形式化定义如下:G=(V,E)<br>如果图中的边集E中每一条边都没有方向性,则该图为无向图；如果E中的边具有方向性,则表示该图为有向图。无序图的边表示为无序偶对(Vi, Vj), 所以(Vi, Vj)和(Vj, Vi)是同一条边。<br>有向图的表示的是顶点的有序偶对,边$\langle$Vi, Vj$\rangle$和$\langle$Vj, Vi$\rangle$是两条不一样的边。</p>
<ol>
<li>度<br>一个顶点的度指依附于某顶点V的边的条数，通常记为TD(V)</li>
<li>路径<br>顶点的路径是指一个顶点Vi到另一个顶点Vj之间所经过的存在边的顶点的序列。<br>举例来说，如果存在顶点序列 V1, V2, V3, V4, …, Vm，使得顶点偶对(Vi, Vi+1) $\in$ (i=1, 2, 3, …, m–1),则称该顶点序列为顶点V1到Vm之间的一条路径。如果V1=Vm，则该路径成为回路或环。</li>
<li>子图<br>图G=(V, E)和G’=(V’, E’)，如果存在V’$\in$V 且 E’ $\in$ E，则称G’为G的一个子图</li>
<li>图的连通<br>在无向图中，如果顶点Vi到Vj（i!=j)存在路径，则称Vi和Vj是连通的。如果某无向图中任意两个顶点都是连通的，则称该无向图是连通图，否则为非连通图。无向图中的极大连通子图为该图的连通分量。<br>在有向图中，如果任意两个不同的顶点都是连通的，则称该有向图为强连通图，其极大连通子图为强连通分量。<br><img src="/Picture/无向图和有向图.png" alt><br>无向图和有向图</li>
</ol>
<h3 id="图的存储结构"><a href="#图的存储结构" class="headerlink" title="图的存储结构"></a>图的存储结构</h3><p>图主要有邻接表存储结构和邻接矩阵存储结构两种。</p>
<h4 id="邻接矩阵存储"><a href="#邻接矩阵存储" class="headerlink" title="邻接矩阵存储"></a>邻接矩阵存储</h4><p>邻接矩阵存储(数组存储法),核心思想是使用两个数组存储一个图。具体定义如下：一个具有n个顶点的图，将每个顶点存储在数组Vertex[0…n-1]中，另定义一个二维数组E[0…n-1][0…n-1]存储相邻顶点见的关系，该二维矩阵称为邻接矩阵。<br>在数组Vertex中的下标来表示一个顶点，则邻接数组元素E[i][j]就表示Vi和Vj之间的关系，如果存在边，则为1，如不存在则为0。<br>无向图的矩阵是一个对称矩阵，矩阵中的值表示两者之间有直接边可到达。如果是有权图则数组存储权值，无边的顶点之间权值为$\infty$.<br>邻接矩阵不适合存储稀疏图，会有很多存储空间是空值，浪费空间。</p>
<p>图a使用邻接矩阵表示:<br><img src="/Picture/图的邻接矩阵存储.png" alt><br>图的邻接矩阵存储</p>
<h4 id="邻接表存储"><a href="#邻接表存储" class="headerlink" title="邻接表存储"></a>邻接表存储</h4><p>邻接表存储利用链表的优势，解决了邻接矩阵不适合存储稀疏图的问题。<br>邻接表存储法为每个顶点建立一条线性链表，如果图中有n个顶点，则其邻接表结构有n个线性表组成，每个链表设置一个头结点，称为顶点结点。<br>每一个链表中的结点称为边结点。</p>
<p>图b使用邻接表表示:<br><img src="/Picture/图的邻接表存储.png" alt><br>图的邻接表存储</p>
<h2 id="图的遍历"><a href="#图的遍历" class="headerlink" title="图的遍历"></a>图的遍历</h2><h3 id="深度优先遍历"><a href="#深度优先遍历" class="headerlink" title="深度优先遍历"></a>深度优先遍历</h3><p>图的深度优先遍历（Deepth First Search，DFS），从顶点v出发，首先将顶点v自己标记为已到达顶点，然后选择一个和v邻近的顶点u，如果u不存在则停止遍历，如果顶点存在则将u顶点标记为已到达，选择一个顶点u的未到达顶点w开始新一轮DFS。</p>
<h3 id="广度优先遍历"><a href="#广度优先遍历" class="headerlink" title="广度优先遍历"></a>广度优先遍历</h3><p>图的广度优先遍历，从顶点v出发，访问v之后依次访问v的各个未被访问的邻接点，然后从这些邻接点出发访问其它未被访问过的点，直到所有点访问完成。</p>
<p><a href="https://github.com/CaseZheng/Study/tree/master/Algorithm/Chart" target="_blank" rel="noopener">示例代码 <strong>https://github.com/CaseZheng/Study/tree/master/Algorithm/Chart</strong></a></p>
<h1 id="图的高级算法"><a href="#图的高级算法" class="headerlink" title="图的高级算法"></a>图的高级算法</h1><h2 id="拓扑排序"><a href="#拓扑排序" class="headerlink" title="拓扑排序"></a>拓扑排序</h2><p>拓扑排序是有向无环图的重要应用，将单向连接的事件按照其关系方向排列成一个具有先后顺序的线性结构。</p>
<ol>
<li>偏序。偏序是一种<strong>非自反性</strong>的传递关系。用R表示元素间的关系，偏序的定义是非自反性，即不存在sRs的关系，如果sRt表示存在s到t的关系R，则必不存在tRs，说明<strong>偏序具有非对称性</strong>。如果存在关系sRt，tRu，则必存在sRu，说明<strong>偏序具有关系传递性</strong>。拓扑排序是在有向无环图这种偏序关系上的一种算法。</li>
<li>全序。全序关系T是一个偏序，并且对于集合中所有的元素s$\neq$t，sTt和tTs只能取其一。</li>
<li>有向无环图（DAG图）。一种特殊的有向图，从该图的任一结点出发，经过若干条边，无法回到该顶点。这样的图是无环的。</li>
</ol>
<p>拓扑排序是在有向无环图上进行的操作，对于一个有向无环图G，拓扑排序将图G的所有顶点排成一个线性序列，使图中任意一对顶点v和u，满足如果图中存在关系v-&gt;u，则排序后顶点v必在u的左边。<br><img src="/Picture/DAG.png" alt></p>
<p><a href="https://github.com/CaseZheng/Study/tree/master/Algorithm/Chart" target="_blank" rel="noopener">示例代码 <strong>https://github.com/CaseZheng/Study/tree/master/Algorithm/Chart</strong></a></p>
<h2 id="最小生成树"><a href="#最小生成树" class="headerlink" title="最小生成树"></a>最小生成树</h2><p>算法描述：最小生成树是指在一个具有N个顶点的带权连通图G中，如果存在某个子图G’,其包含图G的所有顶点和一部分边，且不形成回路，并且子图G’的个边权值最小，则称图G’是图G的最小生成树。</p>
<h3 id="最小生成树-1"><a href="#最小生成树-1" class="headerlink" title="最小生成树"></a>最小生成树</h3><ol>
<li>最小生成树不能有环</li>
<li>最小生成树不一定唯一，在一个图中最小生成树可以有一个或多个</li>
<li>最小生成树边的个数等于顶点数减一，即|E|=|V|-1</li>
<li>最小生成树的边的权值最小</li>
</ol>
<h3 id="Kruskal算法"><a href="#Kruskal算法" class="headerlink" title="Kruskal算法"></a>Kruskal算法</h3><p>核心思想：在带权连通图中，不断地在边集中找到最小的边，如果该边满足得到最小生成树的条件，就将其构造，直到最后得到一颗最小生成树。</p>
<h3 id="Prim算法"><a href="#Prim算法" class="headerlink" title="Prim算法"></a>Prim算法</h3><p>核心思想：在带权连通图中，图的顶点集合为V，从图中某个顶点v开始，得到集合U={v},重复执行下述操作：在所有u$\in$U,w$\in$V-E的边(u,w)$\in$E中找到最小的边，将(u,w)这条边加入到已找到的边集合，并将点w加入到集合U中，当U=C时，就找到了最小生成树。</p>
<h1 id="参考书籍"><a href="#参考书籍" class="headerlink" title="参考书籍"></a>参考书籍</h1><ol>
<li>妙趣横生的算法（C++语言实现）</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.casezheng.date/2017/12/31/rc-local/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CaseZheng">
      <meta itemprop="description" content="CaseZheng的博客网站">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CaseZheng">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/12/31/rc-local/" class="post-title-link" itemprop="url">linux添加开机启动任务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-12-31 00:40:00" itemprop="dateCreated datePublished" datetime="2017-12-31T00:40:00+08:00">2017-12-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-12 12:56:36" itemprop="dateModified" datetime="2020-04-12T12:56:36+08:00">2020-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="linxu添加开启启动任务"><a href="#linxu添加开启启动任务" class="headerlink" title="linxu添加开启启动任务"></a>linxu添加开启启动任务</h1><p>本机为fedora 26</p>
<p>先创建rc.local文件，编辑rc.local<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo touch /etc/rc.d/rc.local</span><br><span class="line">sudo vim /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure></p>
<p>写入执行脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">cd /home/CaseZheng/CaseZhengBlog &amp;&amp; nohup hexo serve &amp;</span><br></pre></td></tr></table></figure></p>
<p>给予执行权限<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure></p>
<p>执行下面的命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable rc-local.service</span><br></pre></td></tr></table></figure></p>
<p>如果报错，编辑rc-local.service<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /usr/lib/systemd/system/rc-local.service</span><br></pre></td></tr></table></figure></p>
<p>在最后面加入下列内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure></p>
<p>再执行命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable rc-local.service</span><br></pre></td></tr></table></figure></p>
<p>然后重启<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure></p>
<p>使用systemctl查看rc-local.service状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@localhost CaseZhengBlog]$ sudo systemctl status rc-local.service</span><br><span class="line">● rc-local.service - /etc/rc.d/rc.local Compatibility</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/rc-local.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Sat 2017-12-30 23:45:57 CST; 1h 3min ago</span><br><span class="line">    Tasks: 11 (limit: 4915)</span><br><span class="line">   CGroup: /system.slice/rc-local.service</span><br><span class="line">           ├─852 /bin/bash /etc/rc.d/rc.local start</span><br><span class="line">           └─859 hexo</span><br></pre></td></tr></table></figure></p>
<p>如有错误会有报错信息</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.casezheng.date/2017/10/31/mysql-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CaseZheng">
      <meta itemprop="description" content="CaseZheng的博客网站">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CaseZheng">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/10/31/mysql-3/" class="post-title-link" itemprop="url">MySQL SQL语句基础</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-10-31 22:56:00" itemprop="dateCreated datePublished" datetime="2017-10-31T22:56:00+08:00">2017-10-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2018-03-21 19:55:00" itemprop="dateModified" datetime="2018-03-21T19:55:00+08:00">2018-03-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>SQL语句基础知识的复习与学习</p>
<h1 id="SQL简介"><a href="#SQL简介" class="headerlink" title="SQL简介"></a>SQL简介</h1><p>SQL是Structure Query Language（结构化查询语言）的缩写，使用关系数据模型的数据库应用语言。</p>
<h1 id="SQL分类"><a href="#SQL分类" class="headerlink" title="SQL分类"></a>SQL分类</h1><p>SQL语句主要分为3类</p>
<h2 id="DDL（Data-Definition-Language）数据定义语句"><a href="#DDL（Data-Definition-Language）数据定义语句" class="headerlink" title="DDL（Data Definition Language）数据定义语句"></a>DDL（Data Definition Language）数据定义语句</h2><p>定义不同的数据段、数据库、数据表、列、索引等数据库对象的定义。常用关键字：create、drop、alter等。</p>
<h2 id="DML（Data-Manipulation-Language）数据操纵语句"><a href="#DML（Data-Manipulation-Language）数据操纵语句" class="headerlink" title="DML（Data Manipulation Language）数据操纵语句"></a>DML（Data Manipulation Language）数据操纵语句</h2><p>用于添加、删除、更新和查询数据库记录，并检查数据完整性，常用的语句关键词主要包括insert、delete、update和select等。</p>
<h2 id="DCL（Data-Control-Language）数据控制语句"><a href="#DCL（Data-Control-Language）数据控制语句" class="headerlink" title="DCL（Data Control Language）数据控制语句"></a>DCL（Data Control Language）数据控制语句</h2><p>用于控制不同数据段直接的许可和访问级别的语句。定义了数据库、表、字段、用户的访问权限和安全级别，主要的关键字包括grant、revoke等。</p>
<h1 id="DDL"><a href="#DDL" class="headerlink" title="DDL"></a>DDL</h1><p>DDL是数据定义语言的缩写，是对数据库内部的对象进行创建、删除、修改的操作语言。和DML语言的最大区别是DML只对表内部的操作，而不涉及表的定义、结构的修改，更不会涉及到其他对象。DDL语句更多被数据库管理员（DBA）所使用。</p>
<h2 id="数据库创建"><a href="#数据库创建" class="headerlink" title="数据库创建"></a>数据库创建</h2><p>create database dbname;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">+--------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; create database test;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test               |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h2 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h2><p>drop database dbname;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [information_schema]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test               |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [information_schema]&gt; drop database test;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [information_schema]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">+--------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h2 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h2><p>create table tablename(column_name_1 column_type_1 constraints, column_name_2 column_type_2 constraints, … … , column_name_n column_type_n constraints)<br>MySQL的表名以目录形式存在磁盘上，表名的字符可以使用任何目录名允许的字符。column_name是列的名字，column_type是列的数据类型，contraints是列的约束条件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; create table student(name char(32), age int(4), sex int(2));</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; show tables;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_test |</span><br><span class="line">+----------------+</span><br><span class="line">| student        |</span><br><span class="line">+----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; desc student;</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">| Field | Type     | Null | Key | Default | Extra |</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">| name  | char(32) | YES  |     | NULL    |       |</span><br><span class="line">| age   | int(4)   | YES  |     | NULL    |       |</span><br><span class="line">| sex   | int(2)   | YES  |     | NULL    |       |</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; show create table student\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       Table: student</span><br><span class="line">Create Table: CREATE TABLE `student` (</span><br><span class="line">  `name` char(32) DEFAULT NULL,</span><br><span class="line">  `age` int(4) DEFAULT NULL,</span><br><span class="line">  `sex` int(2) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=latin1</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h2 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h2><p>drop table tablename;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; drop table student;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; show tables;</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h2 id="修改表"><a href="#修改表" class="headerlink" title="修改表"></a>修改表</h2><p>表结构的修改一般使用alter table语句。</p>
<h3 id="修改表类型"><a href="#修改表类型" class="headerlink" title="修改表类型"></a>修改表类型</h3><p>alter table tablename modify [column] column_definition [first | after col_name]<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; desc student;</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">| Field | Type     | Null | Key | Default | Extra |</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">| name  | char(32) | YES  |     | NULL    |       |</span><br><span class="line">| age   | int(4)   | YES  |     | NULL    |       |</span><br><span class="line">| sex   | int(2)   | YES  |     | NULL    |       |</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line">MariaDB [test]&gt; alter table student modify age int(2);</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; desc student;</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">| Field | Type     | Null | Key | Default | Extra |</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">| name  | char(32) | YES  |     | NULL    |       |</span><br><span class="line">| age   | int(2)   | YES  |     | NULL    |       |</span><br><span class="line">| sex   | int(2)   | YES  |     | NULL    |       |</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="新增表字段"><a href="#新增表字段" class="headerlink" title="新增表字段"></a>新增表字段</h3><p>alter table tablename add [column] column_definition [first | after col_name]<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; alter table student add birthday date;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; desc student;</span><br><span class="line">+----------+----------+------+-----+---------+-------+</span><br><span class="line">| Field    | Type     | Null | Key | Default | Extra |</span><br><span class="line">+----------+----------+------+-----+---------+-------+</span><br><span class="line">| name     | char(32) | YES  |     | NULL    |       |</span><br><span class="line">| age      | int(2)   | YES  |     | NULL    |       |</span><br><span class="line">| sex      | int(2)   | YES  |     | NULL    |       |</span><br><span class="line">| birthday | date     | YES  |     | NULL    |       |</span><br><span class="line">+----------+----------+------+-----+---------+-------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="删除表字段"><a href="#删除表字段" class="headerlink" title="删除表字段"></a>删除表字段</h3><p>alter table tablename drop [column] column_name;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; alter table student drop column birthday;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; desc student;</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">| Field | Type     | Null | Key | Default | Extra |</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">| name  | char(32) | YES  |     | NULL    |       |</span><br><span class="line">| age   | int(2)   | YES  |     | NULL    |       |</span><br><span class="line">| sex   | int(2)   | YES  |     | NULL    |       |</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="字段改名"><a href="#字段改名" class="headerlink" title="字段改名"></a>字段改名</h3><p>alter table tablename change [column] old_col_name column_definition [first | after col_name]<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; alter table student change sex grade int(4);</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; desc student;</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">| Field | Type     | Null | Key | Default | Extra |</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">| name  | char(32) | YES  |     | NULL    |       |</span><br><span class="line">| age   | int(2)   | YES  |     | NULL    |       |</span><br><span class="line">| grade | int(4)   | YES  |     | NULL    |       |</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">3 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p><strong>change和modify都可以修改表定义，但change后面需要写两次列名，不方便。不过change的优点是可以修改列名称，modify则不能。</strong></p>
<h3 id="修改字段排列顺序"><a href="#修改字段排列顺序" class="headerlink" title="修改字段排列顺序"></a>修改字段排列顺序</h3><p>字段增加和修改(add/change/modify)中，都有可选项first|after column_name，该选项可以修改字段在表中的位置，默认add增加新字段加再表的最后位置，而change/modify默认不该表字段位置。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; alter table student add sex int(2) after name;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; desc student;</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">| Field | Type     | Null | Key | Default | Extra |</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">| name  | char(32) | YES  |     | NULL    |       |</span><br><span class="line">| sex   | int(2)   | YES  |     | NULL    |       |</span><br><span class="line">| age   | int(2)   | YES  |     | NULL    |       |</span><br><span class="line">| grade | int(4)   | YES  |     | NULL    |       |</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="表改名"><a href="#表改名" class="headerlink" title="表改名"></a>表改名</h3><p>alter table tablename rename [to] new_tablename;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; show tables;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_test |</span><br><span class="line">+----------------+</span><br><span class="line">| student        |</span><br><span class="line">+----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; alter table student rename to student_new;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; show tables;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_test |</span><br><span class="line">+----------------+</span><br><span class="line">| student_new    |</span><br><span class="line">+----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h1 id="DML"><a href="#DML" class="headerlink" title="DML"></a>DML</h1><p>DML操作是指对数据库中表记录的操作，主要包括表记录的插入(insert)、更新(update)、删除(delete)和查询(select)。</p>
<h2 id="插入记录"><a href="#插入记录" class="headerlink" title="插入记录"></a>插入记录</h2><p>insert into tablename (field1, field2, ……, fieldn) values(value1, value2, ……, valuen);<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; insert into student (name, sex, age) values(&quot;haha&quot;, 1, 10);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select * from student;</span><br><span class="line">+------+------+------+-------+</span><br><span class="line">| name | sex  | age  | grade |</span><br><span class="line">+------+------+------+-------+</span><br><span class="line">| haha |    1 |   10 |  NULL |</span><br><span class="line">+------+------+------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>也可以不指定字段名称，但values的顺序要和字段排列顺序一致，且不能缺少任何一个。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; insert into student values(&quot;gaga&quot;, 2, 14, 1);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select * from student;</span><br><span class="line">+------+------+------+-------+</span><br><span class="line">| name | sex  | age  | grade |</span><br><span class="line">+------+------+------+-------+</span><br><span class="line">| haha |    1 |   10 |  NULL |</span><br><span class="line">| gaga |    2 |   14 |     1 |</span><br><span class="line">+------+------+------+-------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>在MySQL中insert语句可一次插入多条记录。在插入大量记录时，节省很多网络开销，大大提高插入效率。<br>insert into tablename (field1, field2, ……, fieldn)<br>values<br>(value1_1, value1_2, ……, value1_n),<br>(value2_1, value2_2, ……, value2_n),<br>… …<br>(valuen_1, valuen_2, ……, valuen_n);<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; insert into student (name, sex, grade) values</span><br><span class="line">    -&gt; (&quot;h1&quot;, 1, 3),</span><br><span class="line">    -&gt; (&quot;h3&quot;, 0, 4),</span><br><span class="line">    -&gt; (&quot;h5&quot;, 1, 5);</span><br><span class="line">Query OK, 3 rows affected (0.01 sec)</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select * from student;</span><br><span class="line">+------+------+------+-------+</span><br><span class="line">| name | sex  | age  | grade |</span><br><span class="line">+------+------+------+-------+</span><br><span class="line">| haha |    1 |   10 |  NULL |</span><br><span class="line">| gaga |    2 |   14 |     1 |</span><br><span class="line">| h1   |    1 | NULL |     3 |</span><br><span class="line">| h3   |    0 | NULL |     4 |</span><br><span class="line">| h5   |    1 | NULL |     5 |</span><br><span class="line">+------+------+------+-------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h2 id="更新记录"><a href="#更新记录" class="headerlink" title="更新记录"></a>更新记录</h2><p>update tablename set field1=value1, field2=value2, ……, fieldn=valuen [where condition];<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; update student set sex=0, grade=0 where name= &apos;haha&apos;;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select * from student;</span><br><span class="line">+------+------+------+-------+</span><br><span class="line">| name | sex  | age  | grade |</span><br><span class="line">+------+------+------+-------+</span><br><span class="line">| haha |    0 |   10 |     0 |</span><br><span class="line">| gaga |    2 |   14 |     1 |</span><br><span class="line">| h1   |    1 | NULL |     3 |</span><br><span class="line">| h3   |    0 | NULL |     4 |</span><br><span class="line">| h5   |    1 | NULL |     5 |</span><br><span class="line">+------+------+------+-------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>MySQL中update可以同时更新多个表中数据。<br>update t1, t2, ……, tn set t1.field1=expr1, t2.field2=expr2, ……,  tn.fieldn=exprn [where condition];<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; select * from home;</span><br><span class="line">+------+--------+</span><br><span class="line">| id   | addr   |</span><br><span class="line">+------+--------+</span><br><span class="line">|    1 | hhhhhh |</span><br><span class="line">|    2 | jjjjj  |</span><br><span class="line">+------+--------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select * from student;</span><br><span class="line">+------+------+------+-------+</span><br><span class="line">| name | sex  | age  | grade |</span><br><span class="line">+------+------+------+-------+</span><br><span class="line">| haha |    0 |   10 |     0 |</span><br><span class="line">| gaga |    2 |   14 |     1 |</span><br><span class="line">| h1   |    1 | NULL |     3 |</span><br><span class="line">| h3   |    0 | NULL |     4 |</span><br><span class="line">| h5   |    1 | NULL |     5 |</span><br><span class="line">+------+------+------+-------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; update student, home set student.grade=10, home.id=20 where student.name=&apos;haha&apos;;</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 3  Changed: 3  Warnings: 0</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select * from home;</span><br><span class="line">+------+--------+</span><br><span class="line">| id   | addr   |</span><br><span class="line">+------+--------+</span><br><span class="line">|   20 | hhhhhh |</span><br><span class="line">|   20 | jjjjj  |</span><br><span class="line">+------+--------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select * from student;</span><br><span class="line">+------+------+------+-------+</span><br><span class="line">| name | sex  | age  | grade |</span><br><span class="line">+------+------+------+-------+</span><br><span class="line">| haha |    0 |   10 |    10 |</span><br><span class="line">| gaga |    2 |   14 |     1 |</span><br><span class="line">| h1   |    1 | NULL |     3 |</span><br><span class="line">| h3   |    0 | NULL |     4 |</span><br><span class="line">| h5   |    1 | NULL |     5 |</span><br><span class="line">+------+------+------+-------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h2 id="删除记录"><a href="#删除记录" class="headerlink" title="删除记录"></a>删除记录</h2><p>delete from tablename [where condition];<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; select * from student;</span><br><span class="line">+------+------+</span><br><span class="line">| name | age  |</span><br><span class="line">+------+------+</span><br><span class="line">| haha |    1 |</span><br><span class="line">| hehe |    2 |</span><br><span class="line">| gaga |    3 |</span><br><span class="line">+------+------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; delete from student where age=2;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select * from student;</span><br><span class="line">+------+------+</span><br><span class="line">| name | age  |</span><br><span class="line">+------+------+</span><br><span class="line">| haha |    1 |</span><br><span class="line">| gaga |    3 |</span><br><span class="line">+------+------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>delete t1,t2,…tn from t1,t2,…tn [where condition];<br>如果 from 后面的表名用别名，则 delete 后面的也要用相应的别名，否则会提示语法错误。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; select * from boy;</span><br><span class="line">+------+-------+</span><br><span class="line">| name | score |</span><br><span class="line">+------+-------+</span><br><span class="line">| haha |    10 |</span><br><span class="line">| gaga |    30 |</span><br><span class="line">+------+-------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select * from student;</span><br><span class="line">+------+------+</span><br><span class="line">| name | age  |</span><br><span class="line">+------+------+</span><br><span class="line">| haha |    1 |</span><br><span class="line">| gaga |    3 |</span><br><span class="line">+------+------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; delete boy, s from boy, student s where s.age=1 and boy.name=s.name;</span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select * from student;</span><br><span class="line">+------+------+</span><br><span class="line">| name | age  |</span><br><span class="line">+------+------+</span><br><span class="line">| gaga |    3 |</span><br><span class="line">+------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select * from boy;</span><br><span class="line">+------+-------+</span><br><span class="line">| name | score |</span><br><span class="line">+------+-------+</span><br><span class="line">| gaga |    30 |</span><br><span class="line">+------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h2 id="查询记录"><a href="#查询记录" class="headerlink" title="查询记录"></a>查询记录</h2><p>基本语法<br>select * from tablename [where condition];</p>
<h3 id="查询不重复记录-去重"><a href="#查询不重复记录-去重" class="headerlink" title="查询不重复记录(去重)"></a>查询不重复记录(去重)</h3><p>使用<strong>distinct关键字</strong>实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; select age from student;</span><br><span class="line">+------+</span><br><span class="line">| age  |</span><br><span class="line">+------+</span><br><span class="line">|    3 |</span><br><span class="line">|    3 |</span><br><span class="line">|    4 |</span><br><span class="line">+------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select distinct age from student;</span><br><span class="line">+------+</span><br><span class="line">| age  |</span><br><span class="line">+------+</span><br><span class="line">|    3 |</span><br><span class="line">|    4 |</span><br><span class="line">+------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="条件查询"><a href="#条件查询" class="headerlink" title="条件查询"></a>条件查询</h3><p>使用<strong>where关键字</strong>实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; select * from student where age=4;</span><br><span class="line">+------+------+</span><br><span class="line">| name | age  |</span><br><span class="line">+------+------+</span><br><span class="line">| tete |    4 |</span><br><span class="line">+------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="排序和限制"><a href="#排序和限制" class="headerlink" title="排序和限制"></a>排序和限制</h3><p>排序使用order by关键字实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from tablename [where condition] [order by field1 [desc|asc] , field2 [desc|asc],......fieldn [desc|asc]]</span><br></pre></td></tr></table></figure></p>
<p>desc 和 asc 是排序顺序关键字，desc表示按照字段进行降序排列，asc则表示升序排列，如果不写此关键字默认是升序排列。order by后面可以跟多个不同的排序字段，并 且每个排序字段可以有不同的排序顺序。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; select * from student;</span><br><span class="line">+------+------+</span><br><span class="line">| name | age  |</span><br><span class="line">+------+------+</span><br><span class="line">| gaga |    3 |</span><br><span class="line">| haha |    3 |</span><br><span class="line">| tete |    4 |</span><br><span class="line">| haha |    1 |</span><br><span class="line">| tete |    2 |</span><br><span class="line">+------+------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select * from student order by age;</span><br><span class="line">+------+------+</span><br><span class="line">| name | age  |</span><br><span class="line">+------+------+</span><br><span class="line">| haha |    1 |</span><br><span class="line">| tete |    2 |</span><br><span class="line">| gaga |    3 |</span><br><span class="line">| haha |    3 |</span><br><span class="line">| tete |    4 |</span><br><span class="line">+------+------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select * from student order by age , name desc;</span><br><span class="line">+------+------+</span><br><span class="line">| name | age  |</span><br><span class="line">+------+------+</span><br><span class="line">| haha |    1 |</span><br><span class="line">| tete |    2 |</span><br><span class="line">| haha |    3 |</span><br><span class="line">| gaga |    3 |</span><br><span class="line">| tete |    4 |</span><br><span class="line">+------+------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p><strong>限制显示个数使用limit关键字</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select ... ... [limit offset_start, row_count]</span><br></pre></td></tr></table></figure></p>
<p>offset_start起始偏移量 row_count显示行数，默认情况下起始偏移量为0，只写显示行数，显示前n条记录。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; select * from student limit 2;</span><br><span class="line">+------+------+</span><br><span class="line">| name | age  |</span><br><span class="line">+------+------+</span><br><span class="line">| gaga |    3 |</span><br><span class="line">| haha |    3 |</span><br><span class="line">+------+------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select * from student limit 3, 2;</span><br><span class="line">+------+------+</span><br><span class="line">| name | age  |</span><br><span class="line">+------+------+</span><br><span class="line">| haha |    1 |</span><br><span class="line">| tete |    2 |</span><br><span class="line">+------+------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select * from student;</span><br><span class="line">+------+------+</span><br><span class="line">| name | age  |</span><br><span class="line">+------+------+</span><br><span class="line">| gaga |    3 |</span><br><span class="line">| haha |    3 |</span><br><span class="line">| tete |    4 |</span><br><span class="line">| haha |    1 |</span><br><span class="line">| tete |    2 |</span><br><span class="line">+------+------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select [field1, field2, ...... fieldn] fun_name</span><br><span class="line">from tablename</span><br><span class="line">[where wehre_contition]</span><br><span class="line">[group by field1, field2, ... fieldn]</span><br><span class="line">[with rollup]</span><br><span class="line">[having where_contition]</span><br></pre></td></tr></table></figure>
<p>fun_name聚合操作(聚合函数)，常用的有：sum(求和)、count(总个数)、max(最大值)、min(最小值)<br>group by关键字表示要进行分类聚合的字段<br>where rollup可选语法，表示是否对分类聚合的结果进行再汇总<br>having 关键字表示对分类后的结果再进行条件的过滤</p>
<p>having 和 where 的区别在于 having 是对聚合后的结果进行条件的过滤，而 where 是在聚合前就对记录进行过滤，如果逻辑允许，我们尽可能用 where 先过滤记录，这样因为结果集减小，将对聚合的效率大大提高，最后再根据逻辑看是否用 having 进行再过滤<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; select * from student_score;</span><br><span class="line">+------+--------+-------+-------+-------+</span><br><span class="line">| name | shuxue | yuwen | yinyu | class |</span><br><span class="line">+------+--------+-------+-------+-------+</span><br><span class="line">| gaga |      1 |     3 |     4 |     1 |</span><br><span class="line">| fef  |      9 |    23 |    21 |     2 |</span><br><span class="line">| ii   |     45 |   123 |    42 |     1 |</span><br><span class="line">| gr   |     56 |    34 |    86 |     2 |</span><br><span class="line">| ce   |     45 |    23 |    98 |     2 |</span><br><span class="line">| gr   |      1 |     3 |     4 |     3 |</span><br><span class="line">| khj  |      9 |    23 |    21 |     4 |</span><br><span class="line">| ko   |     45 |   123 |    42 |     4 |</span><br><span class="line">| po   |     56 |    34 |    86 |     5 |</span><br><span class="line">| ds   |     45 |    23 |    98 |     3 |</span><br><span class="line">+------+--------+-------+-------+-------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select sum(shuxue), max(yinyu), min(yuwen) from student_score;</span><br><span class="line">+-------------+------------+------------+</span><br><span class="line">| sum(shuxue) | max(yinyu) | min(yuwen) |</span><br><span class="line">+-------------+------------+------------+</span><br><span class="line">|         312 |         98 |          3 |</span><br><span class="line">+-------------+------------+------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select class, sum(shuxue), sum(yinyu) from student_score group by class;</span><br><span class="line">+-------+-------------+------------+</span><br><span class="line">| class | sum(shuxue) | sum(yinyu) |</span><br><span class="line">+-------+-------------+------------+</span><br><span class="line">|     1 |          46 |         46 |</span><br><span class="line">|     2 |         110 |        205 |</span><br><span class="line">|     3 |          46 |        102 |</span><br><span class="line">|     4 |          54 |         63 |</span><br><span class="line">|     5 |          56 |         86 |</span><br><span class="line">+-------+-------------+------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select class, sum(shuxue), sum(yinyu) from student_score group by class with rollup;</span><br><span class="line">+-------+-------------+------------+</span><br><span class="line">| class | sum(shuxue) | sum(yinyu) |</span><br><span class="line">+-------+-------------+------------+</span><br><span class="line">|     1 |          46 |         46 |</span><br><span class="line">|     2 |         110 |        205 |</span><br><span class="line">|     3 |          46 |        102 |</span><br><span class="line">|     4 |          54 |         63 |</span><br><span class="line">|     5 |          56 |         86 |</span><br><span class="line">|  NULL |         312 |        502 |</span><br><span class="line">+-------+-------------+------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select class, sum(shuxue), sum(yinyu) from student_score group by class with rollup having sum(shuxue) &gt; 50;</span><br><span class="line">+-------+-------------+------------+</span><br><span class="line">| class | sum(shuxue) | sum(yinyu) |</span><br><span class="line">+-------+-------------+------------+</span><br><span class="line">|     2 |         110 |        205 |</span><br><span class="line">|     4 |          54 |         63 |</span><br><span class="line">|     5 |          56 |         86 |</span><br><span class="line">|  NULL |         312 |        502 |</span><br><span class="line">+-------+-------------+------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="表连接"><a href="#表连接" class="headerlink" title="表连接"></a>表连接</h3><p>表连接分为内连接和外连接，内连接仅选出两张表中互相存在的记录，而外连接会选出其他不匹配的记录。<br>外连接分为左连接和右连接</p>
<ol>
<li>左连接：包含所有的左边表中的记录甚至是右边表中没有和它匹配的记录。</li>
<li>右连接：包含所有的右边表中的记录甚至是左边表中没有和它匹配的记录。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; select * from student;</span><br><span class="line">+------+------+</span><br><span class="line">| name | age  |</span><br><span class="line">+------+------+</span><br><span class="line">| gaga |    3 |</span><br><span class="line">| haha |    3 |</span><br><span class="line">| tete |    4 |</span><br><span class="line">| haha |    1 |</span><br><span class="line">| tete |    2 |</span><br><span class="line">| fee  |    2 |</span><br><span class="line">| ko   |    3 |</span><br><span class="line">+------+------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select * from student_score;</span><br><span class="line">+------+--------+-------+-------+-------+</span><br><span class="line">| name | shuxue | yuwen | yinyu | class |</span><br><span class="line">+------+--------+-------+-------+-------+</span><br><span class="line">| gaga |      1 |     3 |     4 |     1 |</span><br><span class="line">| fef  |      9 |    23 |    21 |     2 |</span><br><span class="line">| ii   |     45 |   123 |    42 |     1 |</span><br><span class="line">| gr   |     56 |    34 |    86 |     2 |</span><br><span class="line">| ce   |     45 |    23 |    98 |     2 |</span><br><span class="line">| gr   |      1 |     3 |     4 |     3 |</span><br><span class="line">| khj  |      9 |    23 |    21 |     4 |</span><br><span class="line">| ko   |     45 |   123 |    42 |     4 |</span><br><span class="line">| po   |     56 |    34 |    86 |     5 |</span><br><span class="line">| ds   |     45 |    23 |    98 |     3 |</span><br><span class="line">+------+--------+-------+-------+-------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select * from student, student_score where student.name=student_score.name;</span><br><span class="line">+------+------+------+--------+-------+-------+-------+</span><br><span class="line">| name | age  | name | shuxue | yuwen | yinyu | class |</span><br><span class="line">+------+------+------+--------+-------+-------+-------+</span><br><span class="line">| gaga |    3 | gaga |      1 |     3 |     4 |     1 |</span><br><span class="line">| ko   |    3 | ko   |     45 |   123 |    42 |     4 |</span><br><span class="line">+------+------+------+--------+-------+-------+-------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select * from student left join student_score on student.name=student_score.name;</span><br><span class="line">+------+------+------+--------+-------+-------+-------+</span><br><span class="line">| name | age  | name | shuxue | yuwen | yinyu | class |</span><br><span class="line">+------+------+------+--------+-------+-------+-------+</span><br><span class="line">| gaga |    3 | gaga |      1 |     3 |     4 |     1 |</span><br><span class="line">| ko   |    3 | ko   |     45 |   123 |    42 |     4 |</span><br><span class="line">| haha |    3 | NULL |   NULL |  NULL |  NULL |  NULL |</span><br><span class="line">| tete |    4 | NULL |   NULL |  NULL |  NULL |  NULL |</span><br><span class="line">| haha |    1 | NULL |   NULL |  NULL |  NULL |  NULL |</span><br><span class="line">| tete |    2 | NULL |   NULL |  NULL |  NUULL |  NULL |</span><br><span class="line">| fee  |    2 | NULL |   NULL |  NULL |  NULL |  NULL |</span><br><span class="line">+------+------+------+--------+-------+-------+-------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select * from student right join student_score on student.name=student_score.name;</span><br><span class="line">+------+------+------+--------+-------+-------+-------+</span><br><span class="line">| name | age  | name | shuxue | yuwen | yinyu | class |</span><br><span class="line">+------+------+------+--------+-------+-------+-------+</span><br><span class="line">| gaga |    3 | gaga |      1 |     3 |     4 |     1 |</span><br><span class="line">| ko   |    3 | ko   |     45 |   123 |    42 |     4 |</span><br><span class="line">| NULL | NULL | fef  |      9 |    23 |    21 |     2 |</span><br><span class="line">| NULL | NULL | ii   |     45 |   123 |    42 |     1 |</span><br><span class="line">| NULL | NULL | gr   |     56 |    34 |    86 |     2 |</span><br><span class="line">| NULL | NULL | ce   |     45 |    23 |    98 |     2 |</span><br><span class="line">| NULL | NULL | gr   |      1 |     3 |     4 |     3 |</span><br><span class="line">| NULL | NULL | khj  |      9 |    23 |    21 |     4 |</span><br><span class="line">| NULL | NULL | po   |     56 |    34 |    86 |     5 |</span><br><span class="line">| NULL | NULL | ds   |     45 |    23 |    98 |     3 |</span><br><span class="line">+------+------+------+--------+-------+-------+-------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; select * from student where name in (select name from student_score);</span><br><span class="line">+------+------+</span><br><span class="line">| name | age  |</span><br><span class="line">+------+------+</span><br><span class="line">| gaga |    3 |</span><br><span class="line">| ko   |    3 |</span><br><span class="line">+------+------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>某些情况下子查询和表连接可以相互转化</p>
<h3 id="记录联合"><a href="#记录联合" class="headerlink" title="记录联合"></a>记录联合</h3><p>union和union all用于实现记录联合<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [test]&gt; select name from student union all select name from student_score;</span><br><span class="line">+------+</span><br><span class="line">| name |</span><br><span class="line">+------+</span><br><span class="line">| gaga |</span><br><span class="line">| haha |</span><br><span class="line">| tete |</span><br><span class="line">| haha |</span><br><span class="line">| tete |</span><br><span class="line">| fee  |</span><br><span class="line">| ko   |</span><br><span class="line">| gaga |</span><br><span class="line">| fef  |</span><br><span class="line">| ii   |</span><br><span class="line">| gr   |</span><br><span class="line">| ce   |</span><br><span class="line">| gr   |</span><br><span class="line">| khj  |</span><br><span class="line">| ko   |</span><br><span class="line">| po   |</span><br><span class="line">| ds   |</span><br><span class="line">+------+</span><br><span class="line">17 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [test]&gt; select name from student union select name from student_score;</span><br><span class="line">+------+</span><br><span class="line">| name |</span><br><span class="line">+------+</span><br><span class="line">| gaga |</span><br><span class="line">| haha |</span><br><span class="line">| tete |</span><br><span class="line">| fee  |</span><br><span class="line">| ko   |</span><br><span class="line">| fef  |</span><br><span class="line">| ii   |</span><br><span class="line">| gr   |</span><br><span class="line">| ce   |</span><br><span class="line">| khj  |</span><br><span class="line">| po   |</span><br><span class="line">| ds   |</span><br><span class="line">+------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>union 和 union all的区别在于union all将结果集直接合并在一起，而union将union all的结果进行一次distinct，去除重复记录的结果。</p>
<h1 id="DCL"><a href="#DCL" class="headerlink" title="DCL"></a>DCL</h1><p>DCL语句主要是DBA用来管理系统中的对象权限所使用的，一般开发人员很少使用。<br>grant和revoke分别授出和收回用户权限。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.casezheng.date/2017/10/30/mysql-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CaseZheng">
      <meta itemprop="description" content="CaseZheng的博客网站">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CaseZheng">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/10/30/mysql-1/" class="post-title-link" itemprop="url">MySQL 简介与安装</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-10-30 22:06:00" itemprop="dateCreated datePublished" datetime="2017-10-30T22:06:00+08:00">2017-10-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-12 12:56:36" itemprop="dateModified" datetime="2020-04-12T12:56:36+08:00">2020-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>mysql的简单介绍</p>
<h1 id="关系型数据库"><a href="#关系型数据库" class="headerlink" title="关系型数据库"></a>关系型数据库</h1><p>数据库是(Database)是按照数据结构来组织、存储和管理数据的仓库。<br>关系型数据库，是建立在关系模型基础上的数据库，借助于集合代数等数学概念和方法来处理数据库中的数据。</p>
<h2 id="RDBMS的特点："><a href="#RDBMS的特点：" class="headerlink" title="RDBMS的特点："></a>RDBMS的特点：</h2><ol>
<li>数据以表格的形式出现</li>
<li>每行为各种记录名称</li>
<li>每列为记录名称所对应的数据域</li>
<li>许多的行和列组成一张表单</li>
<li>若干的表单组成database</li>
</ol>
<h2 id="RDBMS的术语："><a href="#RDBMS的术语：" class="headerlink" title="RDBMS的术语："></a>RDBMS的术语：</h2><ol>
<li>数据库：数据库是一些关联表的集合。</li>
<li>数据表：表是数据的矩阵。</li>
<li>主键：主键是唯一的。一个数据表中只能包含一个主键。</li>
<li>外键：外键用于关联两个表。</li>
<li>复合键：复合键（组合键）将多个列作为一个索引键，一般用于复合索引。</li>
<li>索引：使用索引可快速访问数据库表中的特定信息。索引是对数据库表中一列或多列的值进行排序的一种结构。</li>
<li>参照完整性: 参照的完整性要求关系中不允许引用不存在的实体。与实体完整性是关系模型必须满足的完整性约束条件，目的是保证数据的一致性。</li>
</ol>
<h2 id="MySQL数据库"><a href="#MySQL数据库" class="headerlink" title="MySQL数据库"></a>MySQL数据库</h2><p>MySQL是一个关系型数据库管理系统(RDBMS, Relational Database Management System)，由瑞典MySQL AB 公司开发，目前属于 Oracle 旗下产品。<br>MySQL是最流行的RDBMS, 关系数据库将数据保存在不同的表中，而不是将所有数据放在一个大仓库内，这样就增加了速度并提高了灵活性。<br>MySQL所使用的 SQL 语言是用于访问数据库的最常用标准化语言。MySQL 软件采用了双授权政策，分为社区版和商业版，由于其体积小、速度快、总体拥有成本低，尤其是开放源码这一特点，一般中小型网站的开发都选择 MySQL 作为网站数据库。</p>
<h2 id="MySQL分支与变种"><a href="#MySQL分支与变种" class="headerlink" title="MySQL分支与变种"></a>MySQL分支与变种</h2><p>主流的三种变种：Percona Server,MariaDB和Drizzle</p>
<ol>
<li>Percona Server<br>Percona Server是个与Mysql向后兼容的替代品，它尽可能的不改变SQL语法，客户端/服务器协议和磁盘上的文件格式。任何运行在Mysql上的都可以运行在Percona Server上而不需要修改。切换到Percona Server只需关掉Mysql和启动Percona Server，不需要导出和重新导入数据。Percona Server包括Percona XtraDB引擎，即改进版本的InnoDB。Percona Server的许多改进特性在随后的Mysql版本中才会有体现，也就是说Percona Server成了许多新特性的“抢鲜”版。</li>
<li>MariaDB<br>从 MySQL 转向 MariaDB的代表厂家：谷歌（2013年9月）、RedHat（2013年6月）、维基百科（2013年4月）<br>MySQL 在 2008 年被Sun以10亿美金所收购，MySQL 创始人 Michael Widenius 则不满 Sun 开发团队脚步过慢，愤而离职成立开源数据库联盟，另外从现有 MySQL 程序代码中，开发出另一个延伸分支版本，也就是名为玛莉亚数据库的企业级开源数据。库玛莉亚数据库如同 MySQL 的影子版本，玛莉亚数据库是 MySQL 的一个分支版本（branch），而不是衍生版本（folk），提供的功能可和 MySQL 完全兼容。</li>
<li>Drizzle<br>Drizzle是真正的Mysql分支，而非只是个变种或增强版本。它并不与Mysql兼容，尽管区分上还并不是大相径庭。在许多场合并不能简单地将Mysql后端替换为Drizzle，因为它对Mysql的语法修改太大了。</li>
</ol>
<h1 id="MySQL的安装"><a href="#MySQL的安装" class="headerlink" title="MySQL的安装"></a>MySQL的安装</h1><p>最直接的方式，使用yum安装，这里使用MariaDB，操作系统是Fedora 26。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install mariadb mariadb-server mariadb-devel mariadb-libs mariadb-common mariadb-config -y</span><br></pre></td></tr></table></figure></p>
<h1 id="MySQL的启动"><a href="#MySQL的启动" class="headerlink" title="MySQL的启动"></a>MySQL的启动</h1><p>将mariadb设置为开机自启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable mariadb.service</span><br><span class="line">systemctl start mariadb.service</span><br><span class="line">systemctl status mariadb.service</span><br></pre></td></tr></table></figure></p>
<p>检查服务器版本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@localhost ~]$ mysql --version</span><br><span class="line">mysql  Ver 15.1 Distrib 10.1.26-MariaDB, for Linux (x86_64) using readline 5.1</span><br></pre></td></tr></table></figure></p>
<h1 id="MySQL的连接"><a href="#MySQL的连接" class="headerlink" title="MySQL的连接"></a>MySQL的连接</h1><p>MySQL刚刚安装密码为空，可直接连接。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@localhost ~]$ mysql</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 5</span><br><span class="line">Server version: 10.1.26-MariaDB MariaDB Server</span><br><span class="line">Copyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line">MariaDB [(none)]&gt;</span><br></pre></td></tr></table></figure></p>
<p>可以使用mysqladmin创建root用户的密码，记得需要在root用户下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot password 123456</span><br></pre></td></tr></table></figure></p>
<h1 id="MySQL安装后的样例配置文件在-usr-share-mysql下"><a href="#MySQL安装后的样例配置文件在-usr-share-mysql下" class="headerlink" title="MySQL安装后的样例配置文件在/usr/share/mysql下"></a>MySQL安装后的样例配置文件在/usr/share/mysql下</h1><p>安装mariadb的则在/usr/share/mariadb该目录下<br>将/etc/my.cnf备份，再将选择的样例配置文件，复制到/etc/目录下，改名为my.cnf。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@localhost mariadb]$ pwd</span><br><span class="line">/usr/share/mariadb</span><br><span class="line">[CaseZheng@localhost mariadb]$ ls *.cnf</span><br><span class="line">my-huge.cnf  my-innodb-heavy-4G.cnf  my-large.cnf  my-medium.cnf  my-small.cnf  wsrep.cnf</span><br></pre></td></tr></table></figure></p>
<h1 id="MySQl基本操作"><a href="#MySQl基本操作" class="headerlink" title="MySQl基本操作"></a>MySQl基本操作</h1><h2 id="show-databases"><a href="#show-databases" class="headerlink" title="show databases;"></a>show databases;</h2><p>查看所有的DB名称<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [mysql]&gt; show databases;</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">| Database           |</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test               |</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">4 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h2 id="use-数据库名"><a href="#use-数据库名" class="headerlink" title="use 数据库名;"></a>use 数据库名;</h2><p>切换数据库<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [mysql]&gt; use mysql</span><br><span class="line">Database changed</span><br></pre></td></tr></table></figure></p>
<h2 id="show-tables"><a href="#show-tables" class="headerlink" title="show tables;"></a>show tables;</h2><p>查看当前数据库的所有表<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [mysql]&gt; show tables;</span><br><span class="line">+<span class="comment">---------------------------+</span></span><br><span class="line">| Tables_in_mysql           |</span><br><span class="line">+<span class="comment">---------------------------+</span></span><br><span class="line">| column_stats              |</span><br><span class="line">| time_zone_leap_second     |</span><br><span class="line">| time_zone_name            |</span><br><span class="line">| time_zone_transition      |</span><br><span class="line">| time_zone_transition_type |</span><br><span class="line">| user                      |</span><br><span class="line">+<span class="comment">---------------------------+</span></span><br></pre></td></tr></table></figure></p>
<h2 id="show-columns-from-数据表"><a href="#show-columns-from-数据表" class="headerlink" title="show columns from 数据表;"></a>show columns from 数据表;</h2><p>显示数据表的属性，属性类型，主键信息 ，是否为 NULL，默认值等其他信息。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [mysql]&gt; show columns from host;</span><br><span class="line">+<span class="comment">-----------------------+---------------+------+-----+---------+-------+</span></span><br><span class="line">| Field                 | Type          | Null | Key | Default | Extra |</span><br><span class="line">+<span class="comment">-----------------------+---------------+------+-----+---------+-------+</span></span><br><span class="line">| Host                  | char(60)      | NO   | PRI |         |       |</span><br><span class="line">| Db                    | char(64)      | NO   | PRI |         |       |</span><br><span class="line">| Select_priv           | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Insert_priv           | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Update_priv           | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Delete_priv           | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Create_priv           | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Drop_priv             | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Grant_priv            | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| References_priv       | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Index_priv            | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Alter_priv            | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Create_tmp_table_priv | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Lock_tables_priv      | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Create_view_priv      | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Show_view_priv        | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Create_routine_priv   | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Alter_routine_priv    | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Execute_priv          | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Trigger_priv          | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">+<span class="comment">-----------------------+---------------+------+-----+---------+-------+</span></span><br><span class="line">20 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h2 id="desc-数据表"><a href="#desc-数据表" class="headerlink" title="desc 数据表;"></a>desc 数据表;</h2><p>显示数据表的属性，属性类型，主键信息 ，是否为 NULL，默认值等其他信息。与show columns from 数据表作用相同。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [mysql]&gt; desc host;</span><br><span class="line">+<span class="comment">-----------------------+---------------+------+-----+---------+-------+</span></span><br><span class="line">| Field                 | Type          | Null | Key | Default | Extra |</span><br><span class="line">+<span class="comment">-----------------------+---------------+------+-----+---------+-------+</span></span><br><span class="line">| Host                  | char(60)      | NO   | PRI |         |       |</span><br><span class="line">| Db                    | char(64)      | NO   | PRI |         |       |</span><br><span class="line">| Select_priv           | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Insert_priv           | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Update_priv           | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Delete_priv           | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Create_priv           | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Drop_priv             | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Grant_priv            | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| References_priv       | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Index_priv            | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Alter_priv            | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Create_tmp_table_priv | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Lock_tables_priv      | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Create_view_priv      | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Show_view_priv        | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Create_routine_priv   | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Alter_routine_priv    | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Execute_priv          | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">| Trigger_priv          | enum('N','Y') | NO   |     | N       |       |</span><br><span class="line">+<span class="comment">-----------------------+---------------+------+-----+---------+-------+</span></span><br><span class="line">20 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h2 id="show-index-from-数据表"><a href="#show-index-from-数据表" class="headerlink" title="show index from 数据表;"></a>show index from 数据表;</h2><p>显示数据表的详细索引信息，包括PRIMARY KEY（主键）。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [mysql]&gt; show index from user;</span><br><span class="line">+<span class="comment">-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></span><br><span class="line">| Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | <span class="keyword">Comment</span> | Index_comment |</span><br><span class="line">+<span class="comment">-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></span><br><span class="line">| <span class="keyword">user</span>  |          <span class="number">0</span> | PRIMARY  |            <span class="number">1</span> | Host        | A         |        <span class="literal">NULL</span> |     <span class="literal">NULL</span> | <span class="literal">NULL</span>   |      | BTREE      |         |               |</span><br><span class="line">| <span class="keyword">user</span>  |          <span class="number">0</span> | PRIMARY  |            <span class="number">2</span> | <span class="keyword">User</span>        | A         |           <span class="number">6</span> |     <span class="literal">NULL</span> | <span class="literal">NULL</span>   |      | BTREE      |         |               |</span><br><span class="line">+<span class="comment">-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h2 id="show-table-status-from-db-name-like-‘pattern’-G"><a href="#show-table-status-from-db-name-like-‘pattern’-G" class="headerlink" title="show table status from db_name [like ‘pattern’]\G"></a>show table status from db_name [like ‘pattern’]\G</h2><p>输出Mysql数据库管理系统的性能及统计信息  命令后加\G则不需要再加;   且查询结果会按列打印<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">输出数据库mysql所有表的信息</span><br><span class="line">MariaDB [mysql]&gt; show table status from mysql\G</span><br><span class="line"></span><br><span class="line">数据数据库mysql以u开头的表信息</span><br><span class="line">MariaDB [mysql]&gt; show table status from mysql like 'u%'\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           Name: user</span><br><span class="line">         Engine: MyISAM</span><br><span class="line">        Version: 10</span><br><span class="line">     Row_format: Dynamic</span><br><span class="line">           Rows: 6</span><br><span class="line"> Avg_row_length: 74</span><br><span class="line">    Data_length: 444</span><br><span class="line">Max_data_length: 281474976710655</span><br><span class="line">   Index_length: 4096</span><br><span class="line">      Data_free: 0</span><br><span class="line"> Auto_increment: NULL</span><br><span class="line">    Create_time: 2017-08-27 18:47:47</span><br><span class="line">    Update_time: 2017-10-30 23:16:25</span><br><span class="line">     Check_time: NULL</span><br><span class="line">      Collation: utf8_bin</span><br><span class="line">       <span class="keyword">Checksum</span>: <span class="literal">NULL</span></span><br><span class="line"> Create_options:</span><br><span class="line">        <span class="keyword">Comment</span>: <span class="keyword">Users</span> <span class="keyword">and</span> <span class="keyword">global</span> <span class="keyword">privileges</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h2 id="show-create-table-table-name-G"><a href="#show-create-table-table-name-G" class="headerlink" title="show create table table_name\G"></a>show create table table_name\G</h2><p>打印创建table_name表的SQL语句<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [mysql]&gt; show create table host\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       Table: host</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span>: <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`host`</span> (</span><br><span class="line">  <span class="string">`Host`</span> <span class="built_in">char</span>(<span class="number">60</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  <span class="string">`Db`</span> <span class="built_in">char</span>(<span class="number">64</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  <span class="string">`Select_priv`</span> enum(<span class="string">'N'</span>,<span class="string">'Y'</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'N'</span>,</span><br><span class="line">  <span class="string">`Insert_priv`</span> enum(<span class="string">'N'</span>,<span class="string">'Y'</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'N'</span>,</span><br><span class="line">  <span class="string">`Update_priv`</span> enum(<span class="string">'N'</span>,<span class="string">'Y'</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'N'</span>,</span><br><span class="line">  <span class="string">`Delete_priv`</span> enum(<span class="string">'N'</span>,<span class="string">'Y'</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'N'</span>,</span><br><span class="line">  <span class="string">`Create_priv`</span> enum(<span class="string">'N'</span>,<span class="string">'Y'</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'N'</span>,</span><br><span class="line">  <span class="string">`Drop_priv`</span> enum(<span class="string">'N'</span>,<span class="string">'Y'</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'N'</span>,</span><br><span class="line">  <span class="string">`Grant_priv`</span> enum(<span class="string">'N'</span>,<span class="string">'Y'</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'N'</span>,</span><br><span class="line">  <span class="string">`References_priv`</span> enum(<span class="string">'N'</span>,<span class="string">'Y'</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'N'</span>,</span><br><span class="line">  <span class="string">`Index_priv`</span> enum(<span class="string">'N'</span>,<span class="string">'Y'</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'N'</span>,</span><br><span class="line">  <span class="string">`Alter_priv`</span> enum(<span class="string">'N'</span>,<span class="string">'Y'</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'N'</span>,</span><br><span class="line">  <span class="string">`Create_tmp_table_priv`</span> enum(<span class="string">'N'</span>,<span class="string">'Y'</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'N'</span>,</span><br><span class="line">  <span class="string">`Lock_tables_priv`</span> enum(<span class="string">'N'</span>,<span class="string">'Y'</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'N'</span>,</span><br><span class="line">  <span class="string">`Create_view_priv`</span> enum(<span class="string">'N'</span>,<span class="string">'Y'</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'N'</span>,</span><br><span class="line">  <span class="string">`Show_view_priv`</span> enum(<span class="string">'N'</span>,<span class="string">'Y'</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'N'</span>,</span><br><span class="line">  <span class="string">`Create_routine_priv`</span> enum(<span class="string">'N'</span>,<span class="string">'Y'</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'N'</span>,</span><br><span class="line">  <span class="string">`Alter_routine_priv`</span> enum(<span class="string">'N'</span>,<span class="string">'Y'</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'N'</span>,</span><br><span class="line">  <span class="string">`Execute_priv`</span> enum(<span class="string">'N'</span>,<span class="string">'Y'</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'N'</span>,</span><br><span class="line">  <span class="string">`Trigger_priv`</span> enum(<span class="string">'N'</span>,<span class="string">'Y'</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'N'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`Host`</span>,<span class="string">`Db`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=MyISAM <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COLLATE</span>=utf8_bin <span class="keyword">COMMENT</span>=<span class="string">'Host privileges;  Merged with database privileges'</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><ol>
<li><a href="http://www.runoob.com/mysql/mysql-tutorial.html" target="_blank" rel="noopener">MySQL教程</a></li>
<li><a href="http://www.cnblogs.com/mfyang/p/6735269.html" target="_blank" rel="noopener">MySQL简介</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.casezheng.date/2017/10/19/vim-youcompleteme/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CaseZheng">
      <meta itemprop="description" content="CaseZheng的博客网站">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CaseZheng">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/10/19/vim-youcompleteme/" class="post-title-link" itemprop="url">vim的自动补全插件的安装YouCompleteMe</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-10-19 22:04:00" itemprop="dateCreated datePublished" datetime="2017-10-19T22:04:00+08:00">2017-10-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-12 12:56:36" itemprop="dateModified" datetime="2020-04-12T12:56:36+08:00">2020-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/other/" itemprop="url" rel="index"><span itemprop="name">other</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><h1 id="YouCompleteMe-Linux"><a href="#YouCompleteMe-Linux" class="headerlink" title="YouCompleteMe Linux"></a>YouCompleteMe Linux</h1><p><a href="https://github.com/CaseZheng/CaseZhengVim" target="_blank" rel="noopener">个人vim配置</a></p>
<p>环境 Fedora26<br><a href="http://valloric.github.io/YouCompleteMe/#full-installation-guide" target="_blank" rel="noopener">YouCompleteMe官网</a><br>前期准备工作</p>
<ol>
<li>vim 支持python vim版本</li>
<li><p>安装各种库和工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y ruby ruby-devel lua lua-devel luajit     luajit-devel ctags git python python-devel     python3 python3-devel tcl-devel     perl perl-devel perl-ExtUtils-ParseXS     perl-ExtUtils-XSpp perl-ExtUtils-CBuilder     perl-ExtUtils-Embed</span><br><span class="line">sudo sudo dnf install automake gcc gcc-c++ kernel-devel cmake</span><br><span class="line">sudo dnf install python-devel python3-devel</span><br><span class="line">sudo dnf install clang</span><br><span class="line">sudo dnf install boost-devel boost</span><br><span class="line">sudo dnf install golang</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用Vundle vim插件管理器下载YouCompleteMe</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Plugin &apos;Valloric/YouCompleteMe&apos;</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载到YouCompleteMe后，进入YouCompleteMe目录，执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git submodule update --init --recursive</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译YouCompleteMe 可根据自己需要安装 详情见官网</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./install.py --clang-completer --system-libclang --system-boost --gocode-completer</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>.vimrc 配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">let g:ycm_global_ycm_extra_conf = &apos;~/.vim/.ycm_extra_conf.py&apos; &quot;此处是全局配置文件路径</span><br><span class="line">let g:ycm_confirm_extra_conf = 0    &quot;关闭每次导入配置文件前的询问</span><br><span class="line">let g:syntastic_always_populate_loc_list = 1 &quot;方便使用syntastic进行语法检查</span><br><span class="line">let g:ycm_seed_identifiers_with_syntax=1 &quot; 开启语法关键字补全</span><br></pre></td></tr></table></figure></p>
<p>.ycm_extra_conf.py配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/.vim/</span><br><span class="line">cp bundle/YouCompleteMe/third_party/ycmd/cpp/ycm/.ycm_extra_conf.py .</span><br></pre></td></tr></table></figure></p>
<p>修改.ycm_extra_conf，主要是加入库文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">flags = [</span><br><span class="line">&apos;-Wall&apos;,</span><br><span class="line">&apos;-Wextra&apos;,</span><br><span class="line">&apos;-Werror&apos;,</span><br><span class="line">&apos;-Wno-long-long&apos;,</span><br><span class="line">&apos;-Wno-variadic-macros&apos;,</span><br><span class="line">&apos;-fexceptions&apos;,</span><br><span class="line">&apos;-DNDEBUG&apos;,</span><br><span class="line"># You 100% do NOT need -DUSE_CLANG_COMPLETER in your flags; only the YCM</span><br><span class="line"># source code needs it.</span><br><span class="line">&apos;-DUSE_CLANG_COMPLETER&apos;,</span><br><span class="line"># THIS IS IMPORTANT! Without the &apos;-x&apos; flag, Clang won&apos;t know which language to</span><br><span class="line"># use when compiling headers. So it will guess. Badly. So C++ headers will be</span><br><span class="line"># compiled as C headers. You don&apos;t want that so ALWAYS specify the &apos;-x&apos; flag.</span><br><span class="line"># For a C project, you would set this to &apos;c&apos; instead of &apos;c++&apos;.</span><br><span class="line">&apos;-std=c++11&apos;,</span><br><span class="line">&apos;-x&apos;,</span><br><span class="line">&apos;c++&apos;,</span><br><span class="line">&apos;-isystem&apos;,</span><br><span class="line">&apos;../BoostParts&apos;,</span><br><span class="line">&apos;-isystem&apos;,</span><br><span class="line">get_python_inc(),</span><br><span class="line">&apos;-isystem&apos;,</span><br><span class="line">&apos;../llvm/include&apos;,</span><br><span class="line">&apos;-isystem&apos;,</span><br><span class="line">&apos;../llvm/tools/clang/include&apos;,</span><br><span class="line">&apos;-I&apos;,</span><br><span class="line">&apos;.&apos;,</span><br><span class="line">&apos;-I&apos;,</span><br><span class="line">&apos;./ClangCompleter&apos;,</span><br><span class="line">&apos;-isystem&apos;,</span><br><span class="line">&apos;./tests/gmock/gtest&apos;,</span><br><span class="line">&apos;-isystem&apos;,</span><br><span class="line">&apos;./tests/gmock/gtest/include&apos;,</span><br><span class="line">&apos;-isystem&apos;,</span><br><span class="line">&apos;./tests/gmock&apos;,</span><br><span class="line">&apos;-isystem&apos;,</span><br><span class="line">&apos;./tests/gmock/include&apos;,</span><br><span class="line">&apos;-isystem&apos;,</span><br><span class="line">&apos;./benchmarks/benchmark/include&apos;,</span><br><span class="line">]</span><br><span class="line"># 需要屏蔽下面这部分</span><br><span class="line"># try:</span><br><span class="line">#   final_flags.remove( &apos;-stdlib=libc++&apos; )</span><br><span class="line"># except ValueError:</span><br><span class="line">#   pass</span><br></pre></td></tr></table></figure></p>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><h2 id="YouCompleteMe-unavailable-invalid-syntax-vimsupport-py-line-1224"><a href="#YouCompleteMe-unavailable-invalid-syntax-vimsupport-py-line-1224" class="headerlink" title="YouCompleteMe unavailable: invalid syntax (vimsupport.py, line 1224)"></a>YouCompleteMe unavailable: invalid syntax (vimsupport.py, line 1224)</h2><p>在使用时报这个错,最后发现是编译的vim未支持python3导致的,重新编译vim支持python3即可</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a href="http://www.jianshu.com/p/d908ce81017a?nomobile=yes" target="_blank" rel="noopener">一步一步带你安装史上最难安装的 vim 插件 —— YouCompleteMe</a></li>
<li><a href="http://valloric.github.io/YouCompleteMe/#full-installation-guide" target="_blank" rel="noopener">官方文档</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.casezheng.date/2017/10/08/libevent-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CaseZheng">
      <meta itemprop="description" content="CaseZheng的博客网站">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CaseZheng">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/10/08/libevent-2/" class="post-title-link" itemprop="url">Libevent源码阅读——API简介</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-10-08 00:41:00" itemprop="dateCreated datePublished" datetime="2017-10-08T00:41:00+08:00">2017-10-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-12 12:56:36" itemprop="dateModified" datetime="2020-04-12T12:56:36+08:00">2020-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/网络库/" itemprop="url" rel="index"><span itemprop="name">网络库</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>重新读下Libevent的源码，使用最新的Libevent版本libevent-release-2.1.8-stable，本篇主要是Libevent event_base的设置、Libevent 事件循环的启动和停止、Libevent事件的创建和处理、Libevent http服务相关API的介绍</p>
<h1 id="基础API"><a href="#基础API" class="headerlink" title="基础API"></a>基础API</h1><h2 id="日志打印回调设置API-event-set-log-callback"><a href="#日志打印回调设置API-event-set-log-callback" class="headerlink" title="日志打印回调设置API event_set_log_callback"></a>日志打印回调设置API event_set_log_callback</h2><p>Libevent记录内部的错误和警告日志，如果编译了日志支持功能，也会记录调试信息，<strong>日志信息默认输出到stderr</strong>，可以通过提供自己的日志函数的方法来覆盖该行为。调用event_set_log_callback()传入event_log_cb类型的函数改变默认行为，传入NULL置为默认行为。默认调试日志是禁止的，可以通过event_enable_debug_logging()函数打开调试(DEBUG)日志，EVENT_DBG_NONE为默认行为，EVENT_DBG_ALL打开所有支持的调试日志。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Libevent日志登记</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EVENT_LOG_DEBUG 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EVENT_LOG_MSG   1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EVENT_LOG_WARN  2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EVENT_LOG_ERR   3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//severity libevent日志等级</span></span><br><span class="line"><span class="comment">//msg libevent日志信息</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*event_log_cb)</span><span class="params">(<span class="keyword">int</span> severity, <span class="keyword">const</span> <span class="keyword">char</span> *msg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//log_fn libevent默认的日志回调函数</span></span><br><span class="line"><span class="keyword">static</span> event_log_cb log_fn = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置libevent新的日志回调函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">event_set_log_callback</span><span class="params">(event_log_cb cb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	log_fn = cb;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EVENT_DBG_ALL 0xffffffffu</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EVENT_DBG_NONE 0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">event_enable_debug_logging</span><span class="params">(<span class="keyword">ev_uint32_t</span> which)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	event_debug_logging_mask_ = which;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/CaseZheng/Study/blob/master/Libevent/libevent_server.cpp" target="_blank" rel="noopener">Github示例代码</a></p>
<h2 id="致命错误退出回调设置API-event-set-fatal-callback"><a href="#致命错误退出回调设置API-event-set-fatal-callback" class="headerlink" title="致命错误退出回调设置API event_set_fatal_callback"></a>致命错误退出回调设置API event_set_fatal_callback</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*event_fatal_cb)</span><span class="params">(<span class="keyword">int</span> err)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> event_fatal_cb fatal_fn = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">event_set_fatal_callback</span><span class="params">(event_fatal_cb cb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	fatal_fn = cb;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Libevent在遇到致命错误时默认调用exit()或abort()退出当前进程，Libevent提供接口在其退出前会调用一次。</p>
<h2 id="更换内存管理函数的API-event-set-mem-functions"><a href="#更换内存管理函数的API-event-set-mem-functions" class="headerlink" title="更换内存管理函数的API event_set_mem_functions"></a>更换内存管理函数的API event_set_mem_functions</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *(*mm_malloc_fn_)(<span class="keyword">size_t</span> sz) = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *(*mm_realloc_fn_)(<span class="keyword">void</span> *p, <span class="keyword">size_t</span> sz) = <span class="literal">NULL</span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">void</span> <span class="params">(*mm_free_fn_)</span><span class="params">(<span class="keyword">void</span> *p)</span> </span>= <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">event_set_mem_functions</span><span class="params">(<span class="keyword">void</span> *(*malloc_fn)(<span class="keyword">size_t</span> sz),</span></span></span><br><span class="line"><span class="function"><span class="params">			<span class="keyword">void</span> *(*realloc_fn)(<span class="keyword">void</span> *ptr, <span class="keyword">size_t</span> sz),</span></span></span><br><span class="line"><span class="function"><span class="params">			<span class="keyword">void</span> (*free_fn)(<span class="keyword">void</span> *ptr))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	mm_malloc_fn_ = malloc_fn;</span><br><span class="line">	mm_realloc_fn_ = realloc_fn;</span><br><span class="line">	mm_free_fn_ = free_fn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认情况下Libevent会使用原生的malloc、calloc、realloc、free。<br>注意:更换内存管理函数将会影响LibEvent后续所有调用allocate、resize和free内存的函数.因此你需要确保在LibEvent调用其它函数之前替换掉这些函数.否则LibEvent将会调用你提供的free函数来释放从C语言库版本的malloc分配的内存.</p>
<ul>
<li>你的malloc和realloc函数需要返回和C语言库相同的内存对齐.</li>
<li>你的realloc函数需要正确处理realloc(NULL,sz),也就是说当做(malloc(sz)处理).</li>
<li>你的realloc函数需要正确处理realloc(ptr,0),也就是说当做free(ptr)处理.</li>
<li>你的free函数不必去处理free(NULL).</li>
<li>你的malloc函数不必去处理malloc(0).</li>
<li>如果你不止一个线程使用LibEvent,那么你提供的的内存管理替代函数必须是线程安全的.</li>
</ul>
<p><a href="https://github.com/CaseZheng/Study/blob/master/Libevent/libevent_server.cpp" target="_blank" rel="noopener">Github示例代码</a></p>
<h2 id="释放LibEvent全局结构体-libevent-global-shutdown"><a href="#释放LibEvent全局结构体-libevent-global-shutdown" class="headerlink" title="释放LibEvent全局结构体 libevent_global_shutdown"></a>释放LibEvent全局结构体 libevent_global_shutdown</h2><p>当进程退出时所有内存都会被释放，但残留的结构体会导致某些调试工具认为Libevent存在内存泄露，使用libevent_global_shutdown可以释放所有库内部的全局数据结构。但libevent_global_shutdown不会释放返回到Libevent外部的结构体，如events、event_base、bufferevents等。<br>调用libevent_global_shutdown()函数将会使得别的LibEvent的函数产生不可预知的行为.除了程序调用了最后一个LibEvent的函数否则不要调用它。<br><a href="https://github.com/CaseZheng/Study/blob/master/Libevent/libevent_timer_signal.cpp" target="_blank" rel="noopener">Github示例代码</a></p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>以下设置请看官方文档或<a href="http://blog.csdn.net/zhouyongku/article/details/53431597" target="_blank" rel="noopener">Libevent中文帮助手册</a></p>
<ol>
<li>线程和锁</li>
<li>调试锁的使用</li>
<li>调试事件的使用</li>
<li>Libevent版本的检查</li>
</ol>
<h1 id="event-base创建"><a href="#event-base创建" class="headerlink" title="event_base创建"></a>event_base创建</h1><h2 id="默认的event-base"><a href="#默认的event-base" class="headerlink" title="默认的event_base"></a>默认的event_base</h2><p>event_base_new()函数分配和返回一个默认参数的event_base，event_base_new()函数检查环境变量，然后分配一个指向新的event_base的指针，如果错误，返回NULL。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct event_base *<span class="title">event_base_new</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure></p>
<h2 id="复杂的event-base"><a href="#复杂的event-base" class="headerlink" title="复杂的event_base"></a>复杂的event_base</h2><p>创建复杂的event_base需要传入event_config。event_config通过event_config_new获得。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct event_config *<span class="title">event_config_new</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>获得event_config后对其进行设置，然后调用event_base_new_with_config()创建event_base。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct event_base *<span class="title">event_base_new_with_config</span><span class="params">(<span class="keyword">const</span> struct event_config *cfg)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>使用完event_config后需要调用event_config_free()释放event_config。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">event_config_free</span><span class="params">(struct event_config *cfg)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>event_config的设置需要调用别的函数。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_config_avoid_method</span><span class="params">(struct event_config *cfg, <span class="keyword">const</span> <span class="keyword">char</span> *method)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> event_method_feature &#123;</span><br><span class="line">    EV_FEATURE_ET = <span class="number">0x01</span>,</span><br><span class="line">    EV_FEATURE_O1 = <span class="number">0x02</span>,</span><br><span class="line">    EV_FEATURE_FDS = <span class="number">0x04</span>,</span><br><span class="line">    EV_FEATURE_EARLY_CLOSE = <span class="number">0x08</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_config_require_features</span><span class="params">(struct event_config *cfg, <span class="keyword">int</span> features)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> event_base_config_flag &#123;</span><br><span class="line">	EVENT_BASE_FLAG_NOLOCK = <span class="number">0x01</span>,</span><br><span class="line">	EVENT_BASE_FLAG_IGNORE_ENV = <span class="number">0x02</span>,</span><br><span class="line">	EVENT_BASE_FLAG_STARTUP_IOCP = <span class="number">0x04</span>,</span><br><span class="line">	EVENT_BASE_FLAG_NO_CACHE_TIME = <span class="number">0x08</span>,</span><br><span class="line">	EVENT_BASE_FLAG_EPOLL_USE_CHANGELIST = <span class="number">0x10</span>,</span><br><span class="line">	EVENT_BASE_FLAG_PRECISE_TIMER = <span class="number">0x20</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_config_set_flag</span><span class="params">(struct event_config *cfg, <span class="keyword">int</span> flag)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>event_config_avoid_method()可通过名字让libevent避免使用特定的可用后端。<br>event_config_require_features()可让libevent不使用不能提供所有指定特征的后端。<br>event_config_set_flag()让libevent在创建event_base时设置一个或多个运行时标志。</p>
<h3 id="event-config-require-features"><a href="#event-config-require-features" class="headerlink" title="event_config_require_features()"></a>event_config_require_features()</h3><p>可识别的选项值有：</p>
<ol>
<li>EV_FEATURE_ET 要求支持ET模式的后端（边沿触发）</li>
<li>EV_FEATURE_O1 要求添加、删除单个事件，或者确定哪个事件激活的操作时O(1)复杂度的后端</li>
<li>EV_FEATURE_FDS 要求支持任意文件描述符，而不仅仅是套接字的后端</li>
<li>EV_FEATURE_EARLY_CLOSE 要求后台方法可以使用EV_CLOSED检测链接关闭，而不需要读完所有未决数据才能判断 支持EV_CLOSED的后台方法不是所有OS内核都支持的</li>
</ol>
<p>设置成功返回0，失败返回-1</p>
<h3 id="event-config-set-flag"><a href="#event-config-set-flag" class="headerlink" title="event_config_set_flag()"></a>event_config_set_flag()</h3><p>可识别的选项值有：</p>
<ol>
<li>EVENT_BASE_FLAG_NOLOCK 不要为 event_base分配锁.设置这个选项可以为event_base节省一点用于锁定和解锁的时间,但是让在多个线程中访问 event_base成为不安全的</li>
<li>EVENT<em>BASE_FLAG_IGNORE_ENV 选择使用的后端时,不要检测``EVENT</em>*``环境变量.</li>
<li>EVENT_BASE_FLAG_STARTUP_IOCP 仅用于 Windows,让 libevent在启动时就启用任何必需的IOCP分发逻辑,而不是按需启用</li>
<li>EVENT_BASE_FLAG_NO_CACHE_TIME 不是在事件循环每次准备执行超时回调时检测当前时间,而是在每次超时回调后进行检测.注意:这会消耗更多的CPU时间</li>
<li>EVENT_BASE_FLAG_EPOLL_USE_CHANGELIST 如果决定使用epoll后端,可以安全地使用更快的基于 changelist的后端.epoll-changelist后端可以在后端的分发函数调用之间,同样的fd多次修改其状态的情况下,避免不必要的系统调用.但是如果传递任何使用 dup ()或者其变体克隆的 fd给libevent, epoll-changelist后端会触发一个内核bug,导致不正确的结果.在不使用epoll后端的情况下,这个标志是没有效果的.也可以通过设置 EVENT_EPOLL_USE_CHANGELIST:环境变量来打开epoll-changelist选项.</li>
<li>EVENT_BASE_FLAG_PRECISE_TIMER 使用更加精确的定时机制</li>
</ol>
<p>设置成功返回0，失败返回-1</p>
<h3 id="获得特定event-base的配置信息"><a href="#获得特定event-base的配置信息" class="headerlink" title="获得特定event_base的配置信息"></a>获得特定event_base的配置信息</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">event_base_get_method</span><span class="params">(<span class="keyword">const</span> struct event_base *base)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_base_get_features</span><span class="params">(<span class="keyword">const</span> struct event_base *base)</span></span>;</span><br></pre></td></tr></table></figure>
<p>event_base_get_method返回一个指针,指向event_base所选择的后端的名称<br>event_base_get_features返回event_base所选后端支持的特征值的比特掩码</p>
<p><a href="https://github.com/CaseZheng/Study/blob/master/Libevent/libevent_timer_signal.cpp" target="_blank" rel="noopener">示例代码</a></p>
<h1 id="运行循环"><a href="#运行循环" class="headerlink" title="运行循环"></a>运行循环</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EVLOOP_ONCE	0x01</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EVLOOP_NONBLOCK	0x02</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EVLOOP_NO_EXIT_ON_EMPTY 0x04</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_base_loop</span><span class="params">(struct event_base *base, <span class="keyword">int</span> flags)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_base_dispatch</span> <span class="params">(struct event_base *base)</span></span>;</span><br></pre></td></tr></table></figure>
<p>event_base_loop会运行一个event_base直到没有event注册进来，循环运行，不断重复判断是否有注册的event触发。<br>flags标记可改变event_base_loop的行为：</p>
<ol>
<li>EVLOOP_ONCE 循环将等待某些事件成为激活的，执行激活的事件直到没有更多的事件可以执行，然会返回</li>
<li>EVLOOP_NONBLOCK：循环不等待事件被触发，循环将仅仅检测是否有事件已经就绪，可以立即触发，如果有，则执行事件的回调。</li>
<li>EVLOOP_NO_EXIT_ON_EMPTY：没有事件仍不退出，而是由其他函数触发退出</li>
</ol>
<p>event_base_dispatch采用默认的配置调用event_base_loop();<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_base_dispatch</span><span class="params">(struct event_base *event_base)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (event_base_loop(event_base, <span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="停止循环"><a href="#停止循环" class="headerlink" title="停止循环"></a>停止循环</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_base_loopexit</span><span class="params">(struct event_base *event_base, <span class="keyword">const</span> struct timeval *tv)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_base_loopbreak</span><span class="params">(struct event_base *event_base)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_base_got_break</span><span class="params">(struct event_base *event_base)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_base_got_exit</span><span class="params">(struct event_base *event_base)</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="event-base-loopexit"><a href="#event-base-loopexit" class="headerlink" title="event_base_loopexit()"></a>event_base_loopexit()</h2><p>要求event_base在指定时间后停止，如果tv为NULL，则立即停止。但该函数实际会使部分event_base在执行完全部的callback之后才返回。</p>
<h2 id="event-base-loopbreak"><a href="#event-base-loopbreak" class="headerlink" title="event_base_loopbreak()"></a>event_base_loopbreak()</h2><p>要求event_base立即停止，无视其他的active事件而停止。如果当前没有callback，则会导致event_base等到执行完下一个callback之后才退出。</p>
<h2 id="event-base-got-break-和-event-base-got-exit"><a href="#event-base-got-break-和-event-base-got-exit" class="headerlink" title="event_base_got_break() 和 event_base_got_exit()"></a>event_base_got_break() 和 event_base_got_exit()</h2><p>event_base_got_break 如果循环因为event_base_loopbreak()退出，event_base_got_break返回true，否则返回false<br>event_base_got_exit 如果循环因为event_base_loopexit()退出，event_base_got_exit返回true，否则返回false</p>
<p><a href="https://github.com/CaseZheng/Study/blob/master/Libevent/libevent_timer_signal.cpp" target="_blank" rel="noopener">示例代码</a></p>
<h1 id="event"><a href="#event" class="headerlink" title="event"></a>event</h1><h2 id="event简介"><a href="#event简介" class="headerlink" title="event简介"></a>event简介</h2><p>libevent的基本操作单元是事件event，每个事件代表一组条件：</p>
<ol>
<li>文件描述符已经就绪，可以读取或者写入</li>
<li>文件描述符变为就绪状态，可以读取或者写入（仅对于边沿触发IO）</li>
<li>超时事件</li>
<li>信号</li>
<li>用户手动触发</li>
</ol>
<p>当一个event被设置好，并且关联到一个event_base里面时，它被称为“initialized”。此时你可以执行add，这使得它进入pending(等待、未决的)状态。当event被触发或超时时，它的状态称为active，这个情况下对应的callback会被调用。如果event被配置为persist，那么它在callback执行前后都会保持pending的状态。可以通过delete来使得一个event从pending状态重新变成nonpending。</p>
<h2 id="event-API-介绍"><a href="#event-API-介绍" class="headerlink" title="event API 介绍"></a>event API 介绍</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*event_callback_fn)</span><span class="params">(<span class="keyword">evutil_socket_t</span>, short, <span class="keyword">void</span> *)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">struct event * <span class="title">event_new</span><span class="params">(struct event_base *base, \</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">evutil_socket_t</span> fd, \</span></span></span><br><span class="line"><span class="function"><span class="params">    short events, \</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">void</span> (*cb)(<span class="keyword">evutil_socket_t</span>, short, <span class="keyword">void</span> *), \</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">event_free</span><span class="params">(struct event *ev)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="event创建-event-new"><a href="#event创建-event-new" class="headerlink" title="event创建 event_new"></a>event创建 event_new</h3><p>event_new 创建一个新的event。其中fd是文件描述符，需要自行初始化之后再作为参数传入。event_free()释放event的资源。如果event是active或者是pending状态，则函数会将event先变成非active且非pending的状态，然后再释放它。<br>参数events表示event的需要关注绑定该fd上的哪些事件。</p>
<ol>
<li>EV_TIMEOUT：超时</li>
<li>EV_READ：有数据可读</li>
<li>EV_WRITE：数据可写</li>
<li>EV_SIGNAL：系统发出的信号（signal）</li>
<li>EV_PERSIST：持续事件</li>
<li>EV_ET：边沿触发</li>
</ol>
<p>cb是event被触发后调用的回调函数，cb的类型为event_callback_fn。<br>arg为用户数据在调用回调函数时传给回调函数。</p>
<h3 id="EV-PERSIST-事件持久化"><a href="#EV-PERSIST-事件持久化" class="headerlink" title="EV_PERSIST 事件持久化"></a>EV_PERSIST 事件持久化</h3><p>默认情况下，每当未决事件成为激活的(因为fd已经准备好读取或者写入,或者因为超时),事件将在其回调被执行前成为非未决的。如果想让事件再次成为未决的,可以在回调函数中再次对其调用event_add()。<br>如果设置了EV_PERSIST标志,事件就是持久的。这意味着即使其回调被激活,事件还是会保持为未决状态。如果想在回调中让事件成为非未决的,可以对其调用event_del()。每次执行事件回调的时候,持久事件的超时值会被复位。</p>
<h3 id="超时事件的创建"><a href="#超时事件的创建" class="headerlink" title="超时事件的创建"></a>超时事件的创建</h3><p>纯超时事件不需要fd（传-1即可）。libevent定义了创建超时事件的宏：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> evtimer_assign(ev, b, cb, arg) \</span></span><br><span class="line">	event_assign((ev), (b), <span class="number">-1</span>, <span class="number">0</span>, (cb), (arg))</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> evtimer_new(b, cb, arg)	       event_new((b), -1, 0, (cb), (arg))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> evtimer_add(ev, tv)		event_add((ev), (tv))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> evtimer_del(ev)			event_del(ev)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> evtimer_pending(ev, tv)		event_pending((ev), EV_TIMEOUT, (tv))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> evtimer_initialized(ev)		event_initialized(ev)</span></span><br></pre></td></tr></table></figure></p>
<h3 id="信号事件的创建"><a href="#信号事件的创建" class="headerlink" title="信号事件的创建"></a>信号事件的创建</h3><p>信号事件不需要传入fd，而是传入signum。libevent定义了创建信号事件的宏：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> evsignal_add(ev, tv)		event_add((ev), (tv))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> evsignal_assign(ev, b, x, cb, arg)			\</span></span><br><span class="line">	event_assign((ev), (b), (x), EV_SIGNAL|EV_PERSIST, cb, (arg))</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> evsignal_new(b, x, cb, arg)				\</span></span><br><span class="line">	event_new((b), (x), EV_SIGNAL|EV_PERSIST, (cb), (arg))</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> evsignal_del(ev)		event_del(ev)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> evsignal_pending(ev, tv)	event_pending((ev), EV_SIGNAL, (tv))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> evsignal_initialized(ev)	event_initialized(ev)</span></span><br></pre></td></tr></table></figure></p>
<h3 id="事件的初始化"><a href="#事件的初始化" class="headerlink" title="事件的初始化"></a>事件的初始化</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_assign</span><span class="params">(struct event *, struct event_base *, <span class="keyword">evutil_socket_t</span>, short, event_callback_fn, <span class="keyword">void</span> *)</span></span>;</span><br></pre></td></tr></table></figure>
<p>可以使用event_new在创建event时初始化event，也可以使用event_assign初始化未初始化的event，event_assign的参数与event_new的参数意义相同。<br>不要对已经在event_base中未决的事件调用event_assign(),这可能会导致难以诊断的错误。如果已经初始化和成为未决的,调用event_assign()之前需要调用event_del()。libevent提供了方便的宏将event_assign()用于仅超时事件或者信号事件。</p>
<h3 id="event添加监听与取消监听"><a href="#event添加监听与取消监听" class="headerlink" title="event添加监听与取消监听"></a>event添加监听与取消监听</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_add</span><span class="params">(struct event *ev, <span class="keyword">const</span> struct timeval *tv)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> evtimer_add(ev, tv)		event_add((ev), (tv))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> evsignal_add(ev, tv)		event_add((ev), (tv))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_del</span><span class="params">(struct event *ev)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> evtimer_del(ev)			event_del(ev)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> evsignal_del(ev)		event_del(ev)</span></span><br></pre></td></tr></table></figure>
<p>event_add 添加事件监听, tv为指定的超时值，如果为NULL表示不超时。event_del 取消事件监听。</p>
<h3 id="event设置优先级"><a href="#event设置优先级" class="headerlink" title="event设置优先级"></a>event设置优先级</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_priority_init</span><span class="params">(<span class="keyword">int</span> npriorities)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_priority_set</span><span class="params">(struct event *ev, <span class="keyword">int</span> pri)</span></span>;</span><br></pre></td></tr></table></figure>
<p>event_priority_init()初始化优先级等级。即设置event_base的优先级数目<br>event_priority_set()设置ev的优先级。pri是[0, npriorities)的一个值。</p>
<h3 id="event状态检测"><a href="#event状态检测" class="headerlink" title="event状态检测"></a>event状态检测</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_pending</span><span class="params">(<span class="keyword">const</span> struct event *ev, short event, struct timeval *tv)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">evutil_socket_t</span> <span class="title">event_get_fd</span><span class="params">(<span class="keyword">const</span> struct event *ev)</span></span>;</span><br><span class="line"><span class="function">struct event_base *<span class="title">event_get_base</span><span class="params">(<span class="keyword">const</span> struct event *ev)</span></span>;</span><br><span class="line"><span class="function">short <span class="title">event_get_events</span><span class="params">(<span class="keyword">const</span> struct event *ev)</span></span>;</span><br><span class="line"><span class="function">event_callback_fn <span class="title">event_get_callback</span><span class="params">(<span class="keyword">const</span> struct event *ev)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">event_get_callback_arg</span><span class="params">(<span class="keyword">const</span> struct event *ev)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_get_priority</span><span class="params">(<span class="keyword">const</span> struct event *ev)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">event_get_assignment</span><span class="params">(<span class="keyword">const</span> struct event *event, struct event_base **base_out, <span class="keyword">evutil_socket_t</span> *fd_out, short *events_out, event_callback_fn *callback_out, <span class="keyword">void</span> **arg_out)</span></span>;</span><br></pre></td></tr></table></figure>
<h4 id="event-pending"><a href="#event-pending" class="headerlink" title="event_pending"></a>event_pending</h4><p>event_pending函数确定给出的event是未决的还是活动的.如果EV_READ、EV_WRITE、EV_SIGNAL、EV_TIMEOUT被设置为event参数,函数会返回event是未决的或者活动的所有标志.如果提供了tv_out并且设置了EV_TIMEOUT标志给event参数,当前event是未决的或者活跃在超时上,tv_out设置为保存event超时后的时间。</p>
<h4 id="event-get-fd"><a href="#event-get-fd" class="headerlink" title="event_get_fd"></a>event_get_fd</h4><p>函数返回了event配置的文件描述符或者信号值。</p>
<h4 id="event-get-base"><a href="#event-get-base" class="headerlink" title="event_get_base"></a>event_get_base</h4><p>返回event配置的event_base。</p>
<h4 id="event-get-events"><a href="#event-get-events" class="headerlink" title="event_get_events"></a>event_get_events</h4><p>返回事件的标志(EV_READ、EV_WRITE等)</p>
<h4 id="event-get-callback-和-event-get-callback-arg"><a href="#event-get-callback-和-event-get-callback-arg" class="headerlink" title="event_get_callback 和 event_get_callback_arg"></a>event_get_callback 和 event_get_callback_arg</h4><p>event_get_callback()和event_get_callback_arg()函数返回了event的回掉函数和它的参数指针</p>
<h4 id="event-get-priority"><a href="#event-get-priority" class="headerlink" title="event_get_priority"></a>event_get_priority</h4><p>返回了事件当前分配的优先级</p>
<h4 id="event-get-assignment"><a href="#event-get-assignment" class="headerlink" title="event_get_assignment"></a>event_get_assignment</h4><p>拷贝了event分配的所有字段到提供的指针。如果指针为空,则忽略。</p>
<h2 id="手动激活事件"><a href="#手动激活事件" class="headerlink" title="手动激活事件"></a>手动激活事件</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">event_active</span><span class="params">(struct event *ev, <span class="keyword">int</span> res, short ncalls)</span></span>;</span><br></pre></td></tr></table></figure>
<p>使ev以标志res(EV_READ、EV_WRITE、EV_TIMEOUT的组合)激活,ev不需要预先的被未决,激活event也不需要使其未决。</p>
<h1 id="evbuffer"><a href="#evbuffer" class="headerlink" title="evbuffer"></a>evbuffer</h1><p>evbuffer 用于处理缓冲网络 IO 的”缓冲”部分.</p>
<h2 id="创建和释放evbuffer"><a href="#创建和释放evbuffer" class="headerlink" title="创建和释放evbuffer"></a>创建和释放evbuffer</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct evbuffer * <span class="title">evbuffer_new</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">evbuffer_free</span><span class="params">(struct evbuffer *<span class="built_in">buffer</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>evbuffer_new() 分配和返回一个新的空evbuffer;而evbuffer_free()释放evbuffer和其内容</p>
<h2 id="evbuffer与线程安全"><a href="#evbuffer与线程安全" class="headerlink" title="evbuffer与线程安全"></a>evbuffer与线程安全</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_enable_locking</span><span class="params">(struct evbuffer *buf, <span class="keyword">void</span> *lock)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">evbuffer_lock</span><span class="params">(struct evbuffer *buf)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">evbuffer_unlock</span><span class="params">(struct evbuffer *buf)</span></span>;</span><br></pre></td></tr></table></figure>
<p>默认情况下，在多个线程中同时访问 evbuffer 是不安全的。如果需要这样的访问，可以调用 evbuffer_enable_locking() 。 如果lock参数为NULL,libevent会使用evthread_set_lock_creation_callback 提供的锁创建函数创建一个锁.否则,libevent将lock参数用作锁。evbuffer_lock()和 evbuffer_unlock()函数分别请求和释放 evbuffer 上的锁。可以使用这两个函数让一系列操作是原子的。如果 evbuffer 没有启用锁，这两个函数不做任何操作。<br>注意：对于单个操作，不需要调用evbuffer_lock()和evbuffer_unlock()：如果evbuffer启用了锁，单个操作就已经是原子的。只有在需要多个操作连续执行，不让其他线程介入的时候，才需要手动锁定evbuffer</p>
<h2 id="检查evbuffer"><a href="#检查evbuffer" class="headerlink" title="检查evbuffer"></a>检查evbuffer</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">evbuffer_get_length</span><span class="params">(<span class="keyword">const</span> struct evbuffer *<span class="built_in">buffer</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>返回evbuffer存储的字节数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">evbuffer_get_contiguous_space</span><span class="params">(<span class="keyword">const</span> struct evbuffer *buf)</span></span>;</span><br></pre></td></tr></table></figure>
<p>返回连续地存储在 evbuffer 前面的字节数。evbuffer 中的数据可能存储在多个分隔开的内存块中，这个函数返回当前第一个块中的字节数</p>
<h2 id="向evbuffer添加数据"><a href="#向evbuffer添加数据" class="headerlink" title="向evbuffer添加数据"></a>向evbuffer添加数据</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_add</span><span class="params">(struct evbuffer *buf, <span class="keyword">const</span> <span class="keyword">void</span> *data_in, <span class="keyword">size_t</span> datlen)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_add_printf</span><span class="params">(struct evbuffer *buf, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_add_vprintf</span><span class="params">(struct evbuffer *buf, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, va_list ap)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_expand</span><span class="params">(struct evbuffer *buf, <span class="keyword">size_t</span> datlen)</span></span>;</span><br></pre></td></tr></table></figure>
<p>evbuffer_add()添加data处的datlen字节到buf的末尾.<br>evbuffer_add_printf()和evbuffer_add_vprintf()添加格式化的数据到buf末尾.<br>evbuffer_expand()修改缓冲区最后一块,或者添加一个新的块,使缓冲区足以容纳datlen字节,而不需要更多的内存分配</p>
<h2 id="将数据从一个evbuffer移动到另一个"><a href="#将数据从一个evbuffer移动到另一个" class="headerlink" title="将数据从一个evbuffer移动到另一个"></a>将数据从一个evbuffer移动到另一个</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_add_buffer</span><span class="params">(struct evbuffer *outbuf, struct evbuffer *inbuf)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_remove_buffer</span><span class="params">(struct evbuffer *src, struct evbuffer *dst, <span class="keyword">size_t</span> datlen)</span></span>;</span><br></pre></td></tr></table></figure>
<p>evbuffer_add_buffer()将inbuf的所有数据移动到outbuf末尾.<br>evbuffer_remove_buffer()从src中移动datlen字节到dst末尾,尽量少进行复制.如果字节数小于datlen,所有字节被移动.</p>
<h2 id="添加数据到evbuffer前面"><a href="#添加数据到evbuffer前面" class="headerlink" title="添加数据到evbuffer前面"></a>添加数据到evbuffer前面</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_prepend</span><span class="params">(struct evbuffer *buf, <span class="keyword">const</span> <span class="keyword">void</span> *data, <span class="keyword">size_t</span> datlen)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_prepend_buffer</span><span class="params">(struct evbuffer *outbuf, struct evbuffer *inbuf)</span></span>;</span><br></pre></td></tr></table></figure>
<p>将数据移动到目标缓冲区前面</p>
<h2 id="从evbuffer中移除数据"><a href="#从evbuffer中移除数据" class="headerlink" title="从evbuffer中移除数据"></a>从evbuffer中移除数据</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_drain</span><span class="params">(struct evbuffer *buf, <span class="keyword">size_t</span> len)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_remove</span><span class="params">(struct evbuffer *buf, <span class="keyword">void</span> *data_out, <span class="keyword">size_t</span> datlen)</span></span>;</span><br></pre></td></tr></table></figure>
<p>evbuffer_drain()函数从buf前面移除len字节内存<br>evbuffer_remove()函数从buf前面复制和移除datlen字节到data_out处的内存中.如果可用字节少于datlen,复制所有字节.</p>
<h2 id="从evbuffer中复制出数据"><a href="#从evbuffer中复制出数据" class="headerlink" title="从evbuffer中复制出数据"></a>从evbuffer中复制出数据</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ev_ssize_t</span> <span class="title">evbuffer_copyout</span><span class="params">(struct evbuffer *buf, <span class="keyword">void</span> *data_out, <span class="keyword">size_t</span> datlen)</span></span>;</span><br></pre></td></tr></table></figure>
<p>前面复制 datlen 字节到 data_out 处的内存中。如果可用字节少于 datlen，函数会复制所有字节。失败时返回-1，否则返回复制的字节数。</p>
<h2 id="面向行的输入"><a href="#面向行的输入" class="headerlink" title="面向行的输入"></a>面向行的输入</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> evbuffer_eol_style &#123;</span><br><span class="line">	EVBUFFER_EOL_ANY,</span><br><span class="line">	EVBUFFER_EOL_CRLF,</span><br><span class="line">	EVBUFFER_EOL_CRLF_STRICT,</span><br><span class="line">	EVBUFFER_EOL_LF,</span><br><span class="line">	EVBUFFER_EOL_NUL</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> * <span class="title">evbuffer_readln</span><span class="params">(struct evbuffer *<span class="built_in">buffer</span>, <span class="keyword">size_t</span> *n_read_out, <span class="keyword">enum</span> evbuffer_eol_style eol_style)</span></span>;</span><br></pre></td></tr></table></figure>
<p>evbuffer_readln()函数从 evbuffer 前面取出一行，用一个新分配的空字符结束的字符串返回这一行。如果 n_read_out 不是 NULL，则它被设置为返回的字符串的字节数。如果没有整行供读取，函数返回空。返回的字符串不包括行结束符。evbuffer_readln()理解4种行结束格式</p>
<ol>
<li>EVBUFFER_EOL_ANY,行尾是单个换行符</li>
<li>EVBUFFER_EOL_CRLF,行尾是一个回车符，后随一个换行符</li>
<li>EVBUFFER_EOL_CRLF_STRICT,行尾是一个可选的回车，后随一个换行符</li>
<li>EVBUFFER_EOL_LF,行尾是任意数量、任意次序的回车和换行符。</li>
</ol>
<h2 id="在evbuffer中搜索"><a href="#在evbuffer中搜索" class="headerlink" title="在evbuffer中搜索"></a>在evbuffer中搜索</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">evbuffer_ptr</span> &#123;</span></span><br><span class="line">	<span class="keyword">ev_ssize_t</span> pos;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">		<span class="keyword">void</span> *chain;</span><br><span class="line">		<span class="keyword">size_t</span> pos_in_chain;</span><br><span class="line">	&#125; internal_;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">struct evbuffer_ptr <span class="title">evbuffer_search</span><span class="params">(struct evbuffer *<span class="built_in">buffer</span>, <span class="keyword">const</span> <span class="keyword">char</span> *what, <span class="keyword">size_t</span> len, <span class="keyword">const</span> struct evbuffer_ptr *start)</span></span>;</span><br><span class="line"><span class="function">struct evbuffer_ptr <span class="title">evbuffer_search_range</span><span class="params">(struct evbuffer *<span class="built_in">buffer</span>, <span class="keyword">const</span> <span class="keyword">char</span> *what, <span class="keyword">size_t</span> len, <span class="keyword">const</span> struct evbuffer_ptr *start, <span class="keyword">const</span> struct evbuffer_ptr *<span class="built_in">end</span>)</span></span>;</span><br><span class="line"><span class="function">struct evbuffer_ptr <span class="title">evbuffer_search_eol</span><span class="params">(struct evbuffer *<span class="built_in">buffer</span>, struct evbuffer_ptr *start, <span class="keyword">size_t</span> *eol_len_out, <span class="keyword">enum</span> evbuffer_eol_style eol_style)</span></span>;</span><br></pre></td></tr></table></figure>
<p>evbuffer_search()函数在缓冲区中查找含有 len 个字符的字符串 what。函数返回包含字符串位置，或者在没有找到字符串时包含-1的 evbuffer_ptr 结构体。如果提供了 start 参数，则从指定的位置开始搜索；否则，从开始处进行搜索。<br>evbuffer_search_range()函数和 evbuffer_search 行为相同，只是它只考虑在 end 之前出现 的 what。<br>evbuffer_search_eol()函数像 evbuffer_readln()一样检测行结束，但是不复制行，而是返回指向行结束符的 evbuffer_ptr。如果 eol_len_out 非空，则它被设置为 EOL 字符串长度。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> evbuffer_ptr_how &#123;</span><br><span class="line">	EVBUFFER_PTR_SET,</span><br><span class="line">	EVBUFFER_PTR_ADD</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_ptr_set</span><span class="params">(struct evbuffer *buf, struct evbuffer_ptr *pos, <span class="keyword">size_t</span> <span class="built_in">position</span>, <span class="keyword">enum</span> evbuffer_ptr_how how)</span></span>;</span><br></pre></td></tr></table></figure>
<p>evbuffer_ptr_set 函数操作 buffer 中的位置 pos。如果 how 等于 EVBUFFER_PTR_SET,指针被移动到缓冲区中的绝对位置 position；如果等于 EVBUFFER_PTR_ADD，则向前移动 position 字节。成功时函数返回0，失败时返回-1。<br>任何修改 evbuffer 或者其布局的调用都会使得 evbuffer_ptr 失效，不能再安全地使用。</p>
<h2 id="检测数据而不复制"><a href="#检测数据而不复制" class="headerlink" title="检测数据而不复制"></a>检测数据而不复制</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">evbuffer_iovec</span> &#123;</span></span><br><span class="line">	<span class="keyword">void</span> *iov_base;</span><br><span class="line">	<span class="keyword">size_t</span> iov_len;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_peek</span><span class="params">(struct evbuffer *<span class="built_in">buffer</span>, <span class="keyword">ev_ssize_t</span> len, struct evbuffer_ptr *start_at, struct evbuffer_iovec *vec, <span class="keyword">int</span> n_vec)</span></span>;</span><br></pre></td></tr></table></figure>
<p>调用 evbuffer_peek()的时候，通过 vec_out 给定一个 evbuffer_iovec 数组，数组的长度是n_vec。函数会让每个结构体包含指向 evbuffer 内部内存块的指针（iov_base)和块中数据长度。如果 len 小于0，evbuffer_peek()会试图填充所有 evbuffer_iovec 结构体。否则，函数会进行填充，直到使用了所有结构体，或者见到 len 字节为止。如果函数可以给出所有请求的数据，则返回实际使用的结构体个数；否则，函数返回给出所有请求数据所需的结构体个数。如果 ptr 为 NULL，函数从缓冲区开始处进行搜索。否则，从 ptr 处开始搜索。</p>
<ol>
<li>修改 evbuffer_iovec 所指的数据会导致不确定的行为</li>
<li>如果任何函数修改了 evbuffer，则 evbuffer_peek()返回的指针会失效</li>
<li>如果在多个线程中使用evbuffer，确保在调用evbuffer_peek()之前使用evbuffer_lock()，在使用完evbuffer_peek()给出的内容之后进行解锁.</li>
</ol>
<h2 id="直接向evbuffer添加数据"><a href="#直接向evbuffer添加数据" class="headerlink" title="直接向evbuffer添加数据"></a>直接向evbuffer添加数据</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_reserve_space</span><span class="params">(struct evbuffer *buf, <span class="keyword">ev_ssize_t</span> <span class="built_in">size</span>, struct evbuffer_iovec *vec, <span class="keyword">int</span> n_vecs)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_commit_space</span><span class="params">(struct evbuffer *buf, struct evbuffer_iovec *vec, <span class="keyword">int</span> n_vecs)</span></span>;</span><br></pre></td></tr></table></figure>
<p>evbuffer_reserve_space()函数给出 evbuffer 内部空间的指针。函数会扩展缓冲区以至少提供 size 字节的空间。到扩展空间的指针，以及其长度，会存储在通过 vec 传递的向量数组中，n_vec 是数组的长度。n_vec 的值必须至少是1。如果只提供一个向量，libevent 会确保请求的所有连续空间都在单个扩展区中，但是这可能要求重新排列缓冲区，或者浪费内存。为取得更好的性能，应该至少提供2个向量。函数返回提供请求的空间所需的向量数。<br>写入到向量中的数据不会是缓冲区的一部分，直到调用 evbuffer_commit_space()，使得写入的数据进入缓冲区。如果需要提交少于请求的空间，可以减小任何 evbuffer_iovec 结构体的 iov_len 字段，也可以提供较少的向量。函数成功时返回0，失败时返回-1。</p>
<ol>
<li>调用任何重新排列evbuffer或者向其添加数据的函数都将使从 evbuffer_reserve_space()获取的指针失效。</li>
<li>当前实现中，不论用户提供多少个向量，evbuffer_reserve_space()从不使用多于两个。未来版本可能会改变这一点。</li>
<li>如果在多个线程中使用evbuffer，确保在调用evbuffer_reserve_space()之前使用 evbuffer_lock()进行锁定，然后在提交后解除锁定</li>
</ol>
<h2 id="使用evbuffer的网络IO"><a href="#使用evbuffer的网络IO" class="headerlink" title="使用evbuffer的网络IO"></a>使用evbuffer的网络IO</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_write</span><span class="params">(struct evbuffer *<span class="built_in">buffer</span>, <span class="keyword">evutil_socket_t</span> fd)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_write_atmost</span><span class="params">(struct evbuffer *<span class="built_in">buffer</span>, <span class="keyword">evutil_socket_t</span> fd, <span class="keyword">ev_ssize_t</span> howmuch)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_read</span><span class="params">(struct evbuffer *buf, <span class="keyword">evutil_socket_t</span> fd, <span class="keyword">int</span> howmuch)</span></span>;</span><br></pre></td></tr></table></figure>
<p>vbuffer_read()函数从套接字 fd 读取至多 howmuch 字节到 buffer 末尾。成功时函数返回读取的字节数，0表示 EOF，失败时返回-1。注意，错误码可能指示非阻塞操作不能立即成功，应该检查错误码 EAGAIN（或者 Windows 中的 WSAWOULDBLOCK）。如果 howmuch 为负，evbuffer_read()试图猜测要读取多少数据。evbuffer_write_atmost()函数试图将 buffer 前面至多 howmuch 字节写入到套接字 fd 中。成功时函数返回写入的字节数，失败时返回-1。跟 evbuffer_read()一样，应该检查错误码，看是真的错误，还是仅仅指示非阻塞 IO 不能立即完成。如果为 howmuch 给出负值，函数会试图写入 buffer 的所有内容。调用 evbuffer_write()与使用负的 howmuch 参数调用 evbuffer_write_atmost()一样：函数会试图尽量清空 buffer 的内容。在 Unix 中，这些函数应该可以在任何支持 read 和 write 的文件描述符上正确工作。在 Windows 中，仅仅支持套接字.</p>
<h2 id="evbuffer和回调"><a href="#evbuffer和回调" class="headerlink" title="evbuffer和回调"></a>evbuffer和回调</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">evbuffer_cb_info</span> &#123;</span></span><br><span class="line">	<span class="keyword">size_t</span> orig_size;</span><br><span class="line">	<span class="keyword">size_t</span> n_added;</span><br><span class="line">	<span class="keyword">size_t</span> n_deleted;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*evbuffer_cb_func)</span><span class="params">(struct evbuffer *<span class="built_in">buffer</span>, <span class="keyword">const</span> struct evbuffer_cb_info *info, <span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">evbuffer_cb_entry</span> &#123;</span></span><br><span class="line">	LIST_ENTRY(evbuffer_cb_entry) next;</span><br><span class="line">	<span class="keyword">union</span> &#123;</span><br><span class="line">		evbuffer_cb_func cb_func;</span><br><span class="line">		evbuffer_cb cb_obsolete;</span><br><span class="line">	&#125; cb;</span><br><span class="line">	<span class="keyword">void</span> *cbarg;</span><br><span class="line">	<span class="keyword">ev_uint32_t</span> flags;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">struct evbuffer_cb_entry * <span class="title">evbuffer_add_cb</span><span class="params">(struct evbuffer *<span class="built_in">buffer</span>, evbuffer_cb_func cb, <span class="keyword">void</span> *cbarg)</span></span>;</span><br></pre></td></tr></table></figure>
<p>向 evbuffer 添加数据，或者从中移除数据的时候，回调函数会被调用。函数收到缓冲区指针、一个 evbuffer_cb_info 结构体指针，和用户提供的参数。evbuffer_cb_info 结构体的 orig_size 字段指示缓冲区改变大小前的字节数，n_added 字段指示向缓冲区添加了多少字节；n_deleted 字段指示移除了多少字节。</p>
<p>evbuffer_add_cb()函数为 evbuffer 添加一个回调函数，返回一个不透明的指针，随后可用于代表这个特定的回调实例。cb 参数是将被调用的函数，cbarg 是用户提供的将传给这个函数的指针。可以为单个 evbuffer 设置多个回调，添加新的回调不会移除原来的回调<br>注意：释放非空 evbuffer 不会清空其数据，释放 evbuffer 也不会为回调释放用户提供的数据指针。如果不想让缓冲区上的回调永远激活，可以移除或者禁用回调：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_remove_cb_entry</span><span class="params">(struct evbuffer *<span class="built_in">buffer</span>, struct evbuffer_cb_entry *ent)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_remove_cb</span><span class="params">(struct evbuffer *<span class="built_in">buffer</span>, evbuffer_cb_func cb, <span class="keyword">void</span> *cbarg)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EVBUFFER_CB_ENABLED 1</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_cb_set_flags</span><span class="params">(struct evbuffer *<span class="built_in">buffer</span>, struct evbuffer_cb_entry *cb, <span class="keyword">ev_uint32_t</span> flags)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_cb_clear_flags</span><span class="params">(struct evbuffer *<span class="built_in">buffer</span>, struct evbuffer_cb_entry *cb, <span class="keyword">ev_uint32_t</span> flags)</span></span>;</span><br></pre></td></tr></table></figure>
<p>可以通过添加回调时候的 evbuffer_cb_entry 来移除回调，也可以通过回调函数和参数指针来移除。成功时函数返回0，失败时返回-1。evbuffer_cb_set_flags()和 evbuffer_cb_clear_flags()函数分别为回调函数设置或者清除给定的标志。当前只有一个标志是用户可见的：EVBUFFER_CB_ENABLED。这个标志默认是打开的。如果清除这个标志，对 evbuffer 的修改不会调用回调函数.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_defer_callbacks</span><span class="params">(struct evbuffer *<span class="built_in">buffer</span>, struct event_base *base)</span></span>;</span><br></pre></td></tr></table></figure>
<p>跟 bufferevent 回调一样，可以让 evbuffer 回调不在 evbuffer 被修改时立即运行，而是延迟到某 event_base 的事件循环中执行。如果有多个 evbuffer，它们的回调潜在地让数据添加到 evbuffer 中，或者从中移除，又要避免栈崩溃，延迟回调是很有用的。如果回调被延迟，则最终执行时，它可能是多个操作结果的总和。与 bufferevent 一样，evbuffer 具有内部引用计数的，所以即使还有未执行的延迟回调，释放 evbuffer 也是安全的。</p>
<h2 id="为基于evbuffer的IO避免数据复制"><a href="#为基于evbuffer的IO避免数据复制" class="headerlink" title="为基于evbuffer的IO避免数据复制"></a>为基于evbuffer的IO避免数据复制</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*evbuffer_ref_cleanup_cb)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *data, <span class="keyword">size_t</span> datalen, <span class="keyword">void</span> *extra)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evbuffer_add_reference</span><span class="params">(struct evbuffer *outbuf, <span class="keyword">const</span> <span class="keyword">void</span> *data, <span class="keyword">size_t</span> datlen, evbuffer_ref_cleanup_cb cleanupfn, <span class="keyword">void</span> *extra)</span></span>;</span><br></pre></td></tr></table></figure>
<p>通过引用向 evbuffer 末尾添加一段数据。不会进行复制：evbuffer 只会存储一个到data 处的 datlen 字节的指针。因此，在 evbuffer 使用这个指针期间，必须保持指针是有效的。evbuffer 会在不再需要这部分数据的时候调用用户提供的 cleanupfn 函数，带有提供的data 指针、datlen 值和 extra 指针参数。函数成功时返回0，失败时返回-1</p>
<h1 id="接受TCP连接"><a href="#接受TCP连接" class="headerlink" title="接受TCP连接"></a>接受TCP连接</h1><p>evconnlistener机制提供了监听和接受TCP连接的方法.</p>
<h2 id="创建和释放evconnlistener"><a href="#创建和释放evconnlistener" class="headerlink" title="创建和释放evconnlistener"></a>创建和释放evconnlistener</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct evconnlistener *<span class="title">evconnlistener_new</span><span class="params">(struct event_base *base, evconnlistener_cb cb, <span class="keyword">void</span> *ptr, <span class="keyword">unsigned</span> flags, <span class="keyword">int</span> backlog, <span class="keyword">evutil_socket_t</span> fd)</span></span>;</span><br><span class="line"><span class="function">struct evconnlistener *<span class="title">evconnlistener_new_bind</span><span class="params">(struct event_base *base, evconnlistener_cb cb, <span class="keyword">void</span> *ptr, <span class="keyword">unsigned</span> flags, <span class="keyword">int</span> backlog, <span class="keyword">const</span> struct sockaddr *sa, <span class="keyword">int</span> socklen)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">evconnlistener_free</span><span class="params">(struct evconnlistener *lev)</span></span>;</span><br></pre></td></tr></table></figure>
<p>两个 evconnlistener_new*()函数都分配和返回一个新的连接监听器对象。连接监听器使用 event_base 来得知什么时候在给定的监听套接字上有新的 TCP 连接。新连接到达时，监听器调用你给出的回调函数。两个函数中，base 参数都是监听器用于监听连接的 event_base。cb 是收到新连接时要调用的回调函数；如果 cb 为 NULL，则监听器是禁用的，直到设置了回调函数为止。ptr 指针将传递给回调函数。flags 参数控制回调函数的行为，下面会更详细论述。backlog 是任何时刻网络栈允许处于还未接受状态的最大未决连接数。更多细节请查看系统的 listen()函数文档。如果 backlog 是负的，libevent 会试图挑选一个较好的值；如果为0，libevent 认为已经对提供的套接字调用了 listen()。<br>两个函数的不同在于如何建立监听套接字。evconnlistener_new()函数假定已经将套接字绑定到要监听的端口，然后通过 fd 传入这个套接字。如果要 libevent 分配和绑定套接字，可以调用 evconnlistener_new_bind()，传输要绑定到的地址和地址长度。<br>要释放连接监听器，调用 evconnlistener_free()</p>
<p>可标识的标志<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//默认情况下，连接监听器接收新套接字后，会将其设置为非阻塞的，以便将其用于 libevent。如果不想要这种行为，可以设置这个标志。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LEV_OPT_LEAVE_SOCKETS_BLOCKING	(1u&lt;&lt;0)</span></span><br><span class="line"><span class="comment">//如果设置了这个选项，释放连接监听器会关闭底层套接字。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LEV_OPT_CLOSE_ON_FREE		(1u&lt;&lt;1)</span></span><br><span class="line"><span class="comment">//如果设置了这个选项，连接监听器会为底层套接字设置 close-on-exec 标志。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LEV_OPT_CLOSE_ON_EXEC		(1u&lt;&lt;2)</span></span><br><span class="line"><span class="comment">//某些平台在默认情况下，关闭某监听套接字后，要过一会儿其他套接字才可以绑定到同一个端口。设置这个标志会让 libevent 标记套接字是可重用的，这样一旦关闭，可以立即打开其他套接字，在相同端口进行监听。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LEV_OPT_REUSEABLE		(1u&lt;&lt;3)</span></span><br><span class="line"><span class="comment">//为监听器分配锁，这样就可以在多个线程中安全地使用了</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LEV_OPT_THREADSAFE		(1u&lt;&lt;4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LEV_OPT_DISABLED		(1u&lt;&lt;5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LEV_OPT_DEFERRED_ACCEPT		(1u&lt;&lt;6)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LEV_OPT_REUSEABLE_PORT		(1u&lt;&lt;7)</span></span><br></pre></td></tr></table></figure></p>
<p>连接监听器回调<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*evconnlistener_cb)</span><span class="params">(struct evconnlistener *, <span class="keyword">evutil_socket_t</span>, struct sockaddr *, <span class="keyword">int</span> socklen, <span class="keyword">void</span> *)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>stener参数是接收连接的连接监听器。sock参数是新接收的套接字。addr和len参数是接收连接的地址和地址长度。ptr是调用evconnlistener_new()时用户提供的指针。</p>
<h2 id="禁用和启用evconnlistener"><a href="#禁用和启用evconnlistener" class="headerlink" title="禁用和启用evconnlistener"></a>禁用和启用evconnlistener</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evconnlistener_disable</span><span class="params">(struct evconnlistener *lev)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evconnlistener_enable</span><span class="params">(struct evconnlistener *lev)</span></span>;</span><br></pre></td></tr></table></figure>
<p>暂时禁止或者重新允许监听新连接</p>
<h2 id="设置evconnlistener的回调函数"><a href="#设置evconnlistener的回调函数" class="headerlink" title="设置evconnlistener的回调函数"></a>设置evconnlistener的回调函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">evconnlistener_set_cb</span><span class="params">(struct evconnlistener *lev, evconnlistener_cb cb, <span class="keyword">void</span> *arg)</span></span>;</span><br></pre></td></tr></table></figure>
<p>函数调整 evconnlistener 的回调函数和其参数。</p>
<h2 id="检测evconnlistener"><a href="#检测evconnlistener" class="headerlink" title="检测evconnlistener"></a>检测evconnlistener</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">evutil_socket_t</span> <span class="title">evconnlistener_get_fd</span><span class="params">(struct evconnlistener *lev)</span></span>;</span><br><span class="line"><span class="function">struct event_base *<span class="title">evconnlistener_get_base</span><span class="params">(struct evconnlistener *lev)</span></span>;</span><br></pre></td></tr></table></figure>
<p>分别返回监听器关联的套接字和 event_base</p>
<h2 id="侦测错误"><a href="#侦测错误" class="headerlink" title="侦测错误"></a>侦测错误</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*evconnlistener_errorcb)</span><span class="params">(struct evconnlistener *, <span class="keyword">void</span> *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">evconnlistener_set_error_cb</span><span class="params">(struct evconnlistener *lev, evconnlistener_errorcb errorcb)</span></span>;</span><br></pre></td></tr></table></figure>
<p>如果使用 evconnlistener_set_error_cb()为监听器设置了错误回调函数，则监听器发生错误时回调函数就会被调用。第一个参数是监听器，第二个参数是调用 evconnlistener_new() 时传入的 ptr。</p>
<h1 id="bufferevent"><a href="#bufferevent" class="headerlink" title="bufferevent"></a>bufferevent</h1><h2 id="bufferevent-和-evbuffer"><a href="#bufferevent-和-evbuffer" class="headerlink" title="bufferevent 和 evbuffer"></a>bufferevent 和 evbuffer</h2><p>每个bufferevent都有一个输出缓冲区和一个输入缓冲区,类型都是”struct evbuffer”,有数据要写入到bufferevent时,添加数据到输出缓冲区;bufferevent中有数据供读取的时候,从输入缓冲区抽取数据.</p>
<h2 id="回调和水位"><a href="#回调和水位" class="headerlink" title="回调和水位"></a>回调和水位</h2><p>每个bufferevent有两个数据相关的回调:读取回调和写入回调.默认情况下,从底层传输端口读取任意量的数据后会调用读取回调;输出去有足够的数据被清空到底层传输端口后写入回调会被调用.</p>
<p>每个bufferevent有四个水位:</p>
<ol>
<li>读取低水位:读取操作使得输入缓冲区的数据量在此级别或者更高时，读取回调将被调用。默认值为0，所以每个读取操作都会导致读取回调被调用。</li>
<li>读取高水位:输入缓冲区中的数据量达到此级别后，bufferevent 将停止读取，直到输入缓冲区中足够量的数据被抽取，使得数据量低于此级别。默认值是无限，所以永远不会因为输入缓冲区的大小而停止读取。</li>
<li>写入低水位:写入操作使得输出缓冲区的数据量达到或者低于此级别时，写入回调将被调用。默认值是0，所以只有输出缓冲区空的时候才会调用写入回调。</li>
<li>写入高水位:bufferevent 没有直接使用这个水位。它在 bufferevent 用作另外一个bufferevent 的底层传输端口时有特殊意义。</li>
</ol>
<p>错误或事件回调(向应用通知非面向数据的事件)</p>
<ol>
<li>BEV_EVENT_READING:读取操作时发生某事件</li>
<li>BEV_EVENT_WRITING:写入操作时发生某事件</li>
<li>BEV_EVENT_EOF:遇到文件结束指示</li>
<li>BEV_EVENT_ERROR:操作时发生错误,调用EVUTIL_SOCKET_ERROR()获取更错错误信息</li>
<li>BEV_EVENT_TIMEOUT:发生超时</li>
<li>BEV_EVENT_CONNECTED:请求的连接过程已经完成</li>
</ol>
<h2 id="延迟回调"><a href="#延迟回调" class="headerlink" title="延迟回调"></a>延迟回调</h2><p>默认情况下,bufferevent的回调在相应的条件发生时立即被执行.在依赖关系复杂的情况下,立即调用会产生问题.要解决该问题,可以请求bufferevent延迟其回调.条件满足时,延迟回调不会立即被调用,而是在event_loop()调用中被排队.然后在通常的事件回调后执行.</p>
<h2 id="buffervent的选项标记bufferevent-options"><a href="#buffervent的选项标记bufferevent-options" class="headerlink" title="buffervent的选项标记bufferevent_options"></a>buffervent的选项标记bufferevent_options</h2><ol>
<li>BEV_OPT_CLOSE_ON_FREE:释放bufferevent时关闭底层传输端口.将关闭底层套接字,释放底层bufferevent等.</li>
<li>BEV_OPT_THREADSAFE:自动为bufferevent分配锁,可以安全的在多个线程中使用bufferevent</li>
<li>BEV_OPT_DEFER_CALLBACKS:设置该标记,bufferevent延迟所有回调</li>
<li>BEV_OPT_UNLOCK_CALLBACKS:默认情况下,如果设置bufferevent为线程安全的,则bufferevent会在调用用户提供的回调时进行锁定.设置该选项让Libevent在执行回调时不锁定.</li>
</ol>
<h2 id="基于套接字的bufferevent"><a href="#基于套接字的bufferevent" class="headerlink" title="基于套接字的bufferevent"></a>基于套接字的bufferevent</h2><h2 id="创建基于套接字的bufferevent"><a href="#创建基于套接字的bufferevent" class="headerlink" title="创建基于套接字的bufferevent"></a>创建基于套接字的bufferevent</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bufferevent</span> *</span></span><br><span class="line"><span class="class"><span class="title">bufferevent_socket_new</span>(<span class="title">struct</span> <span class="title">event_base</span> *<span class="title">base</span>, <span class="title">evutil_socket_t</span> <span class="title">fd</span>,</span></span><br><span class="line"><span class="class">    <span class="title">int</span> <span class="title">options</span>);</span></span><br></pre></td></tr></table></figure>
<p>base时event_base反应堆 fd是套接字的文件描述符 options是bufferevent选项</p>
<h2 id="在基于套接字的bufferevent上启动连接"><a href="#在基于套接字的bufferevent上启动连接" class="headerlink" title="在基于套接字的bufferevent上启动连接"></a>在基于套接字的bufferevent上启动连接</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bufferevent_socket_connect</span><span class="params">(struct bufferevent *bev, <span class="keyword">const</span> struct sockaddr *sa, <span class="keyword">int</span> socklen)</span></span>;</span><br></pre></td></tr></table></figure>
<p>如果还没有为 bufferevent 设置套接字，调用函数将为其分配一个新的流套接字，并且设置为非阻塞的。如果已经为 bufferevent 设置套接字，调用 bufferevent_socket_connect()将告知 libevent 套接字还未连接，直到连接成功之前不应该对其进行读取或者写入操作。连接完成之前可以向输出缓冲区添加数据。如果连接成功启动，函数返回0；如果发生错误则返回-1。<br>注意:如果使用bufferevent_socket_connect() 发起连接,将只会收到 BEV_EVENT_CONNECTED 事件。如果自己调用 connect()，则连接上将被报告为写入事件</p>
<h2 id="通过主机名启动连接"><a href="#通过主机名启动连接" class="headerlink" title="通过主机名启动连接"></a>通过主机名启动连接</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bufferevent_socket_connect_hostname</span><span class="params">(struct bufferevent *bev, struct evdns_base *evdns_base, <span class="keyword">int</span> family, <span class="keyword">const</span> <span class="keyword">char</span> *hostname, <span class="keyword">int</span> port)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bufferevent_socket_get_dns_error</span><span class="params">(struct bufferevent *bev)</span></span>;</span><br></pre></td></tr></table></figure>
<p>bufferevent_socket_connect_hostnam解析hostname,通过其family类型地址(允许的地址族类型有AF_INET,IF_INET6和AF_UNSPEC).如果名字解析失败,函数将调用事件回调,报告错误事件.如果解析成功,函数将启动连接请求.<br>dns_base参数可选:如果为NULL,等待名字查找完成期间调用线程将被阻塞.如果提供dns_base参数,libevent将使用它异步查询主机名.<br>函数返回的错误可能是DNS主机名查询错误，可以调用bufferevent_socket_get_dns_error() 来获取最近的错误。返回值0表示没有检测到 DNS 错误。</p>
<h2 id="操作回调、水位和启用-禁用"><a href="#操作回调、水位和启用-禁用" class="headerlink" title="操作回调、水位和启用/禁用"></a>操作回调、水位和启用/禁用</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*bufferevent_data_cb)</span><span class="params">(struct bufferevent *bev, <span class="keyword">void</span> *ctx)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*bufferevent_event_cb)</span><span class="params">(struct bufferevent *bev, short what, <span class="keyword">void</span> *ctx)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bufferevent_setcb</span><span class="params">(struct bufferevent *bufev,</span></span></span><br><span class="line"><span class="function"><span class="params">    bufferevent_data_cb readcb, bufferevent_data_cb writecb,</span></span></span><br><span class="line"><span class="function"><span class="params">    bufferevent_event_cb eventcb, <span class="keyword">void</span> *cbarg)</span></span>;</span><br></pre></td></tr></table></figure>
<p>bufferevent_setcb()函数修改bufferevent的一个或多个回调.readcb、writecb、eventcb函数分别在读取到足够的数据、写入足够的数据、发生错误时被调用.每个回调的第一个参数都是发生了事件的bufferevent,最后一个参数都是调用bufferevent_setcb()时用户提供的cbarg参数(通过cbarg参数向回调函数传递参数).事件回调的events参数是一个表示事件标志的位掩码.<br>要禁用回调,传递NULL而不是回调函数.注意:<strong>bufferevent的所有回调函数共享单个cbarg,修改它需要特别小心</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bufferevent_enable</span><span class="params">(struct bufferevent *bufev, short event)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bufferevent_disable</span><span class="params">(struct bufferevent *bufev, short event)</span></span>;</span><br><span class="line"><span class="function">short <span class="title">bufferevent_get_enabled</span><span class="params">(struct bufferevent *bufev)</span></span>;</span><br></pre></td></tr></table></figure>
<p>bufferevent_enable()函数开启bufferevent的EV_READ、EV_WRITE事件<br>bufferevent_disable()函数禁用bufferevent的EV_READ、EV_WRITE事件<br>没有启用读取或写入事件时,bufferevent将不会试图进行数据的读取和写入</p>
<p>没有必要在输出缓冲区空时禁用写入事件：bufferevent 将自动停止写入，然后在有数据等待写入时重新开始<br>没有必要在输入缓冲区高于高水位时禁用读取事件：bufferevent 将自动停止读取，然后在有空间用于读取时重新开始读取<br>默认情况下，新创建的 bufferevent 的写入是启用的，但是读取没有启用<br>bufferevent_get_enabled()可以确定bufferevent上当前开启的事件.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bufferevent_setwatermark</span><span class="params">(struct bufferevent *bufev, short events, <span class="keyword">size_t</span> lowmark, <span class="keyword">size_t</span> highmark)</span></span>;</span><br></pre></td></tr></table></figure>
<p>bufferevent_setwatermark()函数设置单个bufferevent的读取水位、写入水位.如果events设置为EV_READ调整读取水位,events设置为EV_WARITE调整写入水位.<br>对于高水位,0表示”无限”</p>
<h2 id="bufferevent中数据的操作"><a href="#bufferevent中数据的操作" class="headerlink" title="bufferevent中数据的操作"></a>bufferevent中数据的操作</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">struct evbuffer * bufferevent_get_input(struct bufferevent *bufev);</span><br><span class="line">struct evbuffer * bufferevent_get_output(struct bufferevent *bufev);</span><br></pre></td></tr></table></figure>
<p>bufferevent_get_input()返回输入缓冲区<br>bufferevent_get_output()返回输出缓冲区</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bufferevent_write</span><span class="params">(struct bufferevent *bufev, <span class="keyword">const</span> <span class="keyword">void</span> *data, <span class="keyword">size_t</span> <span class="built_in">size</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bufferevent_write_buffer</span><span class="params">(struct bufferevent *bufev, struct evbuffer *buf)</span></span>;</span><br></pre></td></tr></table></figure>
<p>bufferevent_write()将内从从data处开始的size字节数据添加到输出缓冲区末尾.<br>bufferevent_write_buffer()移除buf的所有内容,将其放置到输出缓冲区末尾.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">bufferevent_read</span><span class="params">(struct bufferevent *bufev, <span class="keyword">void</span> *data, <span class="keyword">size_t</span> <span class="built_in">size</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bufferevent_read_buffer</span><span class="params">(struct bufferevent *bufev, struct evbuffer *buf)</span></span>;</span><br></pre></td></tr></table></figure>
<p>bufferevent_read()至多从输入缓冲区移除size字节的数据,将其存储到内存中data处,返回实际移除的字节数<br>bufferevent_read_buffer()抽空输入缓冲区的所有内容,将其放置到buf中,成功返回0,失败返回-1</p>
<h2 id="读写超时"><a href="#读写超时" class="headerlink" title="读写超时"></a>读写超时</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bufferevent_set_timeouts</span><span class="params">(struct bufferevent *bufev,</span></span></span><br><span class="line"><span class="function"><span class="params">			 <span class="keyword">const</span> struct timeval *tv_read,</span></span></span><br><span class="line"><span class="function"><span class="params">			 <span class="keyword">const</span> struct timeval *tv_write)</span></span>;</span><br></pre></td></tr></table></figure>
<p>bufferevent_set_timeouts()设置超时时间为NULL会移除超时回调<br>试图读取数据的时候，如果至少等待了 timeout_read 秒，则读取超时事件将被触发。试图写入数据的时候，如果至少等待了 timeout_write 秒，则写入超时事件将被触发。<br>注意，只有在读取或者写入的时候才会计算超时。即如果 bufferevent 的读取被禁止，或者输入缓冲区满（达到其高水位），则读取超时被禁止。如果写入被禁止，或者没有数据待写入，则写入超时被禁止。读取或者写入超时发生时，相应的读取或者写入操作被禁止，然后超时事件回调被调用，带有标志BEV_EVENT_TIMEOUT | BEV_EVENT_READING或者BEV_EVENT_TIMEOUT | BEV_EVENT_WRITING。</p>
<h2 id="清空bufferevent"><a href="#清空bufferevent" class="headerlink" title="清空bufferevent"></a>清空bufferevent</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bufferevent_flush</span><span class="params">(struct bufferevent *bufev,</span></span></span><br><span class="line"><span class="function"><span class="params">    short iotype,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">enum</span> bufferevent_flush_mode mode)</span></span>;</span><br></pre></td></tr></table></figure>
<p>清空 bufferevent 要求 bufferevent 强制从底层传输端口读取或者写入尽可能多的数据，而忽略其他可能保持数据不被写入的限制条件。函数的细节功能依赖于 bufferevent 的具体类型。iotype 参数应该是 EV_READ、EV_WRITE 或者 EV_READ | EV_WRITE，用于指示应该处理读取、写入，还是二者都处理。state 参数可以是 BEV_NORMAL、BEV_FLUSH 或者BEV_FINISHED。BEV_FINISHED 指示应该告知另一端，没有更多数据需要发送了； 而 BEV_NORMAL 和 BEV_FLUSH 的区别依赖于具体的 bufferevent 类型。<br>失败时 bufferevent_flush()返回-1，如果没有数据被清空则返回0，有数据被清空则返回1</p>
<h2 id="类型特定的bufferevent函数"><a href="#类型特定的bufferevent函数" class="headerlink" title="类型特定的bufferevent函数"></a>类型特定的bufferevent函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bufferevent_priority_set</span><span class="params">(struct bufferevent *bufev, <span class="keyword">int</span> priority)</span></span>;</span><br></pre></td></tr></table></figure>
<p>调整bufev的优先级为priority.成功返回0,失败返回-1,该函数仅作用域基于套接字的bufferevent</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bufferevent_setfd</span><span class="params">(struct bufferevent *bev, <span class="keyword">evutil_socket_t</span> fd)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">evutil_socket_t</span> <span class="title">bufferevent_getfd</span><span class="params">(struct bufferevent *bev)</span></span>;</span><br></pre></td></tr></table></figure>
<p>设置或返回基于fd的事件的文件描述符.只有基于套接字的bufferevent支持bufferevent_setfd.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct event_base * <span class="title">bufferevent_get_base</span><span class="params">(struct bufferevent *bufev)</span></span>;</span><br></pre></td></tr></table></figure>
<p>返回bufferevent的event_base</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct bufferevent * <span class="title">bufferevent_get_underlying</span><span class="params">(struct bufferevent *bev)</span></span>;</span><br></pre></td></tr></table></figure>
<p>返回作为 bufferevent 底层传输端口的另一个 bufferevent。</p>
<h2 id="手动锁定和解锁"><a href="#手动锁定和解锁" class="headerlink" title="手动锁定和解锁"></a>手动锁定和解锁</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bufferevent_lock</span><span class="params">(struct bufferevent *bev)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bufferevent_unlock</span><span class="params">(struct bufferevent *bev)</span></span>;</span><br></pre></td></tr></table></figure>
<p>注意:如果创建 bufferevent 时没有指定 BEV_OPT_THREADSAFE 标志,或者没有激活 libevent 的线程支持，则锁定操作是没有效果的.用这个函数锁定 bufferevent 将自动同时锁定相关联的 evbuffer.这些函数是递归的:锁定已经持有锁的 bufferevent 是安全的.当然,对于每次锁定都必须进行一次解锁.</p>
<h1 id="http服务相关"><a href="#http服务相关" class="headerlink" title="http服务相关"></a>http服务相关</h1><h2 id="http-Server的创建与开始"><a href="#http-Server的创建与开始" class="headerlink" title="http Server的创建与开始"></a>http Server的创建与开始</h2><p>首先需要使用event_base_new或event_base_new_with_config创建一个event_base，然后使用evhttp_new创建evhttp。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct evhttp *<span class="title">evhttp_new</span><span class="params">(struct event_base *base)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>在需要释放evhttp时需要调用evhttp_free来释放。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">evhttp_free</span><span class="params">(struct evhttp* http)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>再为evhttp设置回调函数，evhttp_set_cb为特定URL指定回调函数，evhttp_set_gencb注册通用回调函数，在没有指定URL回调函数的情况下该回调函数被调用。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//uri 特定的uri</span></span><br><span class="line"><span class="comment">//cb 回调函数</span></span><br><span class="line"><span class="comment">//cbarg 传入回调函数的参数</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evhttp_set_cb</span><span class="params">(struct evhttp *http, <span class="keyword">const</span> <span class="keyword">char</span> *uri, \</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">void</span> (*cb)(struct evhttp_request *, <span class="keyword">void</span> *), <span class="keyword">void</span> *cbarg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//cb 回调函数</span></span><br><span class="line"><span class="comment">//cbarg 传入回调函数的参数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">evhttp_set_gencb</span><span class="params">(struct evhttp *http,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">void</span> (*cb)(struct evhttp_request *, <span class="keyword">void</span> *), <span class="keyword">void</span> *cbarg)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>再为evhttp绑定需要监听的ip和port。使用evhttp_bind_socket_with_handle函数。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct evhttp_bound_socket *<span class="title">evhttp_bind_socket_with_handle</span><span class="params">(struct evhttp *http, <span class="keyword">const</span> <span class="keyword">char</span> *address, <span class="keyword">ev_uint16_t</span> port)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>可以使用libevent提供的相关函数打印监听端口信息。<br>最后使用event_base_dispatch进入事件循环。</p>
<h2 id="http请求的处理"><a href="#http请求的处理" class="headerlink" title="http请求的处理"></a>http请求的处理</h2><p>evhttp_request_get_uri得到当前请求的uri地址。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">evhttp_request_get_uri</span><span class="params">(<span class="keyword">const</span> struct evhttp_request *req)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>evhttp_request_get_command得到当前请求的类型。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> evhttp_cmd_type &#123;</span><br><span class="line">	EVHTTP_REQ_GET     = <span class="number">1</span> &lt;&lt; <span class="number">0</span>,</span><br><span class="line">	EVHTTP_REQ_POST    = <span class="number">1</span> &lt;&lt; <span class="number">1</span>,</span><br><span class="line">	EVHTTP_REQ_HEAD    = <span class="number">1</span> &lt;&lt; <span class="number">2</span>,</span><br><span class="line">	EVHTTP_REQ_PUT     = <span class="number">1</span> &lt;&lt; <span class="number">3</span>,</span><br><span class="line">	EVHTTP_REQ_DELETE  = <span class="number">1</span> &lt;&lt; <span class="number">4</span>,</span><br><span class="line">	EVHTTP_REQ_OPTIONS = <span class="number">1</span> &lt;&lt; <span class="number">5</span>,</span><br><span class="line">	EVHTTP_REQ_TRACE   = <span class="number">1</span> &lt;&lt; <span class="number">6</span>,</span><br><span class="line">	EVHTTP_REQ_CONNECT = <span class="number">1</span> &lt;&lt; <span class="number">7</span>,</span><br><span class="line">	EVHTTP_REQ_PATCH   = <span class="number">1</span> &lt;&lt; <span class="number">8</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">enum</span> evhttp_cmd_type <span class="title">evhttp_request_get_command</span><span class="params">(<span class="keyword">const</span> struct evhttp_request *req)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>evhttp_uri_parse URI解析，得到evhttp_uri。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct evhttp_uri *<span class="title">evhttp_uri_parse</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *source_uri)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>evhttp_parse_query对uri参数进行解析，结果保存在struct evkeyvalq结构体中。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">evhttp_parse_query</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *uri, struct evkeyvalq *args)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>evhttp<em>decode_uri URL解码，得到UTF编码的字符，得到数据所占内存需要自己释放。<br>evhttp_encode_uri URL编码，对所有非alphanumeric及-\</em>的字符都被类似于%和一个2位16进制字符替换(其中空格被+号替换)。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">evhttp_encode_uri</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">evhttp_decode_uri</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *uri)</span></span>;</span><br></pre></td></tr></table></figure></p>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><ol>
<li><a href="http://blog.csdn.net/column/details/libevent-src.html" target="_blank" rel="noopener">libevent专栏</a></li>
<li><a href="http://blog.csdn.net/zhouyongku/article/details/53431597" target="_blank" rel="noopener">Libevent中文帮助手册</a></li>
<li><a href="https://segmentfault.com/a/1190000005594871" target="_blank" rel="noopener">Libevent 官方文档学习笔记</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.casezheng.date/2017/10/02/libevent-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CaseZheng">
      <meta itemprop="description" content="CaseZheng的博客网站">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CaseZheng">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/10/02/libevent-1/" class="post-title-link" itemprop="url">Libevent源码阅读——概述、实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-10-02 11:32:00" itemprop="dateCreated datePublished" datetime="2017-10-02T11:32:00+08:00">2017-10-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-12 12:56:36" itemprop="dateModified" datetime="2020-04-12T12:56:36+08:00">2020-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/网络库/" itemprop="url" rel="index"><span itemprop="name">网络库</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>重新读下Libevent的源码，使用最新的Libevent版本libevent-release-2.1.8-stable</p>
<h1 id="Reactor模式简介"><a href="#Reactor模式简介" class="headerlink" title="Reactor模式简介"></a>Reactor模式简介</h1><p><img src="/Picture/Reactor.png" alt="Reactor模型"><br>Reactor模式要求主线程(I/O处理单元)只监听文件描述符上是否有事件发生,有的话立即将事件通知工作线程(逻辑单元),除此之外,主线程不进行任何其它实质性的工作,读写数据、接收新的连接、处理客户请求均在工作线程中进行.<br>使用同步I/O模型(以epoll_wait为例)实现的Reactor模式的工作流程:</p>
<ol>
<li>主线程往epoll内核事件表中注册socket上的读就绪事件</li>
<li>主线程调用epoll_wait等待socket上的读就绪事件</li>
<li>当socket上有数据可读时,epoll_wait通知主线程.主线程将socket可读事件放入请求队列</li>
<li>睡眠在请求队列上的的某个工作线程被唤醒,从socket读取数据,并处理客户端请求,然后往epoll内核事件表注册该socket上的写就绪事件</li>
<li>主线程调用epoll_wait等待socket可写</li>
<li>当socket可写时,epoll_wait通知主线程.主线程将socket可写事件放入请求队列</li>
<li>睡眠在请求队列上的某个工作线程被唤醒,往socket上写入服务器处理客户端的结果</li>
</ol>
<p><a href="http://www.casezheng.date/2017/05/31/001_asio_note/"><strong>更多Reactor介绍请点击</strong></a></p>
<h1 id="Libevent简介"><a href="#Libevent简介" class="headerlink" title="Libevent简介"></a>Libevent简介</h1><p>Libevent是一个使用C语言编写的、轻量级的开源高性能事件通知库，适用于windows、linux、bsd等多种平台，内部使用select、epoll、kqueue、IOCP等系统调用管理事件机制。  </p>
<h1 id="Libevent特点"><a href="#Libevent特点" class="headerlink" title="Libevent特点"></a>Libevent特点</h1><ol>
<li>事件驱动、高性能</li>
<li>轻量级、专注于网络</li>
<li>开源，代码精炼、易读</li>
<li>跨平台，支持Windows、Linux、BSD和Mac OS</li>
<li>支持多路I/O复用技术（epoll、poll、dev/poll、select和kqueue等），在不同操作系统下，做了多路复用模型的抽象，可以使用不同的模型，通过事件函数提供服务</li>
<li>支持I/O、定时器和信号等事件</li>
<li>采用Reactor模式</li>
<li>支持多线程</li>
</ol>
<h1 id="Libevent源码获取"><a href="#Libevent源码获取" class="headerlink" title="Libevent源码获取"></a>Libevent源码获取</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/libevent/libevent.git</span><br></pre></td></tr></table></figure>
<p>编译、安装详情请参考官方文档,大致过程如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./autogen.sh</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make verify   # (optional)</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure></p>
<p>执行autogen.sh报错possibly undefined macro: AC_PROG_LIBTOOL安装libtool即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install libtool</span><br></pre></td></tr></table></figure></p>
<h1 id="Libevent功能"><a href="#Libevent功能" class="headerlink" title="Libevent功能"></a>Libevent功能</h1><ol>
<li>事件通知：当文件描述符可读可写时将执行回调函数</li>
<li>IO缓存：缓存事件提供了输入输出缓存，能自动的读入和写入，用户不必直接操作IO</li>
<li>定时器：libevent提供定时器机制，能在一定事件间隔后调用回调函数</li>
<li>信号：触发信号，执行回调</li>
<li>异步DNS解析：libevent提供异步解析DNS服务器的DNS解析函数集</li>
<li>事件驱动的http服务器：libevent提供简单的、可集成到引用程序中的HTTP服务器</li>
<li>RPC客户端服务器框架：libevent为创建RPC服务器和客户端创建了一个RPC框架，能自动封装和解封数据结构</li>
</ol>
<h1 id="Libevent组件"><a href="#Libevent组件" class="headerlink" title="Libevent组件"></a>Libevent组件</h1><ol>
<li>evutil：用来抽象不同平台网络实现差异的通用功能。  </li>
<li>event和event_base：libevent的核心，为各种平台特定的、基于事件的非阻塞IO后端提供抽象API，让程序可以知道套接字何时准备好，可以读或者写，并且处理基本的超时事件，检测OS信号。  </li>
<li>bufferevent：为libevent基于事件的核心提供使用更方便的封装。除了通知程序套接字已经准备好读写之外，还让程序可以请求缓冲的读写操作，可以知道何时IO已经真正发生。（bufferevent接口有多个后端，可以采用系统能够提供的更快的非阻塞IO方式，如Windows中的IOCP。）  </li>
<li>evbuffer：在bufferevent层之下实现缓冲功能，并且提供方便有效的访问函数。  </li>
<li>evhttp：一个简单的HTTP客户端/服务器实现。  </li>
<li>evdns：一个简单DNS客户端/服务器实现。  </li>
<li>evrpc：一个简单RPC实现。  </li>
</ol>
<h1 id="Libevent库"><a href="#Libevent库" class="headerlink" title="Libevent库"></a>Libevent库</h1><p>安装libevent时，默认安装下列库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@localhost Blog]$ ll /usr/local/lib/libevent*</span><br><span class="line">-rw-r--r--. 1 root root 470890 9月  30 23:02 /usr/local/lib/libevent.a</span><br><span class="line">-rw-r--r--. 1 root root 299550 9月  30 23:02 /usr/local/lib/libevent_core.a</span><br><span class="line">lrwxrwxrwx. 1 root root     22 9月  30 23:04 /usr/local/lib/libevent_core.so -&gt; libevent_core.so.2.2.0</span><br><span class="line">-rwxr-xr-x. 1 root root 217848 9月  30 23:02 /usr/local/lib/libevent_core.so.2.2.0</span><br><span class="line">-rw-r--r--. 1 root root 171474 9月  30 23:02 /usr/local/lib/libevent_extra.a</span><br><span class="line">lrwxrwxrwx. 1 root root     23 9月  30 23:04 /usr/local/lib/libevent_extra.so -&gt; libevent_extra.so.2.2.0</span><br><span class="line">-rwxr-xr-x. 1 root root 149576 9月  30 23:02 /usr/local/lib/libevent_extra.so.2.2.0</span><br><span class="line">-rw-r--r--. 1 root root  26152 9月  30 23:02 /usr/local/lib/libevent_openssl.a</span><br><span class="line">lrwxrwxrwx. 1 root root     25 9月  30 23:04 /usr/local/lib/libevent_openssl.so -&gt; libevent_openssl.so.2.2.0</span><br><span class="line">-rwxr-xr-x. 1 root root  35240 9月  30 23:02 /usr/local/lib/libevent_openssl.so.2.2.0</span><br><span class="line">-rw-r--r--. 1 root root   4968 9月  30 23:02 /usr/local/lib/libevent_pthreads.a</span><br><span class="line">lrwxrwxrwx. 1 root root     26 9月  30 23:04 /usr/local/lib/libevent_pthreads.so -&gt; libevent_pthreads.so.2.2.0</span><br><span class="line">-rwxr-xr-x. 1 root root  13600 9月  30 23:02 /usr/local/lib/libevent_pthreads.so.2.2.0</span><br><span class="line">lrwxrwxrwx. 1 root root     17 9月  30 23:04 /usr/local/lib/libevent.so -&gt; libevent.so.2.2.0</span><br><span class="line">-rwxr-xr-x. 1 root root 346224 9月  30 23:02 /usr/local/lib/libevent.so.2.2.0</span><br></pre></td></tr></table></figure></p>
<ol>
<li>libevent_core：所有核心的事件和缓存功能，包括所有的event_base、evbuffer、bufferevent和工具函数。  </li>
<li>libevent_extra：定义程序可能需要，也可能不需要的协议特定功能，包括HTTP、DNS和RPC。  </li>
<li>libevent：历史原因而存在，包括libevent_core和libevent_extra。</li>
<li>libevent_pthreads：添加基于pthread可移植线程库的线程和锁定实现，独立于libevent_core。  </li>
<li>libevent_openssl：为使用bufferevent和OpenSSL进行加密的通信提供支持, 独立于libevent_core。</li>
</ol>
<h1 id="Libevent头文件"><a href="#Libevent头文件" class="headerlink" title="Libevent头文件"></a>Libevent头文件</h1><p>libevent公用头文件安装在event2目录中  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[CaseZheng@localhost /]$ ll /usr/local/include/event2/</span><br><span class="line">总用量 408</span><br><span class="line">-rw-r--r--. 1 root root  4700 9月  30 22:58 buffer_compat.h</span><br><span class="line">-rw-r--r--. 1 root root  4538 9月  30 22:58 bufferevent_compat.h</span><br><span class="line">-rw-r--r--. 1 root root 34518 9月  30 22:58 bufferevent.h</span><br><span class="line">-rw-r--r--. 1 root root  4848 9月  30 22:58 bufferevent_ssl.h</span><br><span class="line">-rw-r--r--. 1 root root  4135 9月  30 22:58 bufferevent_struct.h</span><br><span class="line">-rw-r--r--. 1 root root 39078 9月  30 22:58 buffer.h</span><br><span class="line">-rw-r--r--. 1 root root 12588 9月  30 22:58 dns_compat.h</span><br><span class="line">-rw-r--r--. 1 root root 26873 9月  30 22:58 dns.h</span><br><span class="line">-rw-r--r--. 1 root root  2596 9月  30 22:58 dns_struct.h</span><br><span class="line">-rw-r--r--. 1 root root  7639 9月  30 22:58 event_compat.h</span><br><span class="line">-rw-r--r--. 1 root root 15740 9月  30 23:02 event-config.h</span><br><span class="line">-rw-r--r--. 1 root root 62445 9月  30 22:58 event.h</span><br><span class="line">-rw-r--r--. 1 root root  5024 9月  30 22:58 event_struct.h</span><br><span class="line">-rw-r--r--. 1 root root  3265 9月  30 22:58 http_compat.h</span><br><span class="line">-rw-r--r--. 1 root root 42821 9月  30 22:58 http.h</span><br><span class="line">-rw-r--r--. 1 root root  4809 9月  30 22:58 http_struct.h</span><br><span class="line">-rw-r--r--. 1 root root  2603 9月  30 22:58 keyvalq_struct.h</span><br><span class="line">-rw-r--r--. 1 root root  7445 9月  30 22:58 listener.h</span><br><span class="line">-rw-r--r--. 1 root root  2351 9月  30 22:58 rpc_compat.h</span><br><span class="line">-rw-r--r--. 1 root root 21702 9月  30 22:58 rpc.h</span><br><span class="line">-rw-r--r--. 1 root root  3235 9月  30 22:58 rpc_struct.h</span><br><span class="line">-rw-r--r--. 1 root root  2141 9月  30 22:58 tag_compat.h</span><br><span class="line">-rw-r--r--. 1 root root  4914 9月  30 22:58 tag.h</span><br><span class="line">-rw-r--r--. 1 root root  9952 9月  30 22:58 thread.h</span><br><span class="line">-rw-r--r--. 1 root root 28536 9月  30 22:58 util.h</span><br><span class="line">-rw-r--r--. 1 root root  2818 9月  30 22:58 visibility.h</span><br></pre></td></tr></table></figure>
<ol>
<li>API头文件：定义libevent公用接口。  </li>
<li>兼容头文件：已废弃的函数提供兼容的头部包含定义。不应该使用这类头文件。  </li>
<li>结构头文件：以”_struct”为后缀，定义各种结构体，为了快速访问而暴露，或因为历史原因而暴露。不要直接依赖这类头文件中的任何结构体，会破坏对其他版本libevent的二进制兼容性。  </li>
</ol>
<h1 id="简单的定时器和信号事件示例"><a href="#简单的定时器和信号事件示例" class="headerlink" title="简单的定时器和信号事件示例"></a>简单的定时器和信号事件示例</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/event.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/util.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">lasttime</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">timeout_cb</span><span class="params">(<span class="keyword">evutil_socket_t</span> fd, short events, <span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">newtime</span>, <span class="title">difference</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event</span> *<span class="title">timeout</span> = (<span class="title">struct</span> <span class="title">event</span>*)<span class="title">arg</span>;</span></span><br><span class="line">    <span class="keyword">double</span> elapsed;</span><br><span class="line">    evutil_gettimeofday(&amp;newtime, <span class="literal">NULL</span>);</span><br><span class="line">    evutil_timersub(&amp;newtime, &amp;lasttime, &amp;difference);</span><br><span class="line">    elapsed = difference.tv_sec + (difference.tv_usec / <span class="number">1.0e6</span>);</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"timeout_cb called at "</span>&lt;&lt;newtime.tv_sec&lt;&lt;<span class="string">": "</span>&lt;&lt;elapsed&lt;&lt;<span class="string">"second elapsed"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    lasttime = newtime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">signal_cb</span><span class="params">(<span class="keyword">evutil_socket_t</span> fd, short events, <span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> *<span class="title">base</span> = (<span class="title">struct</span> <span class="title">event_base</span> *)<span class="title">arg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">delay</span> = &#123;</span><span class="number">1</span>, <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"1 s after exit"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    event_base_loopexit(base, &amp;delay);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> *<span class="title">base</span> = <span class="title">event_base_new</span>();</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == base)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"event_base_new error"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;strerror(errno)&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event</span> *<span class="title">signalevent</span> = <span class="title">evsignal_new</span>(<span class="title">base</span>, <span class="title">SIGINT</span>, <span class="title">signal_cb</span>, (<span class="title">void</span>*)<span class="title">base</span>);</span></span><br><span class="line">    event_add(signalevent, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event</span> *<span class="title">timeout_event</span> = <span class="title">evtimer_new</span>(<span class="title">base</span>, <span class="title">timeout_cb</span>, <span class="title">NULL</span>);</span></span><br><span class="line">    <span class="comment">//flags设置为EV_PERSIST表示该事件一直有效</span></span><br><span class="line">    <span class="keyword">int</span> flags = EV_PERSIST;</span><br><span class="line">    <span class="comment">//flags设置为0，该事件触发一次就会被删除，需要再次添加</span></span><br><span class="line">    <span class="comment">//int flags = 0;</span></span><br><span class="line">    event_assign(timeout_event, base, <span class="number">-1</span>, flags, timeout_cb, (<span class="keyword">void</span>*) timeout_event);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">    evutil_timerclear(&amp;tv);</span><br><span class="line">    tv.tv_sec = <span class="number">2</span>;</span><br><span class="line">    event_add(timeout_event, &amp;tv);</span><br><span class="line"></span><br><span class="line">    evutil_gettimeofday(&amp;lasttime, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    event_base_dispatch(base);</span><br><span class="line">    event_free(signalevent);</span><br><span class="line">    event_free(timeout_event);</span><br><span class="line">    event_base_free(base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="简单的回显服务器"><a href="#简单的回显服务器" class="headerlink" title="简单的回显服务器"></a>简单的回显服务器</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/event.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/listener.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/util.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">accept_cb</span><span class="params">(<span class="keyword">int</span> fd, short events, <span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">socket_read_cb</span><span class="params">(<span class="keyword">int</span> fd, short events, <span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tcp_server_init</span><span class="params">(<span class="keyword">int</span> port, <span class="keyword">int</span> listen_num)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> listener = tcp_server_init(<span class="number">9999</span>, <span class="number">5</span>);</span><br><span class="line">    <span class="keyword">if</span>(listener == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"tcp_server_init error"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> * <span class="title">base</span> = <span class="title">event_base_new</span>();</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == base)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"event_base_new error"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event</span> * <span class="title">ev_listen</span> = <span class="title">event_new</span>(<span class="title">base</span>, <span class="title">listener</span>, <span class="title">EV_READ</span>|<span class="title">EV_PERSIST</span>, <span class="title">accept_cb</span>, <span class="title">base</span>);</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == ev_listen)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"event_new error"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    event_add(ev_listen, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    event_base_dispatch(base);</span><br><span class="line"></span><br><span class="line">    event_free(ev_listen);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">accept_cb</span><span class="params">(<span class="keyword">int</span> fd, short evnets, <span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client</span>;</span></span><br><span class="line">    <span class="keyword">socklen_t</span> len = <span class="keyword">sizeof</span>(client);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">evutil_socket_t</span> sockfd = ::accept(fd, (struct sockaddr*)&amp;client, &amp;len);</span><br><span class="line">    <span class="keyword">if</span>(sockfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"accept error"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    evutil_make_socket_nonblocking(sockfd);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"accpet a conn fd: "</span>&lt;&lt;sockfd&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> *<span class="title">base</span> = (<span class="title">struct</span> <span class="title">event_base</span>*)<span class="title">arg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event</span> *<span class="title">ev</span> = <span class="title">event_new</span>(<span class="title">NULL</span>, -1, 0, <span class="title">NULL</span>, <span class="title">NULL</span>);</span></span><br><span class="line">    event_assign(ev, base, sockfd, EV_READ|EV_PERSIST, socket_read_cb, (<span class="keyword">void</span>*)ev);</span><br><span class="line">    event_add(ev, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">socket_read_cb</span><span class="params">(<span class="keyword">int</span> fd, short events, <span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buff[<span class="number">4096</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event</span> *<span class="title">ev</span> = (<span class="title">struct</span> <span class="title">event</span>*)<span class="title">arg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> len = read(fd, buff, <span class="keyword">sizeof</span>(buff)<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span>(len &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"read error len: "</span>&lt;&lt;len&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        event_free(ev);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    buff[len] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"read msg : "</span>&lt;&lt;buff&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    write(fd, buff, <span class="built_in">strlen</span>(buff));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tcp_server_init</span><span class="params">(<span class="keyword">int</span> port, <span class="keyword">int</span> listen_num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">evutil_socket_t</span> listener;</span><br><span class="line">    listener = ::socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(listener &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"create socket error"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    evutil_make_listen_socket_reuseable(listener);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sin</span>;</span></span><br><span class="line">    <span class="built_in">sin</span>.sin_family = AF_INET;</span><br><span class="line">    <span class="built_in">sin</span>.sin_addr.s_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">sin</span>.sin_port = htons(port);</span><br><span class="line">    <span class="keyword">if</span>(::bind(listener, (struct sockaddr*)&amp;<span class="built_in">sin</span>, <span class="keyword">sizeof</span>(<span class="built_in">sin</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"bind error"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(::listen(listener, listen_num) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"listen error"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    evutil_make_socket_nonblocking(listener);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> listener;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="使用bufferevent的回显服务器"><a href="#使用bufferevent的回显服务器" class="headerlink" title="使用bufferevent的回显服务器"></a>使用bufferevent的回显服务器</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/event.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/bufferevent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/listener.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/util.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">accept_cb</span><span class="params">(<span class="keyword">int</span> fd, short events, <span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">socket_read_cb</span><span class="params">(struct bufferevent *bev, <span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">event_cb</span><span class="params">(struct bufferevent *bev, short event, <span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tcp_server_init</span><span class="params">(<span class="keyword">int</span> port, <span class="keyword">int</span> listen_num)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> listener = tcp_server_init(<span class="number">9999</span>, <span class="number">5</span>);</span><br><span class="line">    <span class="keyword">if</span>(listener == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"tcp_server_init error"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> * <span class="title">base</span> = <span class="title">event_base_new</span>();</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == base)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"event_base_new error"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event</span> * <span class="title">ev_listen</span> = <span class="title">event_new</span>(<span class="title">base</span>, <span class="title">listener</span>, <span class="title">EV_READ</span>|<span class="title">EV_PERSIST</span>, <span class="title">accept_cb</span>, <span class="title">base</span>);</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == ev_listen)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"event_new error"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    event_add(ev_listen, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    event_base_dispatch(base);</span><br><span class="line"></span><br><span class="line">    event_free(ev_listen);</span><br><span class="line">    event_base_free(base);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">accept_cb</span><span class="params">(<span class="keyword">int</span> fd, short evnets, <span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client</span>;</span></span><br><span class="line">    <span class="keyword">socklen_t</span> len = <span class="keyword">sizeof</span>(client);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">evutil_socket_t</span> sockfd = ::accept(fd, (struct sockaddr*)&amp;client, &amp;len);</span><br><span class="line">    <span class="keyword">if</span>(sockfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"accept error"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    evutil_make_socket_nonblocking(sockfd);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"accpet a conn fd: "</span>&lt;&lt;sockfd&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> *<span class="title">base</span> = (<span class="title">struct</span> <span class="title">event_base</span>*)<span class="title">arg</span>;</span></span><br><span class="line"></span><br><span class="line">    bufferevent *bev = bufferevent_socket_new(base, sockfd, BEV_OPT_CLOSE_ON_FREE);</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == bev)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"bufferevent_socket_new error"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    bufferevent_setcb(bev, socket_read_cb, <span class="literal">NULL</span>, event_cb, arg);</span><br><span class="line">    bufferevent_enable(bev, EV_READ | EV_PERSIST);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">socket_read_cb</span><span class="params">(bufferevent *bev, <span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buff[<span class="number">4096</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">size_t</span> len = bufferevent_read(bev, buff, <span class="keyword">sizeof</span>(buff));</span><br><span class="line">    <span class="keyword">if</span>(len &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"read error len: "</span>&lt;&lt;len&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    buff[len] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"read msg : "</span>&lt;&lt;buff&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    bufferevent_write(bev, buff, <span class="built_in">strlen</span>(buff));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">event_cb</span><span class="params">(struct bufferevent *bev, short event, <span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(event &amp; BEV_EVENT_EOF)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"conn close"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(event &amp;BEV_EVENT_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"conn error"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"event :"</span>&lt;&lt;event&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bufferevent_free(bev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tcp_server_init</span><span class="params">(<span class="keyword">int</span> port, <span class="keyword">int</span> listen_num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">evutil_socket_t</span> listener;</span><br><span class="line">    listener = ::socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(listener &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"create socket error"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    evutil_make_listen_socket_reuseable(listener);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sin</span>;</span></span><br><span class="line">    <span class="built_in">sin</span>.sin_family = AF_INET;</span><br><span class="line">    <span class="built_in">sin</span>.sin_addr.s_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">sin</span>.sin_port = htons(port);</span><br><span class="line">    <span class="keyword">if</span>(::bind(listener, (struct sockaddr*)&amp;<span class="built_in">sin</span>, <span class="keyword">sizeof</span>(<span class="built_in">sin</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"bind error"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(::listen(listener, listen_num) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"listen error"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    evutil_make_socket_nonblocking(listener);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> listener;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="使用evconnlistener的服务器"><a href="#使用evconnlistener的服务器" class="headerlink" title="使用evconnlistener的服务器"></a>使用evconnlistener的服务器</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/event.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/bufferevent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/listener.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/util.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">accept_cb</span><span class="params">(evconnlistener *listener, <span class="keyword">evutil_socket_t</span> fd, \</span></span></span><br><span class="line"><span class="function"><span class="params">        struct sockaddr *sock, <span class="keyword">int</span> socklen, <span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">socket_read_cb</span><span class="params">(struct bufferevent *bev, <span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">event_cb</span><span class="params">(struct bufferevent *bev, short event, <span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sin</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;<span class="built_in">sin</span>, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="built_in">sin</span>));</span><br><span class="line">    <span class="built_in">sin</span>.sin_family = AF_INET;</span><br><span class="line">    <span class="built_in">sin</span>.sin_port = htons(<span class="number">9999</span>);</span><br><span class="line"></span><br><span class="line">    event_base *base = event_base_new();</span><br><span class="line"></span><br><span class="line">    evconnlistener * listener = evconnlistener_new_bind(base, accept_cb, \</span><br><span class="line">            base, LEV_OPT_REUSEABLE | LEV_OPT_CLOSE_ON_FREE, \</span><br><span class="line">            <span class="number">10</span>, (struct sockaddr*)&amp;<span class="built_in">sin</span>, \</span><br><span class="line">            <span class="keyword">sizeof</span>(struct sockaddr_in));</span><br><span class="line"></span><br><span class="line">    event_base_dispatch(base);</span><br><span class="line"></span><br><span class="line">    evconnlistener_free(listener);</span><br><span class="line">    event_base_free(base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">accept_cb</span><span class="params">(evconnlistener *listener, <span class="keyword">evutil_socket_t</span> fd, \</span></span></span><br><span class="line"><span class="function"><span class="params">        struct sockaddr *sock, <span class="keyword">int</span> socklen, <span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"accept a client fd: "</span>&lt;&lt;fd&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    event_base *base = (event_base*)arg;</span><br><span class="line"></span><br><span class="line">    bufferevent *bev = bufferevent_socket_new(base, fd, BEV_OPT_CLOSE_ON_FREE);</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == bev)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"bufferevent_socket_new error"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    bufferevent_setcb(bev, socket_read_cb, <span class="literal">NULL</span>, event_cb, arg);</span><br><span class="line">    bufferevent_enable(bev, EV_READ | EV_PERSIST);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">socket_read_cb</span><span class="params">(bufferevent *bev, <span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buff[<span class="number">4096</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">size_t</span> len = bufferevent_read(bev, buff, <span class="keyword">sizeof</span>(buff));</span><br><span class="line">    <span class="keyword">if</span>(len &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"read error len: "</span>&lt;&lt;len&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    buff[len] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"read msg : "</span>&lt;&lt;buff&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    bufferevent_write(bev, buff, <span class="built_in">strlen</span>(buff));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">event_cb</span><span class="params">(struct bufferevent *bev, short event, <span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(event &amp; BEV_EVENT_EOF)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"conn close"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(event &amp;BEV_EVENT_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"conn error"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"event :"</span>&lt;&lt;event&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bufferevent_free(bev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Libevent-DNS客户端的实现"><a href="#Libevent-DNS客户端的实现" class="headerlink" title="Libevent DNS客户端的实现"></a>Libevent DNS客户端的实现</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/event.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/dns.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">callback</span><span class="params">(<span class="keyword">int</span> errcode, struct evutil_addrinfo *addr, <span class="keyword">void</span> *ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (errcode)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"error :"</span>&lt;&lt;evutil_gai_strerror(errcode)&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        struct evutil_addrinfo *ai;</span><br><span class="line">        <span class="keyword">if</span> (addr-&gt;ai_canonname)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">cout</span>&lt;&lt;<span class="string">"cannoname :"</span>&lt;&lt;addr-&gt;ai_canonname&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//addr是一个链表,遍历链表</span></span><br><span class="line">        <span class="keyword">for</span>( ai = addr ; ai != <span class="literal">NULL</span> ; ai = ai-&gt;ai_next)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> buf[<span class="number">128</span>];</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *s = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">if</span> ( ai-&gt;ai_family == AF_INET)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> *<span class="title">sin</span> = (<span class="title">struct</span> <span class="title">sockaddr_in</span> *)<span class="title">ai</span>-&gt;<span class="title">ai_addr</span>;</span></span><br><span class="line">                s = evutil_inet_ntop(AF_INET, &amp;<span class="built_in">sin</span>-&gt;sin_addr, buf, <span class="number">128</span>);</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ( ai-&gt;ai_family == AF_INET6)</span><br><span class="line">            &#123;</span><br><span class="line">                struct sockaddr_in6 *sin6 = (struct sockaddr_in6 *)ai-&gt;ai_addr;</span><br><span class="line">                s = evutil_inet_ntop(AF_INET6, &amp;sin6-&gt;sin6_addr, buf, <span class="number">128</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(s)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">cout</span>&lt;&lt;<span class="string">"  -&gt;"</span>&lt;&lt;s&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        evutil_freeaddrinfo(addr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> *<span class="title">base</span> = <span class="title">event_base_new</span>();</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdns_base</span> *<span class="title">dnsbase</span> = <span class="title">evdns_base_new</span>(<span class="title">base</span>, 1);</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evutil_addrinfo</span> <span class="title">hints</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;hints, <span class="number">0</span>, <span class="keyword">sizeof</span>(hints));</span><br><span class="line">    hints.ai_family = AF_UNSPEC ; <span class="comment">//不指定.</span></span><br><span class="line">    hints.ai_flags = EVUTIL_AI_CANONNAME; <span class="comment">//返回规范名.</span></span><br><span class="line">    hints.ai_socktype = SOCK_STREAM; <span class="comment">//只需要SOCK_STREAM套接字类型</span></span><br><span class="line">    hints.ai_protocol = IPPROTO_TCP; <span class="comment">//只需要TCP协议的.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* nodename = <span class="string">"github.com"</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evdns_getaddrinfo_request</span> *<span class="title">req</span>;</span></span><br><span class="line">    req = evdns_getaddrinfo(dnsbase , nodename , <span class="literal">NULL</span> , &amp;hints , callback , <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    event_base_dispatch(base);</span><br><span class="line">    <span class="keyword">if</span> ( req != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">free</span>( req );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    evdns_base_free(dnsbase, <span class="number">0</span>);</span><br><span class="line">    event_base_free(base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Libevent-HTTP服务器"><a href="#Libevent-HTTP服务器" class="headerlink" title="Libevent HTTP服务器"></a>Libevent HTTP服务器</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/event.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/http.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/buffer.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">callback</span><span class="params">(struct evhttp_request *request, <span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">evhttp_uri</span> * <span class="title">uri</span> = <span class="title">evhttp_request_get_evhttp_uri</span>(<span class="title">request</span>);</span></span><br><span class="line">    <span class="keyword">char</span> url[<span class="number">8192</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    evhttp_uri_join(<span class="keyword">const_cast</span>&lt;struct evhttp_uri*&gt;(uri), url, <span class="number">8192</span>);</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"accept request url:"</span>&lt;&lt;url&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evbuffer</span> *<span class="title">evbuf</span> = <span class="title">evbuffer_new</span>();</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == evbuf)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"error! evbuffer_new"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    evbuffer_add_printf(evbuf, <span class="string">"%s"</span>, <span class="string">"hello libevent http"</span>);</span><br><span class="line">    evhttp_send_reply(request, HTTP_OK, <span class="string">"OK"</span>, evbuf);</span><br><span class="line">    evbuffer_free(evbuf);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> *<span class="title">base</span> = <span class="title">event_base_new</span>();</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">evhttp</span> *<span class="title">http</span> = <span class="title">evhttp_new</span>(<span class="title">base</span>);</span></span><br><span class="line">    evhttp_bind_socket(http, <span class="string">"0.0.0.0"</span>, <span class="number">9999</span>);</span><br><span class="line">    evhttp_set_gencb(http, callback, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    event_base_dispatch(base);</span><br><span class="line"></span><br><span class="line">    event_base_free(base);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><ol>
<li><a href="http://blog.csdn.net/majianfei1023/article/details/46485705" target="_blank" rel="noopener">libevent源码分析</a></li>
<li><a href="http://blog.csdn.net/column/details/libevent-src.html" target="_blank" rel="noopener">libevent专栏</a></li>
<li><a href="http://www.jianshu.com/p/906c8b9f0629" target="_blank" rel="noopener">libevent evhttp学习——http服务端</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="CaseZheng"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">CaseZheng</p>
  <div class="site-description" itemprop="description">CaseZheng的博客网站</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">130</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">36</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/CaseZheng" title="GitHub → https://github.com/CaseZheng" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:764307915@qq.com" title="E-Mail → mailto:764307915@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CaseZheng</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">717k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">10:52</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




  <script src="/js/local-search.js"></script>












  

  


</body>
</html>
